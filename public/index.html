<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMM - Congreso Centroamericano 2026 - Comparador de Ofertas de Vuelos - Copa Airlines (90 Combinaciones)</title>
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header-title {
            color: #0056b3;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 30px;
            padding: 0 15px;
        }
        .btn-primary {
            background-color: #0056b3;
            border-color: #0056b3;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 12px 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #007bff;
            border-color: #007bff;
            transform: translateY(-2px);
        }
        .btn-primary:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }
        .loading-progress {
            display: none;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
        }
        .progress {
            height: 1.5rem;
            background-color: #e9ecef;
            border-radius: 0.375rem;
        }
        .progress-bar {
            background-color: #0056b3 !important;
            transition: width 0.6s ease;
        }
        .error-alert {
            display: none;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
        }
        .cheapest-card {
            background-color: #d4edda !important;
            border-left: 5px solid #28a745 !important;
            margin: 15px auto;
            max-width: 700px;
        }
        .global-cheapest-card {
            background: white !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 12px !important;
            margin: 20px auto;
            max-width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0px;
            transition: box-shadow 0.3s ease;
        }
        .global-cheapest-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        .global-cheapest-card .global-title {
            color: #1976d2;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .global-cheapest-card .global-city {
            color: #333;
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .global-cheapest-card .global-dates {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 15px;
        }
        .global-cheapest-card .global-price {
            color: #1976d2;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .global-cheapest-card .pre-formatted {
            color: #333 !important;
            background: #f8f9fa !important;
            border: 1px solid #a3a3a3;
            border-radius: 8px;
            padding: 12px 15px;
            margin: 15px 0;
            font-size: 0.85rem;
            line-height: 1.4;
            max-width: 500px;
            display: inline-block;
            text-align: left;
            white-space: pre-line;
        }
        /* Bot√≥n llamativo de Copa */
        .btn-copa {
            background: linear-gradient(135deg, #1976d2, #0d47a1) !important;
            color: #fff !important;
            border: none !important;
            font-weight: 700;
            letter-spacing: 0.3px;
            box-shadow: 0 6px 14px rgba(25, 118, 210, 0.35);
            transition: transform 0.15s ease, box-shadow 0.2s ease, filter 0.2s ease;
            text-transform: uppercase;
        }
        .btn-copa:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 18px rgba(13, 71, 161, 0.45);
            filter: brightness(1.02);
        }
        .btn-copa:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(13, 71, 161, 0.4);
        }
        .btn-copa .bi {
            font-size: 1.1rem;
        }
        @media (max-width: 576px) {
            .btn-copa {
                width: 100%;
            }
        }
        [data-theme="dark"] .btn-copa {
            background: linear-gradient(135deg, #1e88e5, #1565c0) !important;
            box-shadow: 0 6px 14px rgba(30, 136, 229, 0.35);
        }
        .offer-image {
            max-width: 100%;
            width: 100%;
            max-height: 300px;
            margin: 10px auto;
            border: 1px solid #b1b1b1;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: block;
            object-fit: contain;
        }
        .offer-image:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .offer-image-container {
            border-radius: 12px;
            padding: 0px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);

            position: relative;
        }
        .offer-image-container h6 {
            color: #1976d2 !important;
            margin-bottom: 15px;
            font-weight: 600;
        }
        .copy-image-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 86, 179, 0.9);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .copy-image-btn:hover {
            background: rgba(0, 123, 255, 0.95);
            transform: translateY(-1px);
        }
        .copy-image-btn:active {
            transform: translateY(0);
        }
        .copy-image-btn.copied {
            background: rgba(40, 167, 69, 0.9);
        }
        .promo-code-banner {
            animation: pulse-glow 2s infinite;
        }
        .promo-code-banner .alert {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .promo-code-banner .alert::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 193, 7, 0.1), transparent);
            animation: shine 3s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        @keyframes shine {
            0% { transform: rotate(0deg) translate(-50%, -50%); }
            100% { transform: rotate(360deg) translate(-50%, -50%); }
        }
        .promo-code-banner:hover .alert {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
        }
        .global-offer-container {
            background: transparent;
            padding: 25px 0;
            margin: 20px 0;
            display: block !important;
        }
        .right-offer-column {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: flex-start;
            min-width: 500px;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 20px 20px 20px 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        .right-offer-column .price {
            font-size: 2.5rem;
            color: #0056b3;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .right-offer-column .class {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 12px;
        }
        .right-offer-column .select-btn {
            width: 100%;
            margin-bottom: 8px;
        }
        .right-offer-column .details-link {
            color: #1976d2;
            font-size: 1rem;
            text-decoration: underline;
            cursor: pointer;
            margin-bottom: 4px;
        }
        @media (max-width: 900px) {
            .right-offer-column {
                min-width: 180px;
                max-width: 100%;
                width: 100%;
                padding: 10px 5px;
            }
            .right-offer-column .price {
                font-size: 1.5rem;
            }
        }
        .pre-formatted {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.4;
        }
        
        /* Estilos para pesta√±as de fechas */
        .date-tabs {
            margin: 20px 0;
        }
        
        /* Estilos para tarjetas de estad√≠sticas */
        .summary-stats {
            background: #f8f9fa;
            padding: 30px 20px;
            border-radius: 20px;
            margin: 30px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #0056b3, #007bff);
            color: white;
            padding: 25px 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 86, 179, 0.3);
            transition: all 0.3s ease;
            margin-bottom: 20px;
            border: none;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 86, 179, 0.4);
        }
        
        .stat-card h5 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .stat-card p {
            font-size: 1.1rem;
            margin-bottom: 0;
            color: #f8f9fa;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        @media (max-width: 768px) {
            .summary-stats {
                padding: 20px 15px;
                margin: 20px 0;
            }
            
            .stat-card {
                padding: 20px 15px;
                margin-bottom: 15px;
            }
            
            .stat-card h5 {
                font-size: 2rem;
            }
            
            .stat-card p {
                font-size: 1rem;
            }
        }
        
        .date-tab {
            display: inline-block;
            padding: 10px 15px;
            margin: 5px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .date-tab.active {
            background: #0056b3;
            color: white;
            border-color: #0056b3;
        }
        
        .date-tab:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .date-tab.active:hover {
            background: #004494;
        }
        
        .date-content {
            display: none;
        }
        
        .date-content.active {
            display: block;
        }
        
        .city-group {
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            background: white;
        }
        
        .city-group h4 {
            color: #0056b3;
            margin-bottom: 15px;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 5px;
        }
        
        .stopover-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .stopover-card {
            flex: 1;
            min-width: 300px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .stopover-card.has-offer {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .stopover-card.has-error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        .summary-stats {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .stopover-group {
                flex-direction: column;
            }
            
            .stopover-card {
                min-width: 100%;
            }
            
            .date-tab {
                display: block;
                margin: 2px 0;
                text-align: center;
            }
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .btn-primary {
                font-size: 1rem;
                padding: 10px 15px;
            }
            .cheapest-card, .global-cheapest-card {
                font-size: 0.9em;
                margin: 0px 0px;
            }
            .offer-image {
                max-width: 100%;
            }
            .header-title {
                font-size: 1.5rem;
                margin-bottom: 20px;
            }
        }
        
        /* Estilos para las nuevas tarjetas de ofertas */
        .offer-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .offer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .offer-rank .badge {
            font-size: 1rem;
            padding: 8px 12px;
        }
        
        .date-info {
            font-size: 0.9rem;
        }
        
        .route-info {
            font-size: 0.85rem;
            overflow: visible;
            word-wrap: break-word;
            white-space: normal;
        }
        
        .route-info small {
            display: block;
            line-height: 1.3;
            white-space: normal;
            word-break: break-word;
        }
        
        .offer-card .card {
            min-height: 140px;
        }
        
        .offer-card .card-body {
            padding: 1rem;
        }
        
        .offer-card .row {
            align-items: flex-start !important;
        }
        
        .price-info h5 {
            font-weight: bold;
            font-size: 1.4rem;
        }
        
        /* Filtros responsivos para m√≥viles */
        .filter-container {
            position: sticky;
            top: 20px;
            z-index: 100;
            background: white;
            padding: 15px 0;
            border-bottom: 2px solid #f8f9fa;
            margin-bottom: 20px;
        }
        
        /* Mejora para desktop: evitar contenedor demasiado ancho */
        @media (min-width: 1025px) {
            .filter-container {
                max-width: 1400px;
                margin: 0 auto 20px auto;
                padding: 20px;
            }
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }
        
        .btn-group .btn {
            flex: none;
            min-width: 180px;
            max-width: 220px;
            min-height: 44px; /* M√≠nimo recomendado para t√°ctil */
            padding: 12px 16px;
            border-radius: 25px !important;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid #e3f2fd;
            background: white;
            color: #1976d2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-group .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border-color: #1976d2;
        }
        
        .btn-group .btn.active {
            background: linear-gradient(135deg, #1976d2, #0056b3);
            border-color: #0056b3;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.4);
        }
        
        .btn-group .btn i {
            margin-right: 6px;
        }
        
        /* Scroll horizontal en m√≥viles para filtros */
        @media (max-width: 768px) {
            .filter-container {
                position: sticky;
                top: 0;
                padding: 8px 0;
                margin: 0 -15px 15px -15px;
                padding-left: 10px;
                padding-right: 10px;
                overflow: hidden;
            }
            
            .btn-group {
                flex-wrap: nowrap;
                overflow-x: auto;
                overflow-y: hidden;
                padding: 12px 0;
                gap: 10px;
                justify-content: flex-start;
                scrollbar-width: none;
                -ms-overflow-style: none;
                padding-bottom: 16px; /* Espacio para evitar corte */
            }
            
            .btn-group::-webkit-scrollbar {
                display: none;
            }
            
            .btn-group .btn {
                flex: none;
                min-width: 120px;
                max-width: 140px;
                white-space: nowrap;
                font-size: 0.85rem;
                padding: 12px 14px;
                line-height: 1.3;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .btn-group .btn.all-combo {
                min-width: 90px;
                max-width: 110px;
                font-size: 0.8rem;
            }
            
            .btn-group .btn i {
                margin-right: 3px;
                font-size: 0.8em;
            }
        }
        
        /* Estilos adicionales para tablets */
        @media (min-width: 769px) and (max-width: 1024px) {
            .btn-group .btn {
                min-width: 160px;
                max-width: 200px;
                font-size: 0.85rem;
            }
        }
        
        /* Estilos espec√≠ficos para desktop */
        @media (min-width: 1025px) {
            .btn-group {
                max-width: 1200px;
                margin: 0 auto;
                justify-content: center;
            }
            
            .btn-group .btn {
                min-width: 160px;
                max-width: 180px;
                font-size: 0.85rem;
                margin: 4px;
            }
            
            .btn-group .btn.all-combo {
                min-width: 120px;
                max-width: 140px;
            }
        }
        
        .offers-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .offers-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .offers-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .offers-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .offers-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Animaciones para filtros */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Mejoras adicionales para tarjetas de ofertas en m√≥viles */
        @media (max-width: 576px) {
            .filter-container {
                margin: 0 -10px 15px -10px;
                padding-left: 5px;
                padding-right: 5px;
            }
            
            .btn-group {
                gap: 6px;
                padding: 6px 0 10px 0;
            }
            
            .btn-group .btn {
                min-width: 105px;
                max-width: 125px;
                font-size: 0.8rem;
                padding: 10px 12px;
            }
            
            .btn-group .btn.all-combo {
                min-width: 80px;
                max-width: 95px;
                font-size: 0.75rem;
            }
            
            .offer-card .card-body {
                padding: 12px;
            }
            
            .offer-card .row {
                --bs-gutter-x: 0.5rem;
            }
            
            .offer-rank .badge {
                font-size: 0.8rem;
                padding: 6px 8px;
            }
            
            .price-info h5 {
                font-size: 1.2rem;
            }
            
            .date-info {
                font-size: 0.8rem;
            }
            
            .route-info {
                font-size: 0.75rem;
                overflow: visible;
                white-space: normal;
            }
            
            .route-info small {
                white-space: normal;
                word-break: break-word;
                display: block;
            }
        }
        
        /* Indicador de scroll para filtros en m√≥viles */
        .filter-container::after {
            content: "";
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.9));
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .filter-container::after {
                opacity: 1;
            }
            
            .offer-card .card {
                min-height: 160px;
            }
        }
        
        /* Estilo para el contador de resultados */
        .results-counter {
            border-radius: 15px;
            border: none;
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            color: #1976d2;
            font-size: 0.9rem;
            padding: 10px 15px;
        }
        
        .results-counter i {
            margin-right: 8px;
        }
        
        /* Animaci√≥n pulse para indicador de scroll */
        @keyframes pulse {
            0% { transform: translateY(-50%) scale(1); opacity: 0.8; }
            50% { transform: translateY(-50%) scale(1.1); opacity: 1; }
            100% { transform: translateY(-50%) scale(1); opacity: 0.8; }
        }
        
        /* Men√∫ fijo superior */
        .fixed-menu {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15), 0 0 40px rgba(0,123,255,0.05);
            transition: all 0.3s ease;
            width: calc(100% - 30px);
            max-width: 1200px;
            border-radius: 0 0 15px 15px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .menu-buttons {
            display: flex;
            height: 65px;
            padding: 8px;
        }
        
        .menu-button {
            flex: 1;
            border: none;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0 4px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .menu-button.active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(0,123,255,0.4), 0 0 30px rgba(0,123,255,0.2);
            transform: translateY(-2px);
        }
        
        .menu-button:not(.active) {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .menu-button:not(.active):hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .menu-button.active:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
            box-shadow: 0 8px 25px rgba(0,123,255,0.5), 0 0 40px rgba(0,123,255,0.3);
        }
        
        /* Estado deshabilitado del men√∫ durante carga */
        .fixed-menu.disabled {
            opacity: 0.5;
            pointer-events: none;
            user-select: none;
        }
        
        .fixed-menu.disabled .menu-button {
            cursor: not-allowed;
            filter: grayscale(50%);
        }
        
        /* Variables CSS para modo oscuro */
        :root {
            --bg-color: #f8f9fa;
            --text-color: #333;
            --card-bg: white;
            --border-color: #e0e0e0;
            --hover-bg: #f1f3f4;
        }
        
        [data-theme="dark"] {
            --bg-color: #0d1117;
            --text-color: #f0f6fc;
            --card-bg: #21262d;
            --border-color: #30363d;
            --hover-bg: #30363d;
        }
        
        /* Aplicar variables a elementos */
        body {
            background: linear-gradient(135deg, var(--bg-color) 0%, var(--bg-color) 100%) !important;
            color: var(--text-color) !important;
            padding-top: 75px; /* Espacio para el men√∫ fijo m√°s alto */
        }
        
        [data-theme="dark"] body {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%) !important;
        }
        
        [data-theme="dark"] .fixed-menu {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            box-shadow: 0 4px 25px rgba(0,0,0,0.4), 0 0 50px rgba(58, 134, 255, 0.1);
            border: 1px solid #30363d;
        }
        
        [data-theme="dark"] .menu-button:not(.active) {
            background: linear-gradient(135deg, #21262d 0%, #30363d 100%);
            color: #f0f6fc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 1px solid #30363d;
        }
        
        [data-theme="dark"] .menu-button:not(.active):hover {
            background: linear-gradient(135deg, #30363d 0%, #484f58 100%);
            box-shadow: 0 4px 15px rgba(255,255,255,0.1);
            border: 1px solid #484f58;
        }
        
        [data-theme="dark"] .menu-button.active {
            background: linear-gradient(135deg, #238be6 0%, #1976d2 100%);
            color: #ffffff;
            box-shadow: 0 6px 25px rgba(35, 139, 230, 0.5), 0 0 40px rgba(35, 139, 230, 0.3);
            border: 1px solid #238be6;
        }
        
        [data-theme="dark"] .menu-button.active:hover {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            box-shadow: 0 8px 30px rgba(35, 139, 230, 0.6), 0 0 50px rgba(35, 139, 230, 0.4);
        }
        
        [data-theme="dark"] .global-cheapest-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, #30363d 100%) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        [data-theme="dark"] .card {
            background: linear-gradient(135deg, var(--card-bg) 0%, #30363d 100%) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        [data-theme="dark"] .btn:not(.btn-primary) {
            background: linear-gradient(135deg, var(--card-bg) 0%, #30363d 100%) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        
        [data-theme="dark"] .btn:not(.btn-primary):hover {
            background: linear-gradient(135deg, var(--hover-bg) 0%, #484f58 100%) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255,255,255,0.1);
        }
        
        [data-theme="dark"] .btn-primary {
            background: linear-gradient(135deg, #238be6 0%, #1976d2 100%) !important;
            border: 1px solid #238be6 !important;
            box-shadow: 0 3px 15px rgba(35, 139, 230, 0.3);
        }
        
        [data-theme="dark"] .btn-primary:hover {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%) !important;
            box-shadow: 0 5px 20px rgba(35, 139, 230, 0.4);
            transform: translateY(-1px);
        }
        
        /* Mejoras adicionales para modo oscuro */
        [data-theme="dark"] h1, 
        [data-theme="dark"] h2, 
        [data-theme="dark"] h3, 
        [data-theme="dark"] h4, 
        [data-theme="dark"] h5, 
        [data-theme="dark"] h6 {
            color: #f0f6fc !important;
        }
        
        [data-theme="dark"] .text-muted {
            color: #8b949e !important;
        }
        
        [data-theme="dark"] .text-center {
            color: #f0f6fc !important;
        }
        
        [data-theme="dark"] .card-title {
            color: #58a6ff !important;
        }
        
        [data-theme="dark"] .card-text {
            color: #f0f6fc !important;
        }
        
        /* Botones de filtro mejorados */
        [data-theme="dark"] .btn-outline-primary {
            background: linear-gradient(135deg, #21262d 0%, #30363d 100%) !important;
            border: 2px solid #238be6 !important;
            color: #58a6ff !important;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(35, 139, 230, 0.2);
        }
        
        [data-theme="dark"] .btn-outline-primary:hover,
        [data-theme="dark"] .btn-outline-primary:focus,
        [data-theme="dark"] .btn-outline-primary.active {
            background: linear-gradient(135deg, #238be6 0%, #1976d2 100%) !important;
            border-color: #238be6 !important;
            color: #ffffff !important;
            box-shadow: 0 4px 20px rgba(35, 139, 230, 0.4), 0 0 30px rgba(35, 139, 230, 0.2);
            transform: translateY(-1px);
        }
        
        /* Secci√≥n de filtros mejorada */
        [data-theme="dark"] .filter-section {
            background: linear-gradient(135deg, #161b22 0%, #21262d 100%) !important;
            border: 1px solid #30363d !important;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        [data-theme="dark"] .filter-section h5 {
            color: #58a6ff !important;
            font-weight: 700;
        }
        
        [data-theme="dark"] .filter-section p {
            color: #8b949e !important;
        }
        
        /* Textos espec√≠ficos que necesitan contraste */
        [data-theme="dark"] small {
            color: #8b949e !important;
        }
        
        [data-theme="dark"] .fw-bold {
            color: #f0f6fc !important;
        }
        
        [data-theme="dark"] .badge {
            background: linear-gradient(135deg, #238be6 0%, #1976d2 100%) !important;
            color: #ffffff !important;
        }
        
        /* Secci√≥n de estad√≠sticas mejorada */
        [data-theme="dark"] .stats-card {
            background: linear-gradient(135deg, #161b22 0%, #21262d 100%) !important;
            border: 1px solid #30363d !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
        }
        
        [data-theme="dark"] .stats-number {
            color: #58a6ff !important;
            font-weight: 800;
            text-shadow: 0 0 10px rgba(88, 166, 255, 0.3);
        }
        
        [data-theme="dark"] .stats-label {
            color: #8b949e !important;
            font-weight: 600;
        }
        
        /* T√≠tulos de ciudades */
        [data-theme="dark"] .destination-title {
            color: #58a6ff !important;
            font-weight: 700;
        }
        
        /* Lista de ofertas */
        [data-theme="dark"] .offer-item {
            background: linear-gradient(135deg, #21262d 0%, #30363d 100%) !important;
            border: 1px solid #30363d !important;
            border-radius: 10px;
            margin-bottom: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        [data-theme="dark"] .offer-item:hover {
            background: linear-gradient(135deg, #30363d 0%, #484f58 100%) !important;
            border-color: #484f58 !important;
            box-shadow: 0 4px 15px rgba(88, 166, 255, 0.1);
        }
        
        /* Precios destacados */
        [data-theme="dark"] .price-highlight {
            color: #58a6ff !important;
            font-weight: 800;
        }
        
        /* Separadores y l√≠neas */
        [data-theme="dark"] hr {
            border-color: #30363d !important;
        }
        
        /* Tooltips y elementos auxiliares */
        [data-theme="dark"] .tooltip-inner {
            background: #21262d !important;
            color: #f0f6fc !important;
            border: 1px solid #30363d;
        }
        
        /* Contenedor principal de filtros */
        [data-theme="dark"] .filter-container {
            background: linear-gradient(135deg, #161b22 0%, #21262d 100%) !important;
            border: 1px solid #30363d !important;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        /* Grupo de botones de filtro */
        [data-theme="dark"] .btn-group .btn {
            background: linear-gradient(135deg, #21262d 0%, #30363d 100%) !important;
            border: 1px solid #30363d !important;
            color: #8b949e !important;
            font-weight: 600;
            margin: 3px;
            border-radius: 8px !important;
            transition: all 0.3s ease;
        }
        
        [data-theme="dark"] .btn-group .btn:hover {
            background: linear-gradient(135deg, #30363d 0%, #484f58 100%) !important;
            border-color: #484f58 !important;
            color: #f0f6fc !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.1);
        }
        
        [data-theme="dark"] .btn-group .btn.active {
            background: linear-gradient(135deg, #238be6 0%, #1976d2 100%) !important;
            border-color: #238be6 !important;
            color: #ffffff !important;
            box-shadow: 0 4px 15px rgba(35, 139, 230, 0.3), 0 0 20px rgba(35, 139, 230, 0.2);
        }
        
        /* T√≠tulo principal mejorado */
        [data-theme="dark"] .header-title {
            color: #f0f6fc !important;
            text-shadow: 0 2px 10px rgba(88, 166, 255, 0.3);
        }
        
        [data-theme="dark"] .header-title i {
            color: #58a6ff !important;
        }
        
        /* Texto de progreso */
        [data-theme="dark"] #progress-text {
            color: #8b949e !important;
            font-weight: 500;
        }
        
        /* Barra de progreso */
        [data-theme="dark"] .progress {
            background: #21262d !important;
            border: 1px solid #30363d;
            border-radius: 10px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }
        
        [data-theme="dark"] .progress-bar {
            background: linear-gradient(135deg, #238be6 0%, #1976d2 100%) !important;
            box-shadow: 0 0 10px rgba(35, 139, 230, 0.5);
        }
        
        /* Oferta global mejorada */
        [data-theme="dark"] .global-title {
            color: #58a6ff !important;
            font-weight: 700;
            font-size: 1.3rem;
            text-shadow: 0 0 10px rgba(88, 166, 255, 0.3);
        }
        
        [data-theme="dark"] .global-city {
            color: #f0f6fc !important;
            font-weight: 700;
            font-size: 1.5rem;
            margin: 10px 0;
        }
        
        [data-theme="dark"] .global-dates {
            color: #8b949e !important;
            font-weight: 500;
            font-size: 1rem;
            margin: 5px 0;
            line-height: 1.4;
        }
        
        [data-theme="dark"] .global-price {
            color: #58a6ff !important;
            font-weight: 800;
            font-size: 2rem;
            margin: 15px 0;
            text-shadow: 0 0 15px rgba(88, 166, 255, 0.4);
        }
        
        /* Mensaje pre-formateado */
        [data-theme="dark"] .pre-formatted {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%) !important;
            border: 1px solid #30363d !important;
            color: #f0f6fc !important;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Bot√≥n de copiar mensaje */
        [data-theme="dark"] button[onclick*="copyMessage"] {
            background: linear-gradient(135deg, #238be6 0%, #1976d2 100%) !important;
            border: none;
            color: #ffffff !important;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(35, 139, 230, 0.3);
            transition: all 0.3s ease;
        }
        
        [data-theme="dark"] button[onclick*="copyMessage"]:hover {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%) !important;
            box-shadow: 0 6px 20px rgba(35, 139, 230, 0.4);
            transform: translateY(-2px);
        }
        
        /* Iconos en la oferta global */
        [data-theme="dark"] .global-title i {
            color: #ffa657 !important;
        }
        
        /* Secci√≥n de estad√≠sticas mejorada */
        [data-theme="dark"] #summary-stats {
            background: linear-gradient(135deg, #161b22 0%, #21262d 100%) !important;
            border: 1px solid #30363d !important;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 6px 25px rgba(0,0,0,0.4), 0 0 40px rgba(58, 134, 255, 0.05);
        }
        
        [data-theme="dark"] .stat-card {
            background: linear-gradient(135deg, #21262d 0%, #30363d 100%) !important;
            border: 1px solid #30363d !important;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        [data-theme="dark"] .stat-card:hover {
            background: linear-gradient(135deg, #30363d 0%, #484f58 100%) !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.15);
        }
        
        [data-theme="dark"] .stat-card h5 {
            color: #58a6ff !important;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
            text-shadow: 0 0 15px rgba(88, 166, 255, 0.4);
        }
        
        [data-theme="dark"] .stat-card p {
            color: #f0f6fc !important;
            font-weight: 600;
            margin: 8px 0 0 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Secci√≥n de estad√≠sticas mejorada */
        [data-theme="dark"] #summary-stats {
            background: linear-gradient(135deg, #161b22 0%, #21262d 100%) !important;
            border: 1px solid #30363d !important;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 6px 25px rgba(0,0,0,0.4), 0 0 40px rgba(58, 134, 255, 0.05);
        }
        
        [data-theme="dark"] .stat-card {
            background: linear-gradient(135deg, #21262d 0%, #30363d 100%) !important;
            border: 1px solid #30363d !important;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        [data-theme="dark"] .stat-card:hover {
            background: linear-gradient(135deg, #30363d 0%, #484f58 100%) !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.15);
        }
        
        [data-theme="dark"] .stat-card h5 {
            color: #58a6ff !important;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
            text-shadow: 0 0 15px rgba(88, 166, 255, 0.4);
        }
        
        [data-theme="dark"] .stat-card p {
            color: #f0f6fc !important;
            font-weight: 600;
            margin: 8px 0 0 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Media queries para dispositivos m√≥viles */
        @media (max-width: 480px) {
            .menu-button {
                font-size: 0.7rem !important;
                gap: 5px !important;
                padding: 8px 4px !important;
            }
            
            .menu-button i {
                font-size: 0.8rem !important;
            }
        }
        
        @media (max-width: 576px) {
            .menu-button {
                font-size: 0.75rem !important;
                gap: 6px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Men√∫ fijo superior -->
    <div class="fixed-menu">
        <div class="menu-buttons">
            <button class="menu-button active" id="normalMode">
                <i class="bi bi-sun"></i>
                VUELOS MULTICIUDAD / STOPOVER
            </button>
            <button class="menu-button" id="darkMode">
                <i class="bi bi-moon"></i>
                VUELOS DIRECTOS
            </button>
        </div>
    </div>
    
    <!-- Toast de confirmaci√≥n de copiado -->
    <div id="copy-toast" style="display:none;position:fixed;top:30px;left:50%;transform:translateX(-50%);background:#ffc107;color:#333;padding:12px 32px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15);z-index:9999;font-weight:bold;">
        Mensaje copiado al portapapeles
    </div>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-12 text-center">
                <h1 class="header-title">
                    <i class="bi bi-airplane-engines"></i> MMM - Congreso Centroamericano 2026 - Comparador de Ofertas de Vuelos - Copa Airlines<br>
                    <small class="text-muted" style="font-size: 0.6em;">90 Combinaciones de Fechas Disponibles</small>
                </h1>
            </div>
        </div>

            <!-- Progress Bar -->
            <div class="loading-progress" id="loading">
                <div class="progress" role="progressbar" aria-label="Progreso de b√∫squeda" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-primary" style="width: 0%;" id="progress-bar"></div>
                </div>
                <p class="mt-2 text-center" id="progress-text">Buscando las mejores ofertas para todas las combinaciones de fechas y destinos... Progreso: 0%</p>
            </div>
            <!-- Error Alert -->
            <div class="alert alert-danger error-alert" role="alert" id="error">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span id="error-message"></span>
            </div>
            <!-- Global Cheapest Offer -->
            <div class="row justify-content-center global-offer-container" id="global-cheapest-section">
                <div class="col-12">
                    <div class="card global-cheapest-card" id="global-cheapest-info" style="display: none;">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <!-- Columna izquierda: Informaci√≥n de la oferta -->
                                <div class="col-lg-8 col-md-12">
                                    <div class="text-center text-lg-start">
                                        <h5 class="global-title"><i class="bi bi-trophy"></i> Mejor Oferta Global</h5>
                                        <div class="global-city">[CIUDAD]</div>
                                        <div class="global-dates">[FECHAS]</div>
                                        <div class="global-price">$[PRECIO] USD</div>
                                    </div>
                                    
                                    <!-- Mensaje para copiar -->
                                    <div class="mt-3">
                                        <div class="pre-formatted" id="cheapest-message">üåç‚úàÔ∏è ¬°Atenci√≥n pastores y hermanos!
üî• Aprovechen esta s√∫per oferta üî•
üëâ Pasajes stopover en Panam√°: [ITINERARIO]
[STOPOVER_TYPE] | üíµ Todo a [PRECIO] USD
‚ú® ¬°No dejen pasar esta oportunidad! ‚ú®</div>
                                    </div>
                                    
                                    <!-- Bot√≥n -->
                                    <div class="text-center text-lg-start mt-3">
                                        <button class="btn btn-primary" onclick="copyCheapestMessage()">
                                            <i class="bi bi-clipboard"></i> Copiar mensaje
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Columna derecha: Imagen generada (se genera din√°micamente) -->
                                <div class="col-lg-4 col-md-12">
                                    <!-- Los contenedores de imagen se generan din√°micamente en displayGlobalCheapest -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Individual Cheapest Offers -->
            <div class="row justify-content-center" id="individual-offers-section">
                <div class="col-12">
                    <!-- Estad√≠sticas de resumen -->
                    <div class="summary-stats" id="summary-stats" style="display: none;">
                        <h5><i class="bi bi-graph-up"></i> Resumen de B√∫squeda</h5>
                        <div class="row">
                            <div class="col-md-3 col-6 text-center">
                                <div class="stat-item">
                                    <h6 class="text-success">Ofertas Encontradas</h6>
                                    <span class="badge bg-success" id="found-count">0</span>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 text-center">
                                <div class="stat-item">
                                    <h6 class="text-danger">Con Errores</h6>
                                    <span class="badge bg-danger" id="error-count">0</span>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 text-center">
                                <div class="stat-item">
                                    <h6 class="text-primary">Precio M√≠nimo</h6>
                                    <span class="badge bg-primary" id="min-price">-</span>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 text-center">
                                <div class="stat-item">
                                    <h6 class="text-secondary">Precio M√°ximo</h6>
                                    <span class="badge bg-secondary" id="max-price">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pesta√±as de fechas -->
                    <div class="date-tabs text-center" id="date-tabs" style="display: none;">
                        <!-- Las pesta√±as se generar√°n din√°micamente -->
                    </div>
                    
                    <!-- Contenido de fechas -->
                    <div id="date-contents">
                        <!-- El contenido se generar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Funci√≥n para mostrar informaci√≥n de reintento autom√°tico pendiente
        function displayPendingRetry(pendingRetry) {
            const autoRetryInfo = document.getElementById('auto-retry-info');
            const retryCountdown = document.getElementById('retry-countdown');
            
            if (pendingRetry && pendingRetry.minutesUntilRetry > 0) {
                retryCountdown.textContent = `${pendingRetry.minutesUntilRetry} minuto${pendingRetry.minutesUntilRetry > 1 ? 's' : ''}`;
                autoRetryInfo.style.display = 'block';
                
                console.log(`APIs pendientes de reintento: ${pendingRetry.failedApis.join(', ')} - ${pendingRetry.minutesUntilRetry} minutos restantes`);
            } else {
                autoRetryInfo.style.display = 'none';
            }
        }
        
        function copyCheapestMessage() {
            const msg = document.getElementById('cheapest-message');
            if (msg) {
                // Eliminar espacios extra y copiar solo el texto visible
                const text = msg.innerText.replace(/\n\s+/g, '\n').trim();
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showCopyToast();
                    })
                    .catch(() => {
                        showCopyToast('No se pudo copiar el mensaje', true);
                    });
            }
        }

        function showCopyToast(msg = 'Mensaje copiado al portapapeles', error = false) {
            const toast = document.getElementById('copy-toast');
            toast.textContent = msg;
            toast.style.background = error ? '#dc3545' : '#ffc107';
            toast.style.color = error ? '#fff' : '#333';
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 1800);
        }

        function showErrorToast(failedCities) {
            if (failedCities.length === 0) return;
            
            const toast = document.getElementById('copy-toast');
            toast.textContent = `B√∫squeda fall√≥ en: ${failedCities.join(', ')}`;
            toast.style.background = '#dc3545';
            toast.style.color = '#fff';
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });
        async function fetchOffers() {
            const loading = document.getElementById('loading');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const errorDiv = document.getElementById('error');
            const globalCheapestInfo = document.getElementById('global-cheapest-info');
            const summaryStats = document.getElementById('summary-stats');
            const dateTabs = document.getElementById('date-tabs');
            const dateContents = document.getElementById('date-contents');

            // Detectar modo actual (claro/oscuro)
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const isDarkMode = currentTheme === 'dark';
            
            console.log(`üåô Modo actual: ${isDarkMode ? 'OSCURO (Vuelos Directos)' : 'CLARO (Stopover)'}`); 
            
            // Funciones para manejar el men√∫ durante la carga
            function disableMenu() {
                const menu = document.querySelector('.fixed-menu');
                if (menu) {
                    menu.classList.add('disabled');
                    console.log('üö´ Men√∫ deshabilitado durante la carga');
                }
            }
            
            function enableMenu() {
                const menu = document.querySelector('.fixed-menu');
                if (menu) {
                    menu.classList.remove('disabled');
                    console.log('‚úÖ Men√∫ habilitado');
                }
            }
            
            // Deshabilitar men√∫ al iniciar la carga
            disableMenu();

            // Mostrar barra de progreso y ocultar elementos previos
            loading.style.display = 'block';
            progressBar.style.width = '10%';
            
            if (isDarkMode) {
                progressText.textContent = 'Iniciando b√∫squeda de vuelos directos (12 combinaciones)... Progreso: 10%';
            } else {
                progressText.textContent = 'Iniciando b√∫squeda de 90 combinaciones... Progreso: 10%';
            }
            
            if (errorDiv) errorDiv.style.display = 'none';
            
            if (globalCheapestInfo) globalCheapestInfo.style.display = 'none';
            if (summaryStats) summaryStats.style.display = 'none';
            if (dateTabs) dateTabs.style.display = 'none';
            
            // Limpiar contenido previo
            if (dateTabs) dateTabs.innerHTML = '';
            if (dateContents) dateContents.innerHTML = '';

            // Funci√≥n para actualizar progreso
            const updateProgress = (percentage) => {
                progressBar.style.width = `${percentage}%`;
            };

            try {
                if (isDarkMode) {
                    // Modo oscuro: llamar APIs de vuelos directos
                    await fetchDirectFlights(progressBar, progressText, updateProgress);
                } else {
                    // Modo normal: llamar API de stopover
                    await fetchStopoverFlights(progressBar, progressText, updateProgress);
                }
                
            } catch (error) {
                console.error('Error durante la b√∫squeda:', error);
                if (errorDiv) {
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error durante la b√∫squeda: ${error.message}`;
                    errorDiv.style.display = 'block';
                }
            } finally {
                // Rehabilitar bot√≥n
                // Habilitar men√∫ al terminar la carga
                enableMenu();
                
                // Mostrar mensaje de finalizaci√≥n
                console.log('‚úÖ B√∫squeda completada y men√∫ habilitado');
                
                // Ocultar barra de progreso
                if (loading) loading.style.display = 'none';
            }
        }

        // Funci√≥n para b√∫squeda de vuelos directos (modo oscuro)
        async function fetchDirectFlights(progressBar, progressText, updateProgress) {
            console.log('üåô Iniciando b√∫squeda de vuelos directos...');
            
            const BASE_URL = window.location.origin;
            
            // Iniciar progreso en 10% (inicio de b√∫squeda)
            let progress = 10;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `Iniciando b√∫squeda de vuelos directos... ${progress}%`;
            
            const updateProgressLocal = (newProgress) => {
                progress = newProgress;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `Consultando APIs de vuelos directos... ${Math.round(progress)}%`;
            };
            
            try {
                // Generar identificadores √∫nicos
                const transactionidentifier = 'direct-' + Date.now() + '-' + Math.random().toString(36).substring(2);
                const useridentifier = 'user-' + Date.now() + '-' + Math.random().toString(36).substring(2);
                
                // Llamar al endpoint de vuelos directos con POST
                const apiUrl = `${BASE_URL}/api/direct-offers`;
                
                updateProgressLocal(15);
                
                // Simular progreso incremental durante las llamadas a APIs
                const estimatedTime = 15000; // 15 segundos estimados para vuelos directos
                const startTime = Date.now();
                const progressInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const timeProgress = (elapsed / estimatedTime) * 75; // 75% del progreso total
                    const newProgress = Math.min(15 + timeProgress, 85); // M√°ximo 85% durante simulaci√≥n
                    updateProgressLocal(newProgress);
                    
                    if (newProgress >= 85) {
                        clearInterval(progressInterval);
                    }
                }, 300); // Actualizar cada 300ms
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transactionidentifier: transactionidentifier,
                        useridentifier: useridentifier
                    })
                });
                
                // Detener simulaci√≥n al recibir respuesta
                clearInterval(progressInterval);
                updateProgressLocal(90);
                progressText.textContent = 'Procesando vuelos directos... 90%';
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                updateProgressLocal(95);
                progressText.textContent = 'Finalizando b√∫squeda de vuelos directos... 95%';
                
                const data = await response.json();
                
                // Procesar datos de vuelos directos
                console.log('üõ´ Datos de vuelos directos recibidos:', data);
                console.log('üìã Estructura de data:', data);
                console.log('üìä Vuelos directos encontrados:', Object.keys(data).filter(key => key.startsWith('direct')).length);
                console.log('ÔøΩ Claves en data:', Object.keys(data));
                console.log('üèÜ Global cheapest:', data.globalCheapest);
                console.log('ÔøΩ Total de vuelos:', data.flights ? data.flights.length : 0);
                
                // Verificar si tenemos datos v√°lidos (estructura real de la API)
                const directFlightKeys = Object.keys(data).filter(key => key.startsWith('direct'));
                if (directFlightKeys.length === 0) {
                    throw new Error('No se encontraron vuelos directos en la respuesta');
                }
                
                // Mostrar resultado global m√°s barato desde data.globalCheapest
                const cheapestFlight = data.globalCheapest;
                
                if (cheapestFlight) {
                    console.log('üèÜ Vuelo directo m√°s barato encontrado:', cheapestFlight);
                    // Crear estructura compatible con displayGlobalCheapest
                    const globalCheapest = {
                        price: cheapestFlight.price,
                        segments: cheapestFlight.segments || [],
                        city: 'Panam√°',
                        stopover: 'directo',
                        searchDate: cheapestFlight.departureDate,
                        departureDate: cheapestFlight.departureDate,
                        returnDate: cheapestFlight.returnDate,
                        ida: cheapestFlight.ida || 'Lima - Panam√°',
                        vuelta: cheapestFlight.vuelta || 'Panam√° - Lima',
                        stopoverType: cheapestFlight.stopoverType || '‚úàÔ∏è Vuelo Directo Sin Escalas'
                    };
                    await displayGlobalCheapest(globalCheapest);
                } else {
                    console.log('‚ö†Ô∏è No se encontraron datos de vuelo directo global');
                }
                
                // Extraer y organizar los datos por combinaciones de fechas
                const dateCombo = organizeDirectDataByDates(data);
                console.log('üìè DateCombo generado:', dateCombo);
                
                // Generar estad√≠sticas de resumen para vuelos directos
                const stats = generateDirectSummaryStats(data);
                console.log('üìà Stats generadas:', stats);
                updateSummaryStats(stats);
                
                // Generar interfaz din√°mica para vuelos directos
                console.log('üé® Generando interfaz din√°mica...');
                generateDynamicInterface(dateCombo);
                
                updateProgressLocal(100);
                progressText.textContent = '¬°B√∫squeda de vuelos directos completada! 12 combinaciones procesadas - Progreso: 100%';
                
                // Forzar visibilidad de elementos finales (mostrar siempre)
                const globalCheapestElement = document.getElementById('global-cheapest-info');
                if (globalCheapestElement) {
                    globalCheapestElement.style.display = 'block';
                    globalCheapestElement.style.visibility = 'visible';
                    console.log('üëÄ Forzando visibilidad de global-cheapest-info');
                }
                
                const summaryStatsElement = document.getElementById('summary-stats');
                if (summaryStatsElement) {
                    summaryStatsElement.style.display = 'block';
                    summaryStatsElement.style.visibility = 'visible';
                    console.log('üëÄ Forzando visibilidad de summary-stats');
                }
                
                const dateTabsElement = document.getElementById('date-tabs');
                if (dateTabsElement) {
                    dateTabsElement.style.display = 'block';
                    dateTabsElement.style.visibility = 'visible';
                    console.log('üëÄ Forzando visibilidad de date-tabs');
                }
                
                // Agregar delay peque√±o para asegurar renderizado
                setTimeout(() => {
                    console.log('‚úÖ Renderizado completo de vuelos directos confirmado');
                }, 100);
                
                // Gestionar APIs fallidas si las hay
                if (data.failedApis && data.failedApis.length > 0) {
                    console.log(`Vuelos directos con error: ${data.failedApis.join(', ')}`);
                    const errorDiv = document.getElementById('error');
                    if (errorDiv) {
                        errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Fall√≥ la b√∫squeda de algunos vuelos directos - Reintento autom√°tico en 5 minutos`;
                        errorDiv.style.display = 'block';
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error en fetchDirectFlights:', error);
                throw error;
            }
        }

        // Funci√≥n para organizar datos de vuelos directos por fechas (similar a organizeDataByDates)
        function organizeDirectDataByDates(data) {
            console.log('üìä Organizando datos de vuelos directos por fechas');
            console.log('üìÇ Estructura de data recibida:', data);
            
            const dateCombo = {};
            
            // Procesar la estructura real de la API (claves direct01, direct02, etc.)
            const directFlights = Object.keys(data)
                .filter(key => key.startsWith('direct'))
                .map(key => ({ key, ...data[key] }));
            
            console.log(`üìã Vuelos directos encontrados: ${directFlights.length}`);
            
            // Agrupar por combinaci√≥n de fecha de salida + fecha de regreso
            directFlights.forEach(flight => {
                const dateKey = `${flight.departureDate}-to-${flight.returnDate}`;
                if (!dateCombo[dateKey]) {
                    dateCombo[dateKey] = {
                        searchDate: flight.departureDate || '2026-02-10',
                        returnDate: flight.returnDate || '2026-02-18', 
                        itineraries: []
                    };
                }
                
                if (flight.offers && flight.offers.length > 0) {
                    dateCombo[dateKey].itineraries.push({
                        city: 'Panam√°',
                        stopover: 'directo',
                        cheapest: flight.cheapest || {
                            price: 'N/A',
                            segments: []
                        }
                    });
                }
            });
            
            console.log('üìä Datos organizados por fechas:', dateCombo);
            return dateCombo;
        }

        // Funciones para verificar cache de Redis antes de llamar APIs
        async function checkRedisAndLoadDirectFlights() {
            console.log('üîç Verificando cache de Redis para vuelos directos...');
            
            try {
                // Hacer una llamada espec√≠fica para verificar cache sin ejecutar APIs
                const response = await fetch('/api/cache?type=direct', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Si hay datos v√°lidos en cache, usarlos
                    if (data.success && data.data && Object.keys(data.data).some(key => key.startsWith('direct'))) {
                        console.log('‚úÖ Datos encontrados en Redis, usando cache del servidor');
                        displayDirectFlightsData(data.data);
                        return;
                    }
                }
                
                console.log('‚ùå No hay datos v√°lidos en Redis, ejecutando b√∫squeda...');
                // Si no hay datos v√°lidos en Redis, ejecutar b√∫squeda normal
                setTimeout(() => {
                    console.log('üöÄ Ejecutando b√∫squeda autom√°tica de vuelos directos...');
                    fetchOffers();
                }, 500);
                
            } catch (error) {
                console.error('Error verificando cache de Redis:', error);
                // En caso de error, ejecutar b√∫squeda normal
                setTimeout(() => {
                    fetchOffers();
                }, 500);
            }
        }
        
        async function checkRedisAndLoadStopoverFlights() {
            console.log('üîç Verificando cache de Redis para stopover...');
            
            try {
                // Hacer una llamada espec√≠fica para verificar cache sin ejecutar APIs
                const response = await fetch('/api/cache?type=offers', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Si hay datos v√°lidos en cache, usarlos
                    if (data.success && data.data && (data.data.globalCheapest || Object.keys(data.data).some(key => key.startsWith('itinerary')))) {
                        console.log('‚úÖ Datos de stopover encontrados en Redis, usando cache del servidor');
                        
                        // Procesar datos igual que en fetchStopoverFlights
                        const dateCombo = organizeDataByDates(data.data);
                        const stats = generateSummaryStats(data.data);
                        
                        const stopoverData = { 
                            globalCheapest: data.data.globalCheapest, 
                            dateCombo: dateCombo,
                            stats: stats
                        };
                        displayStopoverData(stopoverData);
                        return;
                    }
                }
                
                console.log('‚ùå No hay datos v√°lidos en Redis, ejecutando b√∫squeda...');
                // Si no hay datos v√°lidos en Redis, ejecutar b√∫squeda normal
                setTimeout(() => {
                    console.log('üöÄ Ejecutando b√∫squeda autom√°tica de vuelos con stopover...');
                    fetchOffers();
                }, 500);
                
            } catch (error) {
                console.error('Error verificando cache de Redis:', error);
                // En caso de error, ejecutar b√∫squeda normal
                setTimeout(() => {
                    fetchOffers();
                }, 500);
            }
        }

        // Funciones auxiliares para mostrar datos desde cache
        function displayDirectFlightsData(data) {
            console.log('üìã Mostrando datos de vuelos directos desde cache');
            
            // Procesar y mostrar datos igual que en fetchDirectFlights
            const cheapestFlight = data.globalCheapest;
            if (cheapestFlight) {
                const globalCheapest = {
                    price: cheapestFlight.price,
                    segments: cheapestFlight.segments || [],
                    city: 'Panam√°',
                    stopover: 'directo',
                    searchDate: cheapestFlight.departureDate,
                    departureDate: cheapestFlight.departureDate,
                    returnDate: cheapestFlight.returnDate,
                    ida: cheapestFlight.ida || 'Lima - Panam√°',
                    vuelta: cheapestFlight.vuelta || 'Panam√° - Lima',
                    stopoverType: cheapestFlight.stopoverType || '‚úàÔ∏è Vuelo Directo Sin Escalas'
                };
                displayGlobalCheapest(globalCheapest);
            }
            
            const dateCombo = organizeDirectDataByDates(data);
            const stats = generateDirectSummaryStats(data);
            updateSummaryStats(stats);
            generateDynamicInterface(dateCombo);
            
            // Mostrar elementos
            const elements = ['global-cheapest-info', 'summary-stats', 'date-tabs'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'block';
                    element.style.visibility = 'visible';
                }
            });
        }
        
        function displayStopoverData(data) {
            console.log('üìã Mostrando datos de stopover desde cache');
            
            // Procesar y mostrar datos igual que en fetchStopoverFlights
            if (data.globalCheapest) {
                displayGlobalCheapest(data.globalCheapest);
            }
            
            if (data.dateCombo) {
                updateSummaryStats(data.stats || generateSummaryStats(data.dateCombo));
                generateDynamicInterface(data.dateCombo);
            }
            
            // Mostrar elementos
            const elements = ['global-cheapest-info', 'summary-stats', 'date-tabs'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'block';
                    element.style.visibility = 'visible';
                }
            });
        }

        // Funci√≥n para generar estad√≠sticas de vuelos directos
        function generateDirectSummaryStats(data) {
            console.log('üìä Generando estad√≠sticas de vuelos directos');
            console.log('üìÇ Data recibida:', data);
            
            // Procesar estructura real de la API (claves direct01, direct02, etc.)
            const flights = Object.keys(data)
                .filter(key => key.startsWith('direct'))
                .map(key => data[key]);
            
            console.log(`üìã Total de vuelos encontrados: ${flights.length}`);
            
            const stats = {
                total: 12, // 12 combinaciones de vuelos directos
                successful: flights.filter(f => f.offers && f.offers.length > 0).length,
                failed: flights.filter(f => !f.offers || f.offers.length === 0 || f.error).length,
                cheapestPrice: Infinity
            };
            
            // Encontrar el precio m√°s barato de los vuelos con ofertas
            const validPrices = flights
                .filter(f => f.cheapest && f.cheapest.price)
                .map(f => parseFloat(f.cheapest.price))
                .filter(price => !isNaN(price) && price > 0);
            
            if (validPrices.length > 0) {
                stats.cheapestPrice = Math.min(...validPrices);
            }
            
            console.log('üìà Estad√≠sticas generadas:', stats);
            return stats;
        }

        // Funci√≥n para b√∫squeda de stopover (modo normal)
        async function fetchStopoverFlights(progressBar, progressText, updateProgress) {
            console.log('‚òÄÔ∏è Iniciando b√∫squeda de stopover...');
            
            // Iniciar progreso en 10% (inicio de b√∫squeda)
            let progress = 10;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `Buscando 90 combinaciones de fechas y destinos... Progreso: ${progress}%`;
            
            const updateProgressLocal = (newProgress) => {
                progress = newProgress;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `Procesando 90 combinaciones de fechas... Progreso: ${Math.round(progress)}%`;
            };

            // Verificar si hay APIs fallidas previas para reintentar
            let apiUrl = '/api/offers';
            const failedApis = localStorage.getItem('failedApis');
            let estimatedTime = 25000; // 25 segundos para 90 combinaciones
            
            // Agregar timestamp para evitar cache del navegador
            const timestamp = new Date().getTime();
            const separator = apiUrl.includes('?') ? '&' : '?';
            apiUrl += `${separator}_t=${timestamp}`;
            
            if (failedApis) {
                const parsedFailed = JSON.parse(failedApis);
                if (parsedFailed.length > 0) {
                    apiUrl += `&retry=${parsedFailed.join(',')}`;
                    console.log(`Reintentando b√∫squeda en ciudades: ${parsedFailed.join(', ')}`);
                    progressText.textContent = `Reintentando b√∫squeda en ciudades pendientes... Progreso: ${progress}%`;
                    estimatedTime = parsedFailed.length * 1800; // 1.8 segundos por API fallida
                }
            }
            
            // Simular progreso incremental durante las llamadas a APIs
            const startTime = Date.now();
            const progressInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const timeProgress = (elapsed / estimatedTime) * 85; // 85% del progreso total
                const newProgress = Math.min(10 + timeProgress, 90); // M√°ximo 90% durante simulaci√≥n
                updateProgressLocal(newProgress);
                
                if (newProgress >= 90) {
                    clearInterval(progressInterval);
                }
            }, 250); // Actualizar cada 250ms

            let data;
            const response = await fetch(apiUrl);
            clearInterval(progressInterval); // Detener simulaci√≥n al recibir respuesta
            updateProgressLocal(95); // 95% al recibir respuesta
            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
            data = await response.json();
            updateProgressLocal(98); // 98% al procesar respuesta

            if (data.error) {
                throw new Error(data.error);
            }
            
            // Gestionar ciudades con b√∫squeda fallida
            if (data.failedApis && data.failedApis.length > 0) {
                console.log(`Ciudades con b√∫squeda fallida: ${data.failedApis.join(', ')}`);
                
                // Mostrar error espec√≠fico cuando fallen algunas ciudades
                const errorDiv = document.getElementById('error');
                if (errorDiv) {
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Fall√≥ la b√∫squeda con algunas combinaciones - Reintento autom√°tico en 5 minutos`;
                    errorDiv.style.display = 'block';
                }
            } else if (data.pendingRetry) {
                // Mostrar informaci√≥n de reintento pendiente
                displayPendingRetry(data.pendingRetry);
            }

            // Progreso completado (100%)
            updateProgressLocal(100);
            progressText.textContent = `¬°B√∫squeda completada! 90 combinaciones procesadas - Progreso: 100%`;

            // Procesar los 90 itinerarios din√°micamente
            console.log('\nüéØ INICIANDO PROCESAMIENTO DE ITINERARIOS');
            console.log('üìä Total de claves en data:', Object.keys(data).length);
            console.log('üõ´ Itinerarios encontrados:', Object.keys(data).filter(k => k.startsWith('itinerary')).length);
            console.log('üìã Estructura completa de data:', data);
            
            // Log de ejemplo de un itinerario para ver estructura
            const firstItinerary = Object.keys(data).find(k => k.startsWith('itinerary'));
            if (firstItinerary) {
                console.log(`üì¶ EJEMPLO DE ESTRUCTURA - ${firstItinerary}:`, data[firstItinerary]);
                if (data[firstItinerary].cheapest && data[firstItinerary].cheapest.segments) {
                    console.log('üõ´ Segmentos del primer itinerario:', data[firstItinerary].cheapest.segments);
                }
            }
            
            // Extraer y organizar los datos por combinaciones de fechas
            const dateCombo = organizeDataByDates(data);
            
            // Generar estad√≠sticas de resumen
            const stats = generateSummaryStats(data);
            updateSummaryStats(stats);
            
            // Mostrar oferta m√°s barata global
            if (data.globalCheapest) {
                console.log('üèÜ Datos de oferta global encontrados:', data.globalCheapest);
                await displayGlobalCheapest(data.globalCheapest);
            } else {
                console.log('‚ö†Ô∏è No se encontraron datos de oferta global');
            }
            
            // Generar interfaz din√°mica
            generateDynamicInterface(dateCombo);
            
            // Mostrar elementos finales (solo si existen)
            const summaryStatsElement = document.getElementById('summary-stats');
            if (summaryStatsElement) {
                summaryStatsElement.style.display = 'block';
            }
            
            const dateTabsElement = document.getElementById('date-tabs');
            if (dateTabsElement) {
                dateTabsElement.style.display = 'block';
            }

            // Recopilar errores de ciudades para mostrar en toast
            const failedCities = [];
            Object.keys(data).filter(k => k.startsWith('itinerary')).forEach(key => {
                const itinerary = data[key];
                if (itinerary.error) {
                    failedCities.push(`${itinerary.city || 'Ciudad'} (${itinerary.stopover || 'stopover'})`);
                }
            });
            
            // Mostrar toast con ciudades fallidas si las hay
            if (failedCities.length > 0) {
                showErrorToast(failedCities);
            }
            
        }

        // Funci√≥n para copiar imagen al clipboard
        async function copyImageToClipboard(mode = 'light') {
            try {
                const imgId = mode === 'dark' ? 'offer-image-dark' : 'offer-image-light';
                const img = document.getElementById(imgId);
                if (!img || !img.src) {
                    throw new Error('No hay imagen para copiar');
                }

                // Crear un canvas para convertir la imagen
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Crear una nueva imagen para asegurar que est√© cargada
                const imageElement = new Image();
                imageElement.crossOrigin = 'anonymous';
                
                return new Promise((resolve, reject) => {
                    imageElement.onload = async function() {
                        try {
                            // Configurar el canvas con las dimensiones de la imagen
                            canvas.width = imageElement.naturalWidth;
                            canvas.height = imageElement.naturalHeight;
                            
                            // Dibujar la imagen en el canvas
                            ctx.drawImage(imageElement, 0, 0);
                            
                            // Convertir canvas a blob
                            canvas.toBlob(async (blob) => {
                                try {
                                    // Copiar al clipboard usando la Clipboard API
                                    await navigator.clipboard.write([
                                        new ClipboardItem({ 'image/png': blob })
                                    ]);
                                    
                                    // Mostrar feedback visual
                                    showCopyFeedback();
                                    resolve();
                                } catch (clipboardError) {
                                    console.error('Error copiando al clipboard:', clipboardError);
                                    reject(clipboardError);
                                }
                            }, 'image/png');
                        } catch (canvasError) {
                            console.error('Error procesando imagen:', canvasError);
                            reject(canvasError);
                        }
                    };
                    
                    imageElement.onerror = function() {
                        reject(new Error('Error cargando la imagen'));
                    };
                    
                    // Cargar la imagen
                    imageElement.src = img.src;
                });
                
            } catch (error) {
                console.error('Error copiando imagen:', error);
                showCopyError();
            }
        }

        // Funci√≥n para mostrar feedback de copia exitosa
        function showCopyFeedback() {
            const copyBtns = document.querySelectorAll('.copy-image-btn');
            copyBtns.forEach(btn => {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> ¬°Copiado!';
                btn.classList.add('copied');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // Funci√≥n para mostrar error de copia
        function showCopyError() {
            const copyBtns = document.querySelectorAll('.copy-image-btn');
            copyBtns.forEach(btn => {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-exclamation-circle"></i> Error';
                btn.style.background = 'rgba(220, 53, 69, 0.9)';
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = '';
                }, 2000);
            });
        }

        // Funci√≥n para generar la imagen basada en el dise√±o proporcionado
        async function generateOfferImage(data) {
            console.log('Debug generateOfferImage - datos recibidos:', data);
            console.log('Debug generateOfferImage - segments:', data.segments);
            
            // Funci√≥n para parsear fecha localmente (evita desfase por zona horaria)
            function parseLocalDate(dateStr) {
                const [year, month, day] = dateStr.split('-').map(Number);
                return new Date(year, month - 1, day);
            }
            
            // Funci√≥n para convertir hora 24h a formato AM/PM
            function formatTimeAMPM(time24) {
                if (!time24 || typeof time24 !== 'string') return time24;
                const match = time24.match(/^(\d{1,2}):(\d{2})/);
                if (!match) return time24;
                const hour = parseInt(match[1], 10);
                const minutes = match[2];
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                return `${hour12}:${minutes} ${ampm}`;
            }

            // Convierte fecha (YYYY-MM-DD) y hora (HH:MM) a Date local
            function toLocalDateTime(dateStr, timeStr) {
                if (!dateStr || !timeStr) return null;
                const [y, m, d] = dateStr.split('-').map(Number);
                const [hh, mm] = timeStr.split(':').map(Number);
                return new Date(y, m - 1, d, hh, mm, 0, 0);
            }

            // Calcula minutos de escala entre llegada (fecha/hora) y salida (fecha/hora)
            function calcLayoverMinutes(arriveDate, arriveTime, departDate, departTime) {
                const a = toLocalDateTime(arriveDate, arriveTime);
                const b = toLocalDateTime(departDate, departTime);
                if (!a || !b) return null;
                const diffMs = b - a;
                if (isNaN(diffMs)) return null;
                // Si por alguna raz√≥n llega negativo (datos raros), no mostramos
                if (diffMs < 0) return null;
                return Math.round(diffMs / 60000);
            }

            // Formatea minutos a "Hh Mm" (ej: 5h 14m) o solo "Xm" si < 60
            function formatLayover(minutes) {
                if (minutes == null) return '';
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                if (h > 0 && m > 0) return `${h}h ${m}m`;
                if (h > 0) return `${h}h`;
                return `${m}m`;
            }
            
            // Canvas inicial con altura temporal
            const canvas = document.createElement('canvas');
            canvas.width = 900;
            canvas.height = 800; // Altura temporal, se ajustar√° al final
            const ctx = canvas.getContext('2d');

            // Fondo y borde
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);

            // Tarifa restrictiva
            ctx.save();
            ctx.shadowColor = '#a85c1c';
            ctx.shadowBlur = 8;
            ctx.fillStyle = '#a85c1c';
            ctx.font = 'bold 16px Arial';
            ctx.beginPath();
            ctx.roundRect(650, 18, 180, 32, 12);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.restore();
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 15px Arial';
            ctx.fillText('Tarifa restrictiva', 670, 40);
            ctx.fillStyle = '#a85c1c';
            ctx.font = 'bold 22px Arial';
            ctx.fillText('üîí', 800, 40);

            // Agrupar segmentos con escala en PTY
            // Agrupar solo los tramos de regreso si el segundo tramo tiene escala en PTY
            let groupedSegments = [];
            if (data.segments && Array.isArray(data.segments)) {
                let i = 0;
                while (i < data.segments.length) {
                    const seg = data.segments[i];
                    // Si el campo stops contiene "1 escala" y el siguiente segmento existe y es la continuaci√≥n
                    if (
                        seg.stops && seg.stops.toLowerCase().includes('1 escala') &&
                        i < data.segments.length - 1 &&
                        seg.to === 'PTY' && data.segments[i + 1].from === 'PTY'
                    ) {
                        // Agrupar ambos como un solo vuelo, eliminando PTY como origen y destino
                        const nextSeg = data.segments[i + 1];
                        // Fusionar CLO - PTY y PTY - LIM como CLO - LIM
                        let fromCity = seg.from;
                        let toCity = nextSeg.to;
                        // Si el primer segmento termina en PTY y el segundo empieza en PTY, fusionar origen y destino reales
                        if (seg.to === 'PTY' && nextSeg.from === 'PTY') {
                            fromCity = seg.from;
                            toCity = nextSeg.to;
                        }
                        // Calcular duraci√≥n de la escala en PTY (entre llegada del primer tramo y salida del segundo)
                        const layoverMin = calcLayoverMinutes(
                            // llegada a PTY
                            seg.date,
                            seg.arrival,
                            // salida desde PTY
                            nextSeg.date,
                            nextSeg.departure
                        );
                        const layoverText = formatLayover(layoverMin);

                        groupedSegments.push({
                            date: nextSeg.date,
                            from: fromCity,
                            departure: seg.departure,
                            to: toCity,
                            arrival: nextSeg.arrival,
                            class: nextSeg.class,
                            direct: false,
                            stops: seg.stops,
                            layoverAt: 'PTY',
                            layoverText
                        });
                        i += 2;
                    } else {
                        // Mostrar segmento individual
                        groupedSegments.push(seg);
                        i++;
                    }
                }
            }

            // Segmentos de vuelo visuales
            let y = 70;
            if (groupedSegments.length > 0) {
                groupedSegments.forEach((seg, idx) => {
                    // Formatear fecha en formato largo (local)
                    let fecha = parseLocalDate(seg.date);
                    let fechaStr = fecha.toLocaleDateString('es-ES', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                    if (!seg.direct && seg.stops && seg.stops.toLowerCase().includes('1 escala')) {
                        // VUELO AGRUPADO VISUAL ESPECIAL
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 15px Arial';
                        ctx.fillText(fechaStr, 40, y);
                        // Icono avi√≥n y texto escala (mismo estilo para el tiempo)
                        ctx.font = '16px Arial';
                        ctx.fillStyle = '#888';
                        const escalaBase = `‚úà Escala en ${seg.layoverAt || 'PTY'}`;
                        const baseX = 180;
                        ctx.fillText(escalaBase, baseX, y);
                        // Duraci√≥n escala: preferimos la calculada; si no, extraemos de stops
                        let escalaDur = seg.layoverText;
                        if (!escalaDur && seg.stops) {
                            const match = seg.stops.match(/\(([^)]+)\)/);
                            if (match) escalaDur = match[1];
                        }
                        if (escalaDur) {
                            const baseWidth = ctx.measureText(escalaBase).width;
                            ctx.fillText(` (${escalaDur})`, baseX + baseWidth, y);
                        }
                        y += 28;
                        // Ruta y horas
                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = '#222';
                        ctx.fillText(seg.from, 40, y);
                        ctx.font = 'bold 18px Arial';
                        ctx.fillText(formatTimeAMPM(seg.departure), 120, y);
                        ctx.font = 'bold 28px Arial';
                        ctx.fillStyle = '#bbb';
                        ctx.fillText('‚Üí', 200, y);
                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = '#222';
                        ctx.fillText(seg.to, 240, y);
                        ctx.font = 'bold 18px Arial';
                        ctx.fillText(formatTimeAMPM(seg.arrival), 320, y);
                        // Clase en azul
                        ctx.font = '15px Arial';
                        ctx.fillStyle = '#1976d2';
                        ctx.fillText(seg.class || 'Econ√≥mica Basic', 40, y + 22);
                        y += 58; // M√°s espacio antes del separador
                        // Separador visual con mejor espaciado
                        ctx.strokeStyle = '#d0d0d0';
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(40, y - 20);
                        ctx.lineTo(520, y - 20);
                        ctx.stroke();
                        y += 10; // Espacio despu√©s del separador
                    } else {
                        // VUELO NORMAL
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 16px Arial';
                        ctx.fillText(fechaStr, 40, y);
                        ctx.font = 'italic 14px Arial';
                        ctx.fillStyle = seg.direct ? '#28a745' : '#ff9800';
                        ctx.fillText(seg.direct ? 'Sin escalas' : seg.stops, 320, y);
                        y += 26;
                        // Ruta y horas
                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = '#222';
                        ctx.fillText(seg.from, 40, y);
                        ctx.font = 'bold 18px Arial';
                        ctx.fillText(formatTimeAMPM(seg.departure), 120, y);
                        ctx.font = 'bold 24px Arial';
                        ctx.fillStyle = '#0056b3';
                        ctx.fillText('‚Üí', 200, y);
                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = '#222';
                        ctx.fillText(seg.to, 240, y);
                        ctx.font = 'bold 18px Arial';
                        ctx.fillText(formatTimeAMPM(seg.arrival), 320, y);
                        // Clase solamente
                        ctx.font = '14px Arial';
                        ctx.fillStyle = '#0056b3';
                        ctx.fillText(seg.class || 'Econ√≥mica Basic', 40, y + 20);
                        y += 52; // M√°s espacio antes del separador
                        // Separador visual con mejor espaciado
                        ctx.strokeStyle = '#d0d0d0';
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(40, y - 20);
                        ctx.lineTo(520, y - 20);
                        ctx.stroke();
                        y += 10; // Espacio despu√©s del separador
                    }
                });
            }

            // Precio destacado y bot√≥n estilo Google Flights
            ctx.textAlign = 'left';
            ctx.fillStyle = '#333';
            ctx.font = 'bold 20px Arial';
            ctx.fillText('Precio por adulto', 600, 120);
            ctx.font = 'bold 40px Arial';
            ctx.fillStyle = '#1976d2';
            ctx.fillText(`${data.price} USD`, 600, 170);
            ctx.font = '20px Arial';
            ctx.fillStyle = '#666';
            ctx.fillText('Clase Econ√≥mica', 600, 200);

            // Ver detalles (en azul, subrayado)
            ctx.font = '18px Arial';
            ctx.fillStyle = '#1976d2';
            ctx.fillText('Ver detalles', 600, 235);

            // Calcular altura real necesaria basada en el contenido dibujado
            let contentHeight = Math.max(y, 255); // y de los vuelos vs posici√≥n fija del precio
            contentHeight += 30; // Padding inferior
            
            // Crear canvas final con altura optimizada
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = canvas.width;
            finalCanvas.height = contentHeight;
            const finalCtx = finalCanvas.getContext('2d');
            
            // Copiar contenido al canvas final (recortado)
            finalCtx.drawImage(canvas, 0, 0, canvas.width, contentHeight, 0, 0, finalCanvas.width, finalCanvas.height);

            // Convertir a imagen el canvas optimizado
            return finalCanvas.toDataURL('image/png');
        }

        // Funci√≥n para organizar datos por combinaciones de fechas
        function organizeDataByDates(data) {
            console.log('\nüìÖ ORGANIZANDO DATOS POR FECHAS');
            const dateCombo = {};
            
            const itineraryKeys = Object.keys(data).filter(k => k.startsWith('itinerary'));
            console.log(`üìä Procesando ${itineraryKeys.length} itinerarios...`);
            
            itineraryKeys.forEach((key, index) => {
                const itinerary = data[key];
                console.log(`\nüì¶ Procesando ${key} (${index + 1}/${itineraryKeys.length})`);
                console.log('üìã Itinerary data:', itinerary);
                
                if (itinerary && itinerary.dateComboId) {
                    const comboId = itinerary.dateComboId;
                    console.log(`üîó ComboId: ${comboId}`);
                    
                    if (!dateCombo[comboId]) {
                        dateCombo[comboId] = {
                            searchDate: itinerary.searchDate,
                            returnDate: itinerary.returnDate,
                            itineraries: []
                        };
                        console.log(`‚ú® Creado nuevo combo: ${comboId}`);
                    }
                    
                    dateCombo[comboId].itineraries.push(itinerary);
                    console.log(`‚ûï Agregado a combo ${comboId} (total: ${dateCombo[comboId].itineraries.length})`);
                    
                    // Log de segments si est√°n disponibles
                    if (itinerary.cheapest && itinerary.cheapest.segments) {
                        console.log(`üõ´ Segmentos disponibles para ${key}:`, itinerary.cheapest.segments);
                    } else {
                        console.warn(`‚ö†Ô∏è No hay segments para ${key}`);
                    }
                } else {
                    console.warn(`‚ö†Ô∏è ${key} no tiene dateComboId v√°lido:`, itinerary);
                }
            });
            
            console.log('\nüìä RESUMEN DE ORGANIZACI√ìN:');
            Object.keys(dateCombo).forEach(comboId => {
                console.log(`   ${comboId}: ${dateCombo[comboId].itineraries.length} itinerarios`);
            });
            
            return dateCombo;
        }

        // Funci√≥n para generar estad√≠sticas de resumen
        function generateSummaryStats(data) {
            const stats = {
                total: 0,
                successful: 0,
                failed: 0,
                cheapestPrice: Infinity,
                avgPrice: 0,
                cities: new Set(),
                combinations: new Set()
            };
            
            let totalPrice = 0;
            
            Object.keys(data).filter(k => k.startsWith('itinerary')).forEach(key => {
                const itinerary = data[key];
                stats.total++;
                
                if (itinerary.error) {
                    stats.failed++;
                } else if (itinerary.cheapest) {
                    stats.successful++;
                    stats.cities.add(itinerary.city);
                    stats.combinations.add(itinerary.dateComboId);
                    
                    const price = parseFloat(itinerary.cheapest.price);
                    if (price < stats.cheapestPrice) {
                        stats.cheapestPrice = price;
                    }
                    totalPrice += price;
                }
            });
            
            if (stats.successful > 0) {
                stats.avgPrice = totalPrice / stats.successful;
            }
            
            return stats;
        }

        // Funci√≥n para actualizar estad√≠sticas en la UI
        function updateSummaryStats(stats) {
            const summaryStats = document.getElementById('summary-stats');
            summaryStats.innerHTML = `
                <div class="row g-4">
                    <div class="col-md-4 col-sm-6">
                        <div class="stat-card">
                            <h5>${stats.total}</h5>
                            <p>B√∫squedas Total</p>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <div class="stat-card">
                            <h5>${stats.successful}</h5>
                            <p>Exitosas</p>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-12">
                        <div class="stat-card">
                            <h5>$${stats.cheapestPrice !== Infinity ? stats.cheapestPrice.toFixed(2) : 'N/A'}</h5>
                            <p>Precio M√°s Bajo</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Funci√≥n global para obtener el c√≥digo del aeropuerto
        function getAirportCode(city) {
            const airportCodes = {
                'Quito': 'UIO',
                'Medell√≠n': 'MDE',
                'Cali': 'CLO',
                'Cartagena': 'CTG',
                'Bogot√°': 'BOG',
                'Panam√°': 'PTY',
                'Panam√° (Directo)': 'PTY'
            };
            return airportCodes[city] || city;
        }

        // Funci√≥n para mostrar la oferta m√°s barata global
        async function displayGlobalCheapest(cheapest) {
            console.log('üèÜ Mostrando oferta global m√°s barata:', cheapest);
            
            // Detectar el modo actual basado en el tema
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const isDarkMode = currentTheme === 'dark';
            
            const globalCheapestSection = document.getElementById('global-cheapest-section');
            const globalCheapestInfo = document.getElementById('global-cheapest-info');
            
            if (!globalCheapestSection || !globalCheapestInfo) {
                console.error('‚ùå No se encontraron los elementos de la secci√≥n global');
                return;
            }
            
            // Determinar el texto del stopover o vuelo directo
            let stopoverText;
            let flightTypeEmoji;
            
            if (cheapest.stopover === 'directo') {
                stopoverText = '‚úàÔ∏è Vuelo Directo Sin Escalas';
                flightTypeEmoji = '‚úàÔ∏è';
            } else {
                stopoverText = cheapest.stopover === 'ida' ? 'Stopover de Ida en Panam√°' : 'Stopover de Regreso en Panam√°';
                flightTypeEmoji = 'üîÑ';
            }
            
            globalCheapestInfo.innerHTML = `
                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- Columna izquierda: Informaci√≥n de la oferta -->
                        <div class="col-lg-4 col-md-12">
                            <div class="text-center text-lg-start">
                                <h5 class="global-title"><i class="bi bi-trophy"></i> Mejor Oferta Global</h5>
                                <div class="global-city">${cheapest.city} (${getAirportCode(cheapest.city)})</div>
                                <div class="global-dates">Salida: ${formatDateDMY(cheapest.searchDate)} | Regreso: ${formatDateDMY(cheapest.returnDate)}</div>
                                <div class="global-dates">${stopoverText}</div>
                                <div class="global-price">$${cheapest.price} USD</div>
                                <!-- CTA principal de reserva, ahora bajo el precio -->
                                <div class="mt-2 d-grid d-lg-block">
                                    ${cheapest.stopover === 'directo' 
                                        ? `<a class="btn btn-copa btn-lg" href="${buildCopaDirectUrl(cheapest)}" target="_blank" rel="noopener noreferrer">
                                                <i class=\"bi bi-bag-check-fill me-1\"></i> Reservar en Copa
                                           </a>`
                                        : `<a class=\"btn btn-copa btn-lg\" href=\"${buildCopaStopoverSummaryUrl(cheapest)}\" target=\"_blank\" rel=\"noopener noreferrer\">
                                                <i class=\\"bi bi-bag-check-fill me-1\\"></i> Reservar en Copa
                                           </a>`}
                                </div>
                            </div>
                            <!-- Mensaje para copiar -->
                            <div class="mt-3">
                                <div class="pre-formatted" id="cheapest-message">üéâ OFERTA ESPECIAL - Congreso Centroamericano 2026! üéâ
‚úàÔ∏è Ciudad: ${cheapest.city} | üìÖ ${formatDateDMY(cheapest.searchDate)} - ${formatDateDMY(cheapest.returnDate)}
${flightTypeEmoji} ${stopoverText} | üíµ $${cheapest.price} USD
‚ú® ¬°No dejen pasar esta oportunidad! ‚ú®

üõ´ Ruta: 
${generateRouteForMessage(cheapest.city, stopoverText, cheapest.searchDate, cheapest.returnDate)}</div>
                            </div>
                            
                            <!-- Bot√≥n para copiar -->
                            <div class="text-center text-lg-start mt-3">
                                <button class="btn btn-outline-secondary" onclick="copyCheapestMessage()">
                                    <i class="bi bi-clipboard"></i> Copiar mensaje
                                </button>
                            </div>
                        </div>
                        
                        <!-- Columna derecha: Imagen generada -->
                        <div class="col-lg-8 col-md-12">
                            <!-- Contenedor para modo claro -->
                            <div class="mt-4 mt-lg-0 offer-image-container" id="offer-image-container-light" style="display: none;">
                                <button class="copy-image-btn" id="copy-image-btn-light" onclick="copyImageToClipboard('light')" style="display: none;">
                                    <i class="bi bi-clipboard"></i> Copiar
                                </button>
                                <img src="" alt="Oferta Visual" class="offer-image" id="offer-image-light">
                            </div>
                            <!-- Contenedor para modo oscuro -->
                            <div class="mt-4 mt-lg-0 offer-image-container" id="offer-image-container-dark" style="display: none;">
                                <button class="copy-image-btn" id="copy-image-btn-dark" onclick="copyImageToClipboard('dark')" style="display: none;">
                                    <i class="bi bi-clipboard"></i> Copiar
                                </button>
                                <img src="" alt="Oferta Visual" class="offer-image" id="offer-image-dark">
                                <div class="promo-code-banner mt-3 text-center">
                                    <div class="alert alert-warning border-warning" style="background: linear-gradient(45deg, #2c2c2c, #404040); border: 2px solid #ffc107;">
                                        <h6 class="mb-1 fw-bold text-light">
                                            <i class="bi bi-tag-fill text-warning me-2"></i>¬°Usa el C√≥digo Promocional!
                                        </h6>
                                        <h4 class="mb-0 fw-bold text-warning">B9580</h4>
                                        <small class="text-light">Aplica este c√≥digo al momento de reservar</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Mostrar los elementos
            globalCheapestInfo.style.display = 'block';
            globalCheapestSection.style.display = 'block';
            
            console.log('‚úÖ Secci√≥n global mostrada correctamente');
            
            // Generar imagen para la mejor oferta
            if (cheapest.segments && cheapest.segments.length > 0) {
                console.log('Generando imagen para la mejor oferta:', cheapest);
                
                const imageData = {
                    city: cheapest.city,
                    price: cheapest.price,
                    segments: cheapest.segments,
                    searchDate: cheapest.searchDate,
                    returnDate: cheapest.returnDate,
                    stopoverType: cheapest.stopover
                };
                
                console.log('Debug - imageData enviado a generateOfferImage:', imageData);
                
                const generatedImage = await generateOfferImage(imageData);
                if (generatedImage) {
                    // Detectar modo actual
                    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                    console.log('Debug - Modo detectado:', isDarkMode ? 'dark' : 'light');
                    
                    // Usar IDs correctos seg√∫n el modo
                    const imageId = isDarkMode ? 'offer-image-dark' : 'offer-image-light';
                    const containerId = isDarkMode ? 'offer-image-container-dark' : 'offer-image-container-light';
                    const copyBtnId = isDarkMode ? 'copy-image-btn-dark' : 'copy-image-btn-light';
                    
                    console.log('Debug - IDs a buscar:', { imageId, containerId, copyBtnId });
                    
                    // Buscar el contenedor y la imagen con los IDs correctos
                    setTimeout(() => {
                        const offerImage = document.getElementById(imageId);
                        const offerImageContainer = document.getElementById(containerId);
                        
                        console.log('Debug - Elementos encontrados:', { 
                            offerImage: !!offerImage, 
                            offerImageContainer: !!offerImageContainer,
                            imageId,
                            containerId 
                        });
                        
                        if (offerImage && offerImageContainer) {
                            offerImage.src = generatedImage;
                            offerImageContainer.style.display = 'block';
                            offerImageContainer.classList.add('offer-image-container');
                            
                            // Mostrar el bot√≥n de copia
                            const copyBtn = document.getElementById(copyBtnId);
                            if (copyBtn) {
                                copyBtn.style.display = 'flex';
                            }
                            
                            console.log(`Imagen asignada correctamente al contenedor ${isDarkMode ? 'din√°mico (dark)' : 'est√°tico (light)'}`);
                        } else {
                            console.error(`No se encontraron los elementos de imagen para modo ${isDarkMode ? 'dark' : 'light'}`);
                        }
                    }, 100);
                }
            }
        }

        // Funci√≥n para generar la interfaz din√°mica
        function generateDynamicInterface(dateCombo) {
            const dateTabs = document.getElementById('date-tabs');
            const dateContents = document.getElementById('date-contents');
            
            // Limpiar contenido previo
            dateTabs.innerHTML = '';
            dateContents.innerHTML = '';
            
            // Crear contenedor principal de filtros
            const mainFilterContainer = document.createElement('div');
            mainFilterContainer.className = 'filter-container';
            
            // Crear t√≠tulo de filtros
            const filterTitle = document.createElement('div');
            filterTitle.className = 'text-center mb-3';
            filterTitle.innerHTML = `
                <h6 class="mb-2">
                    <i class="bi bi-funnel-fill text-primary"></i> 
                    Filtrar por Combinaciones de Fechas
                </h6>
                <small class="text-muted">Desliza horizontalmente para ver m√°s fechas en m√≥viles</small>
            `;
            
            // Crear botones de filtro por fechas
            const filterContainer = document.createElement('div');
            filterContainer.className = 'btn-group';
            filterContainer.setAttribute('role', 'group');
            
            // Bot√≥n "Todas las combinaciones"
            const allButton = document.createElement('button');
            allButton.type = 'button';
            allButton.className = 'btn btn-outline-primary active all-combo';
            allButton.onclick = () => filterByDate('all');
            allButton.innerHTML = `
                <i class="bi bi-grid-3x3-gap"></i> Todas
            `;
            filterContainer.appendChild(allButton);
            
            // Agregar botones para cada combinaci√≥n de fecha
            Object.keys(dateCombo).forEach((comboId, index) => {
                const combo = dateCombo[comboId];
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-outline-primary';
                button.onclick = () => filterByDate(comboId);
                button.setAttribute('data-combo-id', comboId);
                
                // Formatear fechas: sin a√±o para los botones de filtro
                const compactSearchDate = formatDateCompact(combo.searchDate);
                const compactReturnDate = formatDateCompact(combo.returnDate);
                
                button.innerHTML = `
                    <i class="bi bi-calendar-week"></i> 
                    <span class="d-none d-md-inline">${compactSearchDate} ‚Üí ${compactReturnDate}</span>
                    <span class="d-md-none">${compactSearchDate}‚Üí${compactReturnDate}</span>
                `;
                filterContainer.appendChild(button);
            });
            
            mainFilterContainer.appendChild(filterTitle);
            mainFilterContainer.appendChild(filterContainer);
            dateTabs.appendChild(mainFilterContainer);
            
            // Crear lista de todas las ofertas
            const allOffers = [];
            Object.keys(dateCombo).forEach(comboId => {
                const combo = dateCombo[comboId];
                combo.itineraries.forEach(itinerary => {
                    if (itinerary.cheapest) {
                        allOffers.push({
                            ...itinerary,
                            comboId: comboId,
                            searchDate: combo.searchDate,
                            returnDate: combo.returnDate,
                            segments: itinerary.cheapest?.segments || itinerary.segments
                        });
                    }
                });
            });
            
            // Ordenar ofertas por precio
            allOffers.sort((a, b) => parseFloat(a.cheapest.price) - parseFloat(b.cheapest.price));
            
            // Generar lista de ofertas
            generateOffersList(allOffers, dateCombo);
        }

        // Funci√≥n para generar grupos de ciudades
        function generateCityGroups(itineraries) {
            const cities = {};
            
            // Agrupar por ciudad
            itineraries.forEach(itinerary => {
                const city = itinerary.city;
                if (!cities[city]) {
                    cities[city] = {
                        ida: null,
                        regreso: null
                    };
                }
                cities[city][itinerary.stopover] = itinerary;
            });
            
            let html = '<div class="row">';
            
            Object.keys(cities).forEach(cityName => {
                const cityData = cities[cityName];
                html += `
                    <div class="col-md-6 mb-4">
                        <div class="city-group">
                            <h5 class="city-name">${cityName}</h5>
                            <div class="stopovers">
                `;
                
                // Stopover de ida
                if (cityData.ida && cityData.ida.cheapest) {
                    html += generateStopoverCard(cityData.ida, 'ida');
                } else {
                    html += `<div class="stopover-card error">
                        <h6>Stopover de Ida en Panam√°</h6>
                        <p>Sin resultados disponibles</p>
                    </div>`;
                }
                
                // Stopover de regreso
                if (cityData.regreso && cityData.regreso.cheapest) {
                    html += generateStopoverCard(cityData.regreso, 'regreso');
                } else {
                    html += `<div class="stopover-card error">
                        <h6>Stopover de Regreso en Panam√°</h6>
                        <p>Sin resultados disponibles</p>
                    </div>`;
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // Funci√≥n para generar tarjeta de stopover
        function generateStopoverCard(itinerary, stopoverType) {
            const data = itinerary.cheapest;
            return `
                <div class="stopover-card">
                    <div class="stopover-header">
                        <h6>Stopover de ${stopoverType.charAt(0).toUpperCase() + stopoverType.slice(1)} en Panam√°</h6>
                        <span class="price">$${data.price}</span>
                    </div>
                    <div class="route-info">
                        <p><strong>Ruta:</strong> ${data.segments ? data.segments.map(s => s.route).join(' ‚Üí ') : 'N/A'}</p>
                        <p><strong>Duraci√≥n:</strong> ${data.totalDuration || 'N/A'}</p>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para obtener el c√≥digo de aeropuerto por ciudad
        function getCityAirportCode(city) {
            const cityCode = city === 'Quito' ? 'UIO' : 
                           city === 'Medell√≠n' ? 'MDE' : 
                           city === 'Cali' ? 'CLO' : 
                           city === 'Cartagena' ? 'CTG' : 
                           city === 'Bogot√°' ? 'BOG' : 
                           city.substring(0, 3).toUpperCase();
            
            console.log(`üèôÔ∏è C√≥digo aeropuerto para ${city}: ${cityCode}`);
            return cityCode;
        }

        // Funci√≥n para convertir c√≥digo de aeropuerto a formato "Ciudad (C√ìDIGO)"
        function getAirportDisplayName(code) {
            const airportMap = {
                'PTY': 'Panam√° (PTY)',
                'LIM': 'Lima (LIM)',
                'UIO': 'Quito (UIO)',
                'MDE': 'Medell√≠n (MDE)',
                'CLO': 'Cali (CLO)',
                'CTG': 'Cartagena (CTG)',
                'BOG': 'Bogot√° (BOG)'
            };
            
            const displayName = airportMap[code] || `${code} (${code})`;
            console.log(`‚úàÔ∏è C√≥digo ${code} convertido a: ${displayName}`);
            return displayName;
        }

        // Helpers globales para banderas por aeropuerto y HTML enriquecido
        function airportToCountry(code) {
            const map = {
                PTY: 'PA', // Panam√°
                LIM: 'PE', // Per√∫
                UIO: 'EC', // Ecuador
                MDE: 'CO', CLO: 'CO', CTG: 'CO', BOG: 'CO' // Colombia
            };
            return map[code] || null;
        }
        function countryFlagUrl(countryCode) {
            return countryCode ? `https://flagcdn.com/w20/${countryCode.toLowerCase()}.png` : null;
        }
        function getFlagImg(airportCode) {
            const cc = airportToCountry(airportCode);
            const url = countryFlagUrl(cc);
            return url ? `<img class="flag-icon" src="${url}" alt="">` : '';
        }
        function getAirportDisplayHtml(code) {
            const text = getAirportDisplayName(code);
            const img = getFlagImg(code);
            return `${img}${text}`;
        }
        // Construir URL a Copa Airlines para vuelos directos (roundtrip cl√°sico)
        function buildCopaDirectUrl(offer) {
            try {
                const origin = 'LIM';
                const dest = 'PTY';
                const date1 = offer.searchDate;
                const date2 = offer.returnDate;
                const params = {
                    roundtrip: 'true',
                    adults: '1',
                    children: '0',
                    infants: '0',
                    date1,
                    date2,
                    promocode: 'B9580',
                    area1: origin,
                    area2: dest,
                    advanced_air_search: 'false',
                    flexible_dates_v2: 'false',
                    airline_preference: ''
                };
                const qs = Object.entries(params)
                    .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
                    .join('&');
                return `https://shopping.copaair.com/?${qs}`;
            } catch (e) {
                console.warn('No se pudo construir la URL de Copa para vuelo directo', e);
                return '#';
            }
        }
        // Construir URL a Copa Airlines (summary) para stopover (ida/regreso) seg√∫n la oferta
        function buildCopaStopoverSummaryUrl(offer) {
            try {
                const origin = 'LIM';
                const hub = 'PTY';
                const dest = getCityAirportCode(offer.city);
                const sd = offer.searchDate; // salida de Lima
                const rd = offer.returnDate; // regreso a Lima
                const stop = (offer.stopover || '').toLowerCase();
                const type = stop.includes('regreso') ? 'arrival' : 'origin'; // ida => origin, regreso => arrival
                const base = 'https://shopping.copaair.com/summary';

                // Fechas seg√∫n ejemplo provisto
                const date1 = sd;
                const date2 = type === 'origin' ? rd : sd;
                const date3 = rd;

                // √Åreas seg√∫n ejemplo
                const params = {
                    roundtrip: 'false', adults: '1', children: '0', infants: '0',
                    date1, date2, date3, date4: 'null', date5: 'null',
                    promocode: '',
                    area1: origin,
                    area2: type === 'origin' ? hub : dest,
                    area3: type === 'origin' ? hub : dest,
                    area4: type === 'origin' ? dest : hub,
                    area5: type === 'origin' ? dest : hub,
                    area6: origin,
                    area7: '', area8: '', area9: '', area10: '',
                    advanced_air_search: 'true', flexible_dates_v2: 'false',
                    stopoverNights: 'null', stopoverLegNumber: 'null', stopover: 'true',
                    cabinType: 'Y', stopoverType: type, senior: '0'
                };
                const qs = Object.entries(params)
                    .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
                    .join('&');
                return `${base}?${qs}`;
            } catch (e) {
                console.warn('No se pudo construir la URL de Copa (summary) para stopover', e);
                return '#';
            }
        }
        // Enriquecer cadena de ruta que ya incluye nombres y c√≥digos, p.ej. "Lima (LIM) ‚Üí Panam√° (PTY)"
        function enrichRouteDisplayWithFlags(routeHtml) {
            if (!routeHtml || typeof routeHtml !== 'string') return routeHtml;
            // Reemplazar cada ocurrencia de "Ciudad (XXX)" por "<img>Ciudad (XXX)"
            return routeHtml.replace(/([A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±\s]+)\((?<code>[A-Z]{3})\)/g, (full, namePart, _ignore, offset, str, groups) => {
                const match = full.match(/\(([A-Z]{3})\)/);
                const code = groups?.code || (match ? match[1] : null);
                if (!code) return full;
                const enriched = `${getFlagImg(code)}${namePart.trim()}(${code})`;
                return enriched;
            });
        }

        // Funci√≥n para generar ruta para el mensaje de la oferta m√°s barata
        function generateRouteForMessage(city, stopover, searchDate, returnDate) {
            // Funci√≥n auxiliar para formatear fecha a DD/MM
            function formatDateForRoute(dateStr) {
                if (!dateStr) return '';
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    return `${parts[2]}/${parts[1]}`;
                }
                return dateStr;
            }
            
            const cityCode = city === 'Quito' ? 'UIO' : 
                           city === 'Medell√≠n' ? 'MDE' : 
                           city === 'Cali' ? 'CLO' : 
                           city === 'Cartagena' ? 'CTG' : 
                           city === 'Bogot√°' ? 'BOG' : 
                           city.substring(0, 3).toUpperCase();
            
            const outboundDate = formatDateForRoute(searchDate);
            const returnDateFormatted = formatDateForRoute(returnDate);
            
            // Determinar tipo de stopover o vuelo directo
            const isDirectFlight = stopover && (stopover.toLowerCase().includes('directo') || stopover.toLowerCase().includes('sin escalas'));
            const isReturnStopover = stopover && stopover.toLowerCase().includes('regreso');
            const isOutboundStopover = stopover && stopover.toLowerCase().includes('ida');
            
            let routeMessage;
            if (isDirectFlight) {
                // VUELO DIRECTO - Sin escalas
                // Lima (LIM) ‚Üí Panam√° (PTY) (10/02), Panam√° (PTY) ‚Üí Lima (LIM) (18/02)
                routeMessage = `${getAirportDisplayName('LIM')} ‚Üí ${getAirportDisplayName('PTY')} (${outboundDate})<br>` +
                              `${getAirportDisplayName('PTY')} ‚Üí ${getAirportDisplayName('LIM')} (${returnDateFormatted})`;
            } else if (isReturnStopover) {
                // QUITO - Stopover de REGRESO en Panam√°
                // Lima (LIM) ‚Üí Quito (UIO) (11/02), Quito (UIO) ‚Üí Panam√° (PTY) (11/02), Panam√° (PTY) ‚Üí Lima (LIM) (18/02)
                routeMessage = `${getAirportDisplayName('LIM')} ‚Üí ${getAirportDisplayName(cityCode)} (${outboundDate})<br>` +
                              `${getAirportDisplayName(cityCode)} ‚Üí ${getAirportDisplayName('PTY')} (${outboundDate})<br>` +
                              `${getAirportDisplayName('PTY')} ‚Üí ${getAirportDisplayName('LIM')} (${returnDateFormatted})`;
            } else if (isOutboundStopover) {
                // MEDELL√çN - Stopover de IDA en Panam√°  
                // Lima (LIM) ‚Üí Panam√° (PTY) (11/02), Panam√° (PTY) ‚Üí Medell√≠n (MDE) (18/02), Medell√≠n (MDE) ‚Üí Lima (LIM) (18/02)
                routeMessage = `${getAirportDisplayName('LIM')} ‚Üí ${getAirportDisplayName('PTY')} (${outboundDate})<br>` +
                              `${getAirportDisplayName('PTY')} ‚Üí ${getAirportDisplayName(cityCode)} (${returnDateFormatted})<br>` +
                              `${getAirportDisplayName(cityCode)} ‚Üí ${getAirportDisplayName('LIM')} (${returnDateFormatted})`;
            } else {
                // Fallback gen√©rico
                routeMessage = `${getAirportDisplayName('LIM')} ‚Üí ${getAirportDisplayName(cityCode)} (${outboundDate})<br>` +
                              `${getAirportDisplayName(cityCode)} ‚Üí ${getAirportDisplayName('LIM')} (${returnDateFormatted})`;
            }
            
            return routeMessage;
        }

        // Funci√≥n para generar la lista de ofertas
        function generateOffersList(allOffers, dateCombo) {
            const dateContents = document.getElementById('date-contents');
            
            let html = '<div class="offers-list" id="offers-list">';
            
            allOffers.forEach((offer, index) => {
                const data = offer.cheapest;
                
                // Debug: verificar estructura de datos
                console.log(`\nüîç PROCESANDO OFERTA #${index + 1} - ${offer.city}`);
                console.log('üì¶ Estructura completa de offer:', offer);
                console.log('üí∞ Data cheapest:', data);
                console.log('üõ´ Segments disponibles:', data?.segments);
                console.log('‚úÖ Tiene segmentos v√°lidos:', data?.segments && Array.isArray(data.segments) && data.segments.length > 0);
                
                // INVESTIGAR ESTRUCTURA ALTERNATIVA DE SEGMENTS
                console.log('üîç BUSCANDO SEGMENTS EN OTRAS UBICACIONES:');
                console.log('   offer.segments:', offer.segments);
                console.log('   data.flight_segments:', data?.flight_segments);
                console.log('   data.route:', data?.route);
                console.log('   data.itinerary:', data?.itinerary);
                console.log('   Claves disponibles en data:', data ? Object.keys(data) : 'data is null/undefined');
                
                if (data?.segments && Array.isArray(data.segments)) {
                    console.log(`üìä Total de segmentos encontrados: ${data.segments.length}`);
                    data.segments.forEach((seg, segIndex) => {
                        console.log(`   Segmento ${segIndex + 1}:`, {
                            from: seg.from,
                            to: seg.to,
                            date: seg.date,
                            stops: seg.stops,
                            hasOneStop: seg.stops && seg.stops.toLowerCase().includes('1 escala'),
                            fullSegment: seg
                        });
                    });
                } else {
                    console.warn('‚ö†Ô∏è No hay segmentos v√°lidos para esta oferta');
                    console.log('üîß INTENTANDO RECONSTRUIR SEGMENTS DESDE OTROS DATOS...');
                    
                    // Intentar encontrar datos de ruta en otras propiedades
                    if (data && typeof data === 'object') {
                        Object.keys(data).forEach(key => {
                            if (key.toLowerCase().includes('segment') || 
                                key.toLowerCase().includes('route') || 
                                key.toLowerCase().includes('flight')) {
                                console.log(`   Posible fuente de segments - ${key}:`, data[key]);
                            }
                        });
                    }
                }
                
                // Generar resumen completo del itinerario respetando fechas de cada segmento
                function generateRouteDescription(segments, city, stopover, searchDate, returnDate) {
                    
                    console.log(`\nüöÄ INICIANDO generateRouteDescription para ${city}`);
                    console.log('üì• Par√°metros recibidos:', {
                        segments: segments,
                        city: city,
                        stopover: stopover,
                        searchDate: searchDate,
                        returnDate: returnDate
                    });
                    
                    // üîß VERIFICAR Y MAPEAR PROPIEDADES DE SEGMENTOS
                    if (!segments || !Array.isArray(segments) || segments.length === 0) {
                        console.log('‚ùå Segments es null, undefined, no es array o est√° vac√≠o:', segments);
                        console.log('üîÑ Usando datos de respaldo...');
                        
                        // Generar un respaldo b√°sico usando los par√°metros disponibles
                        const cityCode = city === 'Quito' ? 'UIO' : 
                                        city === 'Panam√°' ? 'PTY' : 
                                        city === 'Cartagena' ? 'CTG' : 
                                        city === 'Medell√≠n' ? 'MDE' : 
                                        city === 'Cali' ? 'CLO' : 
                                        city === 'Bogot√°' ? 'BOG' : 'XXX';
                        
                        const formattedSearchDate = searchDate ? formatDateForRoute(searchDate) : '';
                        return `Lima (LIM) ‚Üí ${city} (${cityCode}) ${formattedSearchDate ? `(${formattedSearchDate})` : ''}`;
                    }
                    
                    console.log('üîß Mapeando propiedades de segmentos...');
                    const mappedSegments = segments.map((segment, index) => {
                        // Verificar que segment no sea null/undefined
                        if (!segment) {
                            console.log(`‚ö†Ô∏è Segmento ${index + 1} es null/undefined`);
                            return null;
                        }
                        
                        // Si el segmento tiene 'route', extraer from/to
                        let from, to, date;
                        
                        if (segment.route && segment.route.includes('‚Üí')) {
                            const [fromCode, toCode] = segment.route.split('‚Üí').map(s => s.trim());
                            from = fromCode;
                            to = toCode;
                            date = segment.departure;
                        } else {
                            from = segment.from;
                            to = segment.to;
                            date = segment.date;
                        }
                        
                        const mapped = {
                            ...segment,
                            from: from,
                            to: to,
                            date: date
                        };
                        
                        console.log(`üìç Segmento ${index + 1} mapeado:`, {
                            original: { route: segment.route, departure: segment.departure },
                            mapped: { from: mapped.from, to: mapped.to, date: mapped.date }
                        });
                        
                        return mapped;
                    }).filter(segment => segment !== null); // Filtrar segmentos null
                    
                    // Usar segmentos mapeados en lugar de originales
                    segments = mappedSegments;
                    
                    // Verificar estructura de cada segmento
                    if (segments && Array.isArray(segments)) {
                        console.log('üìä An√°lisis detallado de segmentos mapeados:');
                        segments.forEach((seg, index) => {
                            console.log(`Segmento ${index + 1}:`, {
                                from: seg.from,
                                to: seg.to,
                                date: seg.date,
                                keys: Object.keys(seg),
                                valid: !!(seg.from && seg.to && seg.date)
                            });
                        });
                    }
                    
                    // Funci√≥n auxiliar para formatear fecha a DD/MM
                    function formatDateForRoute(dateStr) {
                        if (!dateStr) {
                            console.warn('‚ö†Ô∏è Fecha vac√≠a recibida en formatDateForRoute');
                            return '';
                        }
                        console.log('üìÖ Formateando fecha:', dateStr);
                        const parts = dateStr.split('-');
                        if (parts.length === 3) {
                            const formatted = `${parts[2]}/${parts[1]}`;
                            console.log(`üìÖ Resultado formato: ${dateStr} ‚Üí ${formatted}`);
                            return formatted;
                        }
                        console.warn(`‚ö†Ô∏è Formato de fecha inesperado: ${dateStr}`);
                        return dateStr;
                    }
                    
                    // Validaci√≥n inicial de par√°metros
                    if (!segments) {
                        console.error('‚ùå ERROR: segments es null o undefined');
                        console.log('üîÑ Usando fallback con par√°metros b√°sicos:', { city, stopover, searchDate, returnDate });
                        
                        // FALLBACK MEJORADO: crear ruta b√°sica con los par√°metros disponibles
                        const cityCode = city === 'Quito' ? 'UIO' : 
                                       city === 'Medell√≠n' ? 'MDE' : 
                                       city === 'Cali' ? 'CLO' : 
                                       city === 'Cartagena' ? 'CTG' : 
                                       city === 'Bogot√°' ? 'BOG' : 
                                       city.substring(0, 3).toUpperCase();
                        
                        const outboundDate = formatDateForRoute(searchDate);
                        const returnDateFormatted = formatDateForRoute(returnDate);
                        
                        // Determinar tipo de stopover para generar ruta apropiada
                        const isReturnStopover = stopover && stopover.toLowerCase().includes('regreso');
                        const isOutboundStopover = stopover && stopover.toLowerCase().includes('ida');
                        const isDirectFlight = stopover && stopover.toLowerCase().includes('directo');
                        
                        let fallbackRoute;
                        if (isDirectFlight) {
                            // VUELO DIRECTO - No hay escalas
                            // LIM ‚Üí PTY (10/02), PTY ‚Üí LIM (18/02)
                            fallbackRoute = `${getAirportDisplayName('LIM')} ‚Üí ${getAirportDisplayName('PTY')} (${outboundDate})<br>${getAirportDisplayName('PTY')} ‚Üí ${getAirportDisplayName('LIM')} (${returnDateFormatted})`;
                            console.log('üéØ Aplicando l√≥gica VUELO DIRECTO para', city);
                        } else if (isReturnStopover) {
                            // QUITO - Stopover de REGRESO en Panam√°
                            // LIM ‚Üí UIO (11/02), UIO ‚Üí PTY (11/02), PTY ‚Üí LIM (18/02)
                            fallbackRoute = `${getAirportDisplayName('LIM')} ‚Üí ${getAirportDisplayName(cityCode)} (${outboundDate})<br>${getAirportDisplayName(cityCode)} ‚Üí ${getAirportDisplayName('PTY')} (${outboundDate})<br>${getAirportDisplayName('PTY')} ‚Üí ${getAirportDisplayName('LIM')} (${returnDateFormatted})`;
                            console.log('üéØ Aplicando l√≥gica REGRESO para', city);
                        } else if (isOutboundStopover) {
                            // MEDELL√çN - Stopover de IDA en Panam√°  
                            // LIM ‚Üí PTY (11/02), PTY ‚Üí MDE (18/02), MDE ‚Üí LIM (18/02)
                            fallbackRoute = `${getAirportDisplayName('LIM')} ‚Üí ${getAirportDisplayName('PTY')} (${outboundDate})<br>${getAirportDisplayName('PTY')} ‚Üí ${getAirportDisplayName(cityCode)} (${returnDateFormatted})<br>${getAirportDisplayName(cityCode)} ‚Üí ${getAirportDisplayName('LIM')} (${returnDateFormatted})`;
                            console.log('üéØ Aplicando l√≥gica IDA para', city);
                        } else {
                            // Fallback gen√©rico
                            fallbackRoute = `${getAirportDisplayName('LIM')} ‚Üí ${getAirportDisplayName(cityCode)} (${outboundDate})<br>${getAirportDisplayName(cityCode)} ‚Üí ${getAirportDisplayName('LIM')} (${returnDateFormatted})`;
                            console.log('üéØ Aplicando l√≥gica GEN√âRICA para', city);
                        }
                        
                        console.log('üîÑ Ruta fallback generada:', fallbackRoute);
                        return fallbackRoute;
                    }
                    
                    if (!Array.isArray(segments)) {
                        console.error('‚ùå ERROR: segments no es un array:', typeof segments);
                        return 'Error: Formato de segmentos inv√°lido';
                    }
                    
                    if (segments.length === 0) {
                        console.warn('‚ö†Ô∏è WARNING: segments est√° vac√≠o');
                        console.log('üîÑ Usando fallback para array vac√≠o...');
                        
                        // Mismo fallback que arriba
                        const cityCode = city === 'Quito' ? 'UIO' : 
                                       city === 'Medell√≠n' ? 'MDE' : 
                                       city === 'Cali' ? 'CLO' : 
                                       city === 'Cartagena' ? 'CTG' : 
                                       city === 'Bogot√°' ? 'BOG' : 
                                       city.substring(0, 3).toUpperCase();
                        
                        const outboundDate = formatDateForRoute(searchDate);
                        const returnDateFormatted = formatDateForRoute(returnDate);
                        
                        const isReturnStopover = stopover && stopover.toLowerCase().includes('regreso');
                        const isOutboundStopover = stopover && stopover.toLowerCase().includes('ida');
                        const isDirectFlight = stopover && stopover.toLowerCase().includes('directo');
                        
                        let fallbackRoute;
                        if (isDirectFlight) {
                            // VUELO DIRECTO - No hay escalas
                            fallbackRoute = `${getAirportDisplayName('LIM')} ‚Üí ${getAirportDisplayName('PTY')} (${outboundDate})<br>${getAirportDisplayName('PTY')} ‚Üí ${getAirportDisplayName('LIM')} (${returnDateFormatted})`;
                        } else if (isReturnStopover) {
                            // QUITO - Stopover de REGRESO en Panam√°
                            // LIM ‚Üí UIO (11/02), UIO ‚Üí PTY (11/02), PTY ‚Üí LIM (18/02)
                            fallbackRoute = `${getAirportDisplayName('LIM')} ‚Üí ${getAirportDisplayName(cityCode)} (${outboundDate})<br>${getAirportDisplayName(cityCode)} ‚Üí ${getAirportDisplayName('PTY')} (${outboundDate})<br>${getAirportDisplayName('PTY')} ‚Üí ${getAirportDisplayName('LIM')} (${returnDateFormatted})`;
                        } else if (isOutboundStopover) {
                            // MEDELL√çN - Stopover de IDA en Panam√°  
                            // LIM ‚Üí PTY (11/02), PTY ‚Üí MDE (18/02), MDE ‚Üí LIM (18/02)
                            fallbackRoute = `${getAirportDisplayName('LIM')} ‚Üí ${getAirportDisplayName('PTY')} (${outboundDate})<br>${getAirportDisplayName('PTY')} ‚Üí ${getAirportDisplayName(cityCode)} (${returnDateFormatted})<br>${getAirportDisplayName(cityCode)} ‚Üí ${getAirportDisplayName('LIM')} (${returnDateFormatted})`;
                        } else {
                            fallbackRoute = `${getAirportDisplayName('LIM')} ‚Üí ${getAirportDisplayName(cityCode)} (${outboundDate})<br>${getAirportDisplayName(cityCode)} ‚Üí ${getAirportDisplayName('LIM')} (${returnDateFormatted})`;
                        }
                        
                        return fallbackRoute;
                    }
                    
                    // SIEMPRE priorizar los datos reales de segmentos de la API
                    if (segments && Array.isArray(segments) && segments.length > 0) {
                        console.log('=== üõ´ GENERANDO RESUMEN COMPLETO DEL ITINERARIO ===');
                        console.log('üìã Segmentos originales:', JSON.stringify(segments, null, 2));
                        console.log('üîÑ Tipo de stopover:', stopover);
                        console.log('üìä Total de segmentos:', segments.length);
                        
                        // NUEVA L√ìGICA: Analizar tipo de vuelo
                        const isReturnStopover = stopover && stopover.toLowerCase().includes('regreso');
                        const isOutboundStopover = stopover && stopover.toLowerCase().includes('ida');
                        const isDirectFlight = stopover && (stopover.toLowerCase().includes('directo') || stopover.toLowerCase().includes('sin escalas'));
                        
                        console.log('üîç AN√ÅLISIS DE TIPO DE VUELO:');
                        console.log(`   ‚îú‚îÄ Es vuelo directo: ${isDirectFlight}`);
                        console.log(`   ‚îú‚îÄ Es stopover de regreso: ${isReturnStopover}`);
                        console.log(`   ‚îú‚îÄ Es stopover de ida: ${isOutboundStopover}`);
                        console.log(`   ‚îî‚îÄ Texto completo: "${stopover}"`);
                        
                        // Validar estructura de cada segmento
                        let invalidSegments = [];
                        segments.forEach((seg, idx) => {
                            if (!seg.from || !seg.to || !seg.date) {
                                invalidSegments.push({
                                    index: idx,
                                    segment: seg,
                                    missing: {
                                        from: !seg.from,
                                        to: !seg.to,
                                        date: !seg.date
                                    }
                                });
                            }
                        });
                        
                        if (invalidSegments.length > 0) {
                            console.error('‚ùå SEGMENTOS INV√ÅLIDOS ENCONTRADOS:');
                            invalidSegments.forEach(invalid => {
                                console.error(`   Segmento ${invalid.index + 1}:`, invalid);
                            });
                        }
                        
                        let routes = [];
                        
                        // NUEVA ESTRATEGIA: Procesar seg√∫n el tipo de vuelo
                        if (isDirectFlight) {
                            console.log('\n‚úàÔ∏è PROCESANDO VUELO DIRECTO...');
                            
                            // Para vuelos directos: mostrar todos los segmentos individuales (ida y vuelta)
                            for (let i = 0; i < segments.length; i++) {
                                const segment = segments[i];
                                console.log(`\nüîç Procesando segmento directo ${i + 1}: ${segment.from} ‚Üí ${segment.to}`);
                                
                                if (segment.from && segment.to && segment.date) {
                                    const segmentDate = formatDateForRoute(segment.date);
                                    const route = `${getAirportDisplayName(segment.from)} ‚Üí ${getAirportDisplayName(segment.to)} (${segmentDate})`;
                                    console.log(`‚û°Ô∏è SEGMENTO DIRECTO: ${route}`);
                                    routes.push(route);
                                } else {
                                    console.error(`‚ùå SEGMENTO DIRECTO ${i + 1} INCOMPLETO:`, segment);
                                }
                            }
                            
                        } else if (isReturnStopover && segments.length >= 3) {
                            console.log('\nüîÑ PROCESANDO STOPOVER DE REGRESO...');
                            
                            // Para stopover de regreso: mostrar TODOS los segmentos individuales
                            // Ejemplo Quito: LIM‚ÜíUIO (individual), UIO‚ÜíPTY (individual), PTY‚ÜíLIM (individual)
                            
                            for (let i = 0; i < segments.length; i++) {
                                const segment = segments[i];
                                console.log(`\nÔøΩ Analizando segmento ${i + 1}: ${segment.from} ‚Üí ${segment.to}`);
                                
                                // Para stopover de regreso: NO agrupar, mostrar todos los segmentos individuales
                                if (segment.from && segment.to && segment.date) {
                                    const segmentDate = formatDateForRoute(segment.date);
                                    const route = `${getAirportDisplayName(segment.from)} ‚Üí ${getAirportDisplayName(segment.to)} (${segmentDate})`;
                                    console.log(`‚û°Ô∏è SEGMENTO INDIVIDUAL: ${route}`);
                                    routes.push(route);
                                } else {
                                    console.error(`‚ùå SEGMENTO ${i + 1} INCOMPLETO:`, segment);
                                }
                            }
                            
                        } else if (isOutboundStopover && segments.length >= 3) {
                            console.log('\nüîÑ PROCESANDO STOPOVER DE IDA...');
                            
                            // Para stopover de ida: LIM‚ÜíPTY individual, PTY‚ÜíDEST‚ÜíLIM agrupado
                            // Ejemplo Medell√≠n: LIM‚ÜíPTY (individual), PTY‚ÜíMED‚ÜíLIM puede no agruparse si no tiene "1 escala"
                            
                            let i = 0;
                            
                            while (i < segments.length) {
                                const segment = segments[i];
                                console.log(`\nüîç Analizando segmento ${i + 1}: ${segment.from} ‚Üí ${segment.to}`);
                                
                                // Buscar agrupaciones con "1 escala" independientemente de la posici√≥n
                                const hasOneStop = segment.stops && segment.stops.toLowerCase().includes('1 escala');
                                const hasNextSegment = i < segments.length - 1;
                                const nextSegment = hasNextSegment ? segments[i + 1] : null;
                                
                                if (hasOneStop && hasNextSegment && segment.to === 'PTY' && nextSegment.from === 'PTY') {
                                    // Agrupar este segmento con el siguiente
                                    const firstDate = formatDateForRoute(segment.date);
                                    const secondDate = formatDateForRoute(nextSegment.date);
                                    
                                    let dateDisplay = (firstDate === secondDate) ? `(${firstDate})` : `(${firstDate}/${secondDate})`;
                                    const groupedRoute = `${getAirportDisplayName(segment.from)} ‚Üí ${getAirportDisplayName(nextSegment.to)} ${dateDisplay}`;
                                    
                                    console.log(`‚úÖ AGRUPANDO SEGMENTOS ${i + 1} y ${i + 2}: ${groupedRoute}`);
                                    routes.push(groupedRoute);
                                    i += 2;
                                } else {
                                    // Procesar segmento individual
                                    const segmentDate = formatDateForRoute(segment.date);
                                    const route = `${getAirportDisplayName(segment.from)} ‚Üí ${getAirportDisplayName(segment.to)} (${segmentDate})`;
                                    console.log(`‚û°Ô∏è SEGMENTO INDIVIDUAL: ${route}`);
                                    routes.push(route);
                                    i++;
                                }
                            }
                            
                        } else {
                            console.log('\nüîÑ PROCESANDO COMO STOPOVER GEN√âRICO...');
                            
                            // L√≥gica original para otros casos
                            let i = 0;
                            
                            while (i < segments.length) {
                                const segment = segments[i];
                                console.log(`\nüîç Analizando segmento ${i + 1}: ${segment.from} ‚Üí ${segment.to}`);
                                
                                // Verificar si este segmento tiene "1 escala" y puede agruparse
                                const hasOneStop = segment.stops && segment.stops.toLowerCase().includes('1 escala');
                                const hasNextSegment = i < segments.length - 1;
                                const endsToPty = segment.to === 'PTY';
                                const nextStartsFromPty = hasNextSegment && segments[i + 1].from === 'PTY';
                                
                                console.log(`üîé AN√ÅLISIS DE AGRUPACI√ìN:`);
                                console.log(`   ‚îú‚îÄ Tiene "1 escala": ${hasOneStop}`);
                                console.log(`   ‚îú‚îÄ Termina en PTY: ${endsToPty}`);
                                console.log(`   ‚îî‚îÄ Siguiente empieza en PTY: ${nextStartsFromPty}`);
                                
                                // Agrupar si cumple todas las condiciones de "1 escala"
                                if (hasOneStop && hasNextSegment && endsToPty && nextStartsFromPty) {
                                    const nextSegment = segments[i + 1];
                                    
                                    // Respetar las fechas espec√≠ficas de cada segmento
                                    const firstSegmentDate = formatDateForRoute(segment.date);
                                    const secondSegmentDate = formatDateForRoute(nextSegment.date);
                                    
                                    // Si las fechas son iguales, mostrar una sola fecha
                                    // Si son diferentes, mostrar ambas fechas
                                    let dateDisplay;
                                    if (firstSegmentDate === secondSegmentDate) {
                                        dateDisplay = `(${firstSegmentDate})`;
                                    } else {
                                        dateDisplay = `(${firstSegmentDate}/${secondSegmentDate})`;
                                    }
                                    
                                    // Crear ruta agrupada con fechas espec√≠ficas
                                    const groupedRoute = `${getAirportDisplayName(segment.from)} ‚Üí ${getAirportDisplayName(nextSegment.to)} ${dateDisplay}`;
                                    console.log(`‚úÖ RUTA AGRUPADA: ${groupedRoute}`);
                                    routes.push(groupedRoute);
                                    i += 2;
                                } else {
                                    // Mostrar segmento individual con su fecha espec√≠fica
                                    if (segment.from && segment.to && segment.date) {
                                        const segmentDate = formatDateForRoute(segment.date);
                                        const route = `${getAirportDisplayName(segment.from)} ‚Üí ${getAirportDisplayName(segment.to)} (${segmentDate})`;
                                        console.log(`‚û°Ô∏è RUTA INDIVIDUAL: ${route}`);
                                        routes.push(route);
                                    } else {
                                        console.error(`‚ùå SEGMENTO ${i + 1} INCOMPLETO:`, segment);
                                        console.error('üìä Propiedades del segmento:', {
                                            from: segment.from,
                                            to: segment.to,
                                            date: segment.date,
                                            hasFrom: segment.hasOwnProperty('from'),
                                            hasTo: segment.hasOwnProperty('to'),
                                            hasDate: segment.hasOwnProperty('date'),
                                            keys: Object.keys(segment)
                                        });
                                    }
                                    i++;
                                }
                            }
                        }
                        
                        const result = routes.join('<br>');
                        console.log('\n=== üéØ RESULTADO FINAL DEL PROCESAMIENTO ===');
                        console.log('üìã Rutas procesadas:', routes);
                        console.log('üìä Total de rutas generadas:', routes.length);
                        console.log('üî§ HTML resultado:', result);
                        console.log('ÔøΩ Tipo de stopover aplicado:', isReturnStopover ? 'REGRESO' : isOutboundStopover ? 'IDA' : 'GEN√âRICO');
                        console.log('=== ‚úÖ FIN PROCESAMIENTO ===\n');
                        
                        // ‚úÖ VERIFICACI√ìN FINAL: Asegurar que siempre retornemos algo v√°lido
                        if (!result || result.trim() === '') {
                            console.log('‚ö†Ô∏è Resultado vac√≠o, generando respaldo...');
                            return `${city} - ${searchDate}`;
                        }
                        
                        return result;
                    }
                    
                    // Solo usar datos de respaldo si NO hay segmentos de la API
                    console.error('üö® USANDO DATOS DE RESPALDO - NO HAY SEGMENTOS DE LA API');
                    console.log('üìã Par√°metros para respaldo:', {
                        city: city,
                        stopover: stopover,
                        searchDate: searchDate,
                        returnDate: returnDate
                    });
                    
                    const cityCode = city === 'Quito' ? 'UIO' : 
                                   city === 'Medell√≠n' ? 'MED' : 
                                   city === 'Cali' ? 'CLO' : 
                                   city === 'Cartagena' ? 'CTG' : 
                                   city === 'Bogot√°' ? 'BOG' : 
                                   city.substring(0, 3).toUpperCase();
                    
                    console.log(`üèôÔ∏è Ciudad "${city}" mapeada a c√≥digo: ${cityCode}`);
                    
                    const outboundDate = formatDateForRoute(searchDate);
                    const returnDateFormatted = formatDateForRoute(returnDate);
                    
                    console.log('üìÖ Fechas de respaldo formateadas:', { 
                        searchDate: searchDate,
                        outboundDate: outboundDate,
                        returnDate: returnDate,
                        returnDateFormatted: returnDateFormatted 
                    });
                    
                    // Mostrar itinerario simplificado agrupando escalas
                    const fallbackRoute = `LIM ‚Üí ${cityCode} (${outboundDate})<br>${cityCode} ‚Üí LIM (${returnDateFormatted})`;
                    console.log('üîÑ Ruta de respaldo generada:', fallbackRoute);
                    console.warn('‚ö†Ô∏è NOTA: Esta es una ruta simplificada sin datos reales de segmentos');
                    return fallbackRoute;
                }
                
                // EXTRAER SEGMENTS DESDE originDestinations
                console.log('üîç DEBUG: Extrayendo segments desde originDestinations...');
                
                let segments = [];
                
                // PRIORIDAD 1: Intentar extraer desde offer.segments (para vuelos directos)
                if (offer.segments && Array.isArray(offer.segments) && offer.segments.length > 0) {
                    console.log('üîç DEBUG: Encontrados segments en offer.segments:', offer.segments.length);
                    
                    offer.segments.forEach((segment, index) => {
                        console.log(`üîç DEBUG: Procesando segment ${index + 1} desde offer.segments:`, segment);
                        
                        // Para vuelos directos: index 0 = ida, index 1 = regreso
                        const isReturnSegment = index === 1;
                        
                        // Crear segmento con la estructura disponible
                        const mappedSegment = {
                            from: segment.origin || segment.departure?.airportCode || (isReturnSegment ? 'PTY' : 'LIM'),
                            to: segment.destination || segment.arrival?.airportCode || (isReturnSegment ? 'LIM' : 'PTY'),
                            date: segment.departureDate || (isReturnSegment ? offer.returnDate : offer.searchDate),
                            stops: 'Directo'
                        };
                        
                        console.log(`‚úÖ Segmento mapeado desde offer.segments: ${mappedSegment.from} ‚Üí ${mappedSegment.to} (${mappedSegment.date})`);
                        segments.push(mappedSegment);
                    });
                }
                
                // PRIORIDAD 2: Si no hay segments, extraer desde originDestinations (para stopovers)
                if (segments.length === 0 && offer.originDestinations && Array.isArray(offer.originDestinations)) {
                    console.log('üîç DEBUG: Procesando originDestinations, total:', offer.originDestinations.length);
                    
                    offer.originDestinations.forEach((od, index) => {
                        console.log(`üîç DEBUG: Procesando OD${index + 1}:`, od.originDestinationKey);
                        
                        if (od.solutions && od.solutions.length > 0) {
                            const firstSolution = od.solutions[0]; // Tomar la primera soluci√≥n
                            
                            // Para cada OD, crear UN SOLO segmento que represente el tramo completo
                            const segment = {
                                from: od.origin.code,
                                to: od.destination.code,
                                date: od.origin.departureDate,
                                stops: firstSolution.numberOfLayovers > 0 ? '1 escala' : 'Directo'
                            };
                            
                            console.log(`‚úÖ Segmento extra√≠do desde originDestinations: ${segment.from} ‚Üí ${segment.to} (${segment.date})`);
                            segments.push(segment);
                        }
                    });
                }
                
                // MANEJO ESPECIAL PARA VUELOS DIRECTOS
                // Si es vuelo directo y solo hay un segmento, agregar el segmento de regreso
                const isDirectFlightCheck = offer.stopover && (
                    offer.stopover.toLowerCase().includes('directo') || 
                    offer.stopover.toLowerCase().includes('sin escalas') ||
                    offer.stopover.toLowerCase().includes('sinescalas')
                );
                
                console.log('üîç DEBUG VUELOS DIRECTOS:');
                console.log('   ‚îú‚îÄ offer.stopover:', offer.stopover);
                console.log('   ‚îú‚îÄ isDirectFlightCheck:', isDirectFlightCheck);
                console.log('   ‚îú‚îÄ segments.length ANTES:', segments.length);
                
                if (isDirectFlightCheck && segments.length === 1) {
                    console.log('‚úÖ DEBUG: Vuelo directo con 1 segmento, agregando segmento de regreso...');
                    
                    const outboundSegment = segments[0];
                    const returnSegment = {
                        from: outboundSegment.to,
                        to: outboundSegment.from,
                        date: offer.returnDate,
                        stops: 'Directo'
                    };
                    
                    console.log(`‚úÖ Segmento de regreso agregado: ${returnSegment.from} ‚Üí ${returnSegment.to} (${returnSegment.date})`);
                    segments.push(returnSegment);
                } else if (isDirectFlightCheck && segments.length === 0) {
                    console.log('‚úÖ DEBUG: Vuelo directo sin segmentos, creando segmentos b√°sicos...');
                    
                    // Crear segmentos b√°sicos para vuelos directos
                    const outboundSegment = {
                        from: 'LIM',
                        to: 'PTY',
                        date: offer.searchDate,
                        stops: 'Directo'
                    };
                    
                    const returnSegment = {
                        from: 'PTY',
                        to: 'LIM',
                        date: offer.returnDate,
                        stops: 'Directo'
                    };
                    
                    segments.push(outboundSegment);
                    segments.push(returnSegment);
                    
                    console.log(`‚úÖ Segmentos directos creados: LIM‚ÜíPTY (${offer.searchDate}) y PTY‚ÜíLIM (${offer.returnDate})`);
                } else if (isDirectFlightCheck) {
                    console.log(`‚úÖ DEBUG: Vuelo directo con ${segments.length} segmentos, no necesita ajustes`);
                } else {
                    console.log('‚ÑπÔ∏è DEBUG: No es vuelo directo o condiciones no cumplen para ajustes');
                }
                
                console.log('   ‚îî‚îÄ segments.length DESPU√âS:', segments.length);
                
                console.log('üîç DEBUG: Total segments extra√≠dos:', segments.length);
                console.log('üîç DEBUG: Segments completos:', segments);
                
                // √öltima validaci√≥n antes de llamar a generateRouteDescription
                if (!segments || !Array.isArray(segments) || segments.length === 0) {
                    console.warn('‚ö†Ô∏è No se encontraron segments v√°lidos despu√©s de extraer desde originDestinations');
                    segments = []; // Usar array vac√≠o en lugar de null
                } else {
                    console.log('‚úÖ Segments v√°lidos encontrados:', segments.length);
                }
                
                const routeDisplay = generateRouteDescription(segments, offer.city, offer.stopover, offer.searchDate, offer.returnDate);
                
                console.log(`\nüéØ LLAMADA A generateRouteDescription para ${offer.city}:`);
                console.log('üì® Par√°metros enviados:', {
                    segments: segments,
                    city: offer.city,
                    stopover: offer.stopover,
                    searchDate: offer.searchDate,
                    returnDate: offer.returnDate
                });
                console.log('üìä Segments es array?', Array.isArray(segments));
                console.log('üìä Segments length:', segments?.length || 0);
                
                console.log(`\nüé® GENERANDO HTML PARA OFERTA #${index + 1}`);
                console.log('üõ´ RouteDisplay final generado:', routeDisplay);
                console.log('üìä N√∫mero de l√≠neas en la ruta:', (routeDisplay.match(/<br>/g) || []).length + 1);
                console.log('üéØ Expectativa: 3 l√≠neas para vuelos con escalas agrupadas correctamente');
                
                // Preparar datos de segmentos detallados para este offer
                const detailPayload = {
                    city: offer.city,
                    stopover: offer.stopover,
                    price: data?.price,
                    searchDate: offer.searchDate,
                    returnDate: offer.returnDate,
                    // Preferir originDestinations enriquecidos si existen para este itinerario
                    originDestinations: offer.originDestinations || undefined,
                    // Incluir segments mapeados si est√°n en cheapest
                    segments: data?.segments || undefined
                };

                html += `
                    <div class="offer-card mb-3" data-combo-id="${offer.comboId}" data-city="${offer.city}">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-1">
                                        <div class="offer-rank">
                                            <span class="badge bg-primary">#${index + 1}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <h6 class="mb-1">${getFlagImg(getCityAirportCode(offer.city))}${offer.city} (${getCityAirportCode(offer.city)})</h6>
                                        <small class="text-muted">${offer.stopover === 'directo' ? '‚úàÔ∏è Vuelo Directo Sin Escalas' : `Stopover de ${offer.stopover} en Panam√°`}</small>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="date-info">
                                            <small class="text-muted">Salida:</small> ${formatDateDMY(offer.searchDate)}<br>
                                            <small class="text-muted">Regreso:</small> ${formatDateDMY(offer.returnDate)}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="route-info">
                                            <p class="mb-1"><strong>Ruta:</strong></p>
                                            <small style="line-height: 1.4; display: block; white-space: normal;">${enrichRouteDisplayWithFlags(routeDisplay)}</small>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <div class="price-info">
                                            <h5 class="text-primary mb-0">$${data.price}</h5>
                                            <small class="text-muted">USD</small>
                                        </div>
                                        ${offer.stopover !== 'directo' ? `
                                        <a class="btn btn-copa btn-sm mt-2" href="${buildCopaStopoverSummaryUrl(offer)}" target="_blank" rel="noopener noreferrer" title="Abrir reserva en Copa en nueva pesta√±a">
                                            <i class="bi bi-bag-check-fill me-1"></i> Reservar en Copa
                                        </a>` : `
                                        <a class="btn btn-copa btn-sm mt-2" href="${buildCopaDirectUrl(offer)}" target="_blank" rel="noopener noreferrer" title="Abrir reserva en Copa en nueva pesta√±a">
                                            <i class="bi bi-bag-check-fill me-1"></i> Reservar en Copa
                                        </a>`}
                                        ${offer.stopover === 'directo' ? '' : `
                                        <button type="button" class="btn btn-outline-primary btn-sm mt-2 btn-flight-detail" 
                                            data-offer='${JSON.stringify(detailPayload).replace(/'/g, "&apos;")}'>
                                            Detalle de vuelo
                                        </button>`}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            dateContents.innerHTML = html;
        }

        // Funci√≥n para filtrar ofertas por fecha
        function filterByDate(filterComboId) {
            // Actualizar botones activos
            const filterButtons = document.querySelectorAll('.btn-group button');
            
            // Remover clase active de todos los botones
            filterButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-pressed', 'false');
            });
            
            // Mostrar/ocultar ofertas con animaci√≥n
            const offers = document.querySelectorAll('.offer-card');
            let visibleCount = 0;
            
            offers.forEach(offer => {
                if (filterComboId === 'all' || offer.dataset.comboId === filterComboId) {
                    offer.style.display = 'block';
                    offer.style.animation = 'fadeIn 0.3s ease-in';
                    visibleCount++;
                } else {
                    offer.style.display = 'none';
                }
            });
            
            // Activar el bot√≥n correspondiente
            if (filterComboId === 'all') {
                filterButtons[0].classList.add('active');
                filterButtons[0].setAttribute('aria-pressed', 'true');
            } else {
                // Encontrar el bot√≥n correcto por el atributo data-combo-id
                filterButtons.forEach(btn => {
                    if (btn.getAttribute('data-combo-id') === filterComboId) {
                        btn.classList.add('active');
                        btn.setAttribute('aria-pressed', 'true');
                        
                        // Scroll autom√°tico en m√≥viles al bot√≥n activo
                        if (window.innerWidth <= 768) {
                            btn.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'nearest',
                                inline: 'center'
                            });
                        }
                    }
                });
            }
            
            // Mostrar contador de resultados
            updateResultsCounter(visibleCount, filterComboId);
        }
        
        // Funci√≥n para actualizar contador de resultados
        function updateResultsCounter(count, filterType) {
            const existingCounter = document.querySelector('.results-counter');
            if (existingCounter) {
                existingCounter.remove();
            }
            
            const counter = document.createElement('div');
            counter.className = 'results-counter alert alert-info mt-2 mb-3';
            counter.innerHTML = `
                <i class="bi bi-info-circle"></i> 
                <strong>${count}</strong> ${count === 1 ? 'resultado encontrado' : 'resultados encontrados'}
                ${filterType !== 'all' ? ' para la combinaci√≥n seleccionada' : ''}
            `;
            
            const offersList = document.getElementById('offers-list');
            if (offersList && offersList.parentNode) {
                offersList.parentNode.insertBefore(counter, offersList);
            }
        }
        
        // Funci√≥n para formatear fecha en formato d√≠a/mes/a√±o
        function formatDateDMY(dateStr) {
            if (!dateStr) return '';
            
            // Si viene en formato YYYY-MM-DD
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const year = parts[0];
                const month = parts[1];
                const day = parts[2];
                return `${day}/${month}/${year}`;
            }
            
            // Si viene en formato DD/MM/YYYY ya est√° correcto
            if (dateStr.includes('/')) {
                return dateStr;
            }
            
            return dateStr; // Retornar como est√° si no se puede formatear
        }
        
        // Funci√≥n para formatear fecha compacta para m√≥viles (solo d√≠a/mes)
        function formatDateCompact(dateStr) {
            if (!dateStr) return '';
            
            // Si viene en formato YYYY-MM-DD
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const month = parts[1];
                const day = parts[2];
                return `${day}/${month}`;
            }
            
            // Si viene en formato DD/MM/YYYY extraer solo d√≠a/mes
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length >= 2) {
                    return `${parts[0]}/${parts[1]}`;
                }
            }
            
            return dateStr;
        }
        
        // Funci√≥n para inicializar funcionalidades m√≥viles
        function initializeMobileFeatures() {
            // Detectar si es dispositivo m√≥vil
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Agregar soporte t√°ctil para los filtros
                const filterContainer = document.querySelector('.btn-group');
                if (filterContainer) {
                    addTouchSupport(filterContainer);
                }
                
                // Agregar indicador visual de scroll
                addScrollIndicator();
            }
            
            // Listener para cambios de orientaci√≥n
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    updateFilterLayout();
                }, 100);
            });
        }
        
        // Funci√≥n para agregar soporte t√°ctil
        function addTouchSupport(container) {
            let isScrolling = false;
            let startX = 0;
            let scrollLeft = 0;
            
            container.addEventListener('touchstart', function(e) {
                isScrolling = true;
                startX = e.touches[0].pageX - container.offsetLeft;
                scrollLeft = container.scrollLeft;
                container.style.cursor = 'grabbing';
            }, { passive: true });
            
            container.addEventListener('touchmove', function(e) {
                if (!isScrolling) return;
                e.preventDefault();
                const x = e.touches[0].pageX - container.offsetLeft;
                const walk = (x - startX) * 2;
                container.scrollLeft = scrollLeft - walk;
            });
            
            container.addEventListener('touchend', function() {
                isScrolling = false;
                container.style.cursor = 'grab';
            });
        }
        
        // Funci√≥n para agregar indicador de scroll
        function addScrollIndicator() {
            const filterContainer = document.querySelector('.btn-group');
            if (!filterContainer) return;
            
            const indicator = document.createElement('div');
            indicator.className = 'scroll-indicator';
            indicator.innerHTML = '<i class="bi bi-chevron-right"></i>';
            indicator.style.cssText = `
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(25, 118, 210, 0.8);
                color: white;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                animation: pulse 2s infinite;
                z-index: 10;
            `;
            
            filterContainer.parentElement.style.position = 'relative';
            filterContainer.parentElement.appendChild(indicator);
            
            // Ocultar indicador despu√©s de primer scroll
            filterContainer.addEventListener('scroll', function() {
                indicator.style.display = 'none';
            }, { once: true });
        }
        
        // Funci√≥n para actualizar layout de filtros
        function updateFilterLayout() {
            const filterContainer = document.querySelector('.btn-group');
            if (!filterContainer) return;
            
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                filterContainer.style.justifyContent = 'flex-start';
                filterContainer.style.flexWrap = 'nowrap';
            } else {
                filterContainer.style.justifyContent = 'center';
                filterContainer.style.flexWrap = 'wrap';
            }
        }
        
        // Inicializar funcionalidades m√≥viles cuando se cargan los datos
        function initializeApp() {
            initializeMobileFeatures();
            // Cargar autom√°ticamente los vuelos de stopover al iniciar
            setTimeout(() => {
                console.log('üöÄ Cargando autom√°ticamente vuelos de stopover...');
                fetchOffers();
            }, 1000); // Delay de 1 segundo para que se inicialice todo correctamente
        }
        
        // üß™ FUNCI√ìN DE PRUEBA PARA VERIFICAR ROUTE GENERATION
        function testRouteGeneration() {
            console.log('\nüß™üß™üß™ INICIANDO PRUEBAS ESPEC√çFICAS DE ROUTE GENERATION üß™üß™üß™');
            
            // Funci√≥n auxiliar para formatear fecha
            function formatDateForRoute(dateStr) {
                if (!dateStr) return '';
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    return `${parts[2]}/${parts[1]}`;
                }
                return dateStr;
            }
            
            // Test Case 1: QUITO - Stopover de REGRESO en Panam√°
            console.log('\nüß™ TEST CASE 1: QUITO - Stopover de REGRESO');
            console.log('üìã Datos esperados:');
            console.log('   LIM ‚Üí UIO (11/02)');
            console.log('   UIO ‚Üí PTY (11/02)');  
            console.log('   PTY ‚Üí LIM (18/02)');
            
            // Simular l√≥gica de fallback para Quito
            const quitoCity = 'Quito';
            const quitoStopover = 'Stopover de regreso en Panam√°';
            const quitoSearchDate = '2026-02-11';
            const quitoReturnDate = '2026-02-18';
            
            const quitoCityCode = 'UIO';
            const quitoOutboundDate = formatDateForRoute(quitoSearchDate);
            const quitoReturnFormatted = formatDateForRoute(quitoReturnDate);
            const quitoIsReturnStopover = quitoStopover.toLowerCase().includes('regreso');
            
            let quitoRoute;
            if (quitoIsReturnStopover) {
                quitoRoute = `LIM ‚Üí ${quitoCityCode} (${quitoOutboundDate})<br>${quitoCityCode} ‚Üí PTY (${quitoOutboundDate})<br>PTY ‚Üí LIM (${quitoReturnFormatted})`;
            }
            
            console.log('üéØ RESULTADO QUITO:', quitoRoute);
            console.log('‚úÖ ¬øCoincide con lo esperado? Verificar manualmente');
            
            // Test Case 2: MEDELL√çN - Stopover de IDA en Panam√°  
            console.log('\nüß™ TEST CASE 2: MEDELL√çN - Stopover de IDA');
            console.log('üìã Datos esperados:');
            console.log('   LIM ‚Üí PTY (11/02)');
            console.log('   PTY ‚Üí MDE (18/02)');
            console.log('   MDE ‚Üí LIM (18/02)');
            
            // Simular l√≥gica de fallback para Medell√≠n
            const medellinCity = 'Medell√≠n';
            const medellinStopover = 'Stopover de ida en Panam√°';
            const medellinSearchDate = '2026-02-11';
            const medellinReturnDate = '2026-02-18';
            
            const medellinCityCode = 'MDE';
            const medellinOutboundDate = formatDateForRoute(medellinSearchDate);
            const medellinReturnFormatted = formatDateForRoute(medellinReturnDate);
            const medellinIsOutboundStopover = medellinStopover.toLowerCase().includes('ida');
            
            let medellinRoute;
            if (medellinIsOutboundStopover) {
                medellinRoute = `LIM ‚Üí PTY (${medellinOutboundDate})<br>PTY ‚Üí ${medellinCityCode} (${medellinReturnFormatted})<br>${medellinCityCode} ‚Üí LIM (${medellinReturnFormatted})`;
            }
            
            console.log('üéØ RESULTADO MEDELL√çN:', medellinRoute);
            console.log('‚úÖ ¬øCoincide con lo esperado? Verificar manualmente');
            
            // Test Case 3: Verificaci√≥n de c√≥digos de ciudad
            console.log('\nüß™ TEST CASE 3: VERIFICACI√ìN DE C√ìDIGOS DE CIUDAD');
            
            const cities = ['Quito', 'Medell√≠n', 'Cali', 'Cartagena', 'Bogot√°'];
            const expectedCodes = ['UIO', 'MDE', 'CLO', 'CTG', 'BOG'];
            
            cities.forEach((city, index) => {
                const cityCode = city === 'Quito' ? 'UIO' : 
                               city === 'Medell√≠n' ? 'MDE' : 
                               city === 'Cali' ? 'CLO' : 
                               city === 'Cartagena' ? 'CTG' : 
                               city === 'Bogot√°' ? 'BOG' : 
                               city.substring(0, 3).toUpperCase();
                
                console.log(`   ${city} ‚Üí ${cityCode} (esperado: ${expectedCodes[index]})`);
                console.log(`   ‚úÖ ${cityCode === expectedCodes[index] ? 'CORRECTO' : 'ERROR'}`);
            });
            
            console.log('\nüß™üß™üß™ FIN DE PRUEBAS ESPEC√çFICAS üß™üß™üß™');
        }
        
        // Agregar bot√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            
            // Tambi√©n agregar una funci√≥n global para pruebas manuales
            window.debugRouteGeneration = testRouteGeneration;
            window.testRealData = function() {
                console.log('üîç Iniciando b√∫squeda real para obtener datos de la API...');
                fetchOffers();
            };
            
            console.log('üõ†Ô∏è FUNCIONES DE DEBUG DISPONIBLES:');
            console.log('   - window.debugRouteGeneration() - Prueba con datos simulados');
            console.log('   - window.testRealData() - Ejecuta b√∫squeda real de ofertas');
            
            // Ejecutar pruebas autom√°ticamente al cargar
            setTimeout(() => {
                console.log('\nü§ñ EJECUTANDO PRUEBAS AUTOM√ÅTICAS AL CARGAR LA P√ÅGINA...');
                testRouteGeneration();
            }, 1000);
            
            // ========================================
            // FUNCIONALIDAD DEL MEN√ö Y MODO OSCURO
            // ========================================
            
            // Configurar modo oscuro al cargar la p√°gina
            function initTheme() {
                // FORZAR MODO LIGHT POR DEFECTO (STOPOVER)
                const savedTheme = 'light'; // Siempre empezar en modo light (stopover)
                localStorage.setItem('theme', 'light'); // Asegurar que se guarde como light
                document.documentElement.setAttribute('data-theme', savedTheme);
                
                const normalBtn = document.getElementById('normalMode');
                const darkBtn = document.getElementById('darkMode');
                
                // Siempre activar modo light por defecto
                if (darkBtn) darkBtn.classList.remove('active');
                if (normalBtn) normalBtn.classList.add('active');
                updateUIForStopover();
            }
            
            // Toggle del modo oscuro
            function toggleTheme(mode) {
                const normalBtn = document.getElementById('normalMode');
                const darkBtn = document.getElementById('darkMode');
                
                if (mode === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                    normalBtn.classList.remove('active');
                    darkBtn.classList.add('active');
                    updateUIForDirectFlights();
                    
                    // Verificar cache de Redis antes de llamar APIs
                    checkRedisAndLoadDirectFlights();
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    localStorage.setItem('theme', 'light');
                    darkBtn.classList.remove('active');
                    normalBtn.classList.add('active');
                    updateUIForStopover();
                    
                    // Verificar cache de Redis antes de llamar APIs
                    checkRedisAndLoadStopoverFlights();
                }
            }
            
            // Funci√≥n para actualizar UI para vuelos directos (modo oscuro)
            function updateUIForDirectFlights() {
                console.log('üåô Actualizando UI para vuelos directos');
                
                const headerTitle = document.querySelector('.header-title');
                
                if (headerTitle) {
                    headerTitle.innerHTML = `
                        <i class="bi bi-airplane-engines"></i> MMM - Congreso Centroamericano 2026 - Vuelos Directos - Copa Airlines<br>
                        <small class="text-muted" style="font-size: 0.6em;">12 Combinaciones de Vuelos Directos LIM-PTY-LIM</small>
                    `;
                }
                
                // Solo limpiar resultados previos, no ejecutar autom√°ticamente las APIs
                clearPreviousResults();
            }
            
            // Funci√≥n para actualizar UI para stopover (modo normal)
            function updateUIForStopover() {
                console.log('‚òÄÔ∏è Actualizando UI para stopover');
                
                const headerTitle = document.querySelector('.header-title');
                
                if (headerTitle) {
                    headerTitle.innerHTML = `
                        <i class="bi bi-airplane-engines"></i> MMM - Congreso Centroamericano 2026 - Copa Airlines<br>
                        <small class="text-muted" style="font-size: 0.6em;">90 Combinaciones de Ciudades (Ida/Regreso con Stopover en Panam√°)</small>
                    `;
                }
                
                // Limpiar resultados previos pero no ocultar elementos si ya tienen datos v√°lidos
                clearPreviousResults();
            }
            
            // Funci√≥n para limpiar resultados previos
            function clearPreviousResults() {
                const globalCheapestInfo = document.getElementById('global-cheapest-info');
                const summaryStats = document.getElementById('summary-stats');
                const dateTabs = document.getElementById('date-tabs');
                const dateContents = document.getElementById('date-contents');
                const errorDiv = document.getElementById('error');
                
                // Solo limpiar contenido HTML, no ocultar elementos que podr√≠an tener datos v√°lidos
                if (dateTabs) {
                    dateTabs.innerHTML = '';
                }
                if (dateContents) dateContents.innerHTML = '';
                if (errorDiv) errorDiv.style.display = 'none';
                
                console.log('üßπ Contenido previo limpiado, elementos listos para nuevos datos');
            }
            
            // Event listeners para los botones del men√∫
            document.getElementById('normalMode').addEventListener('click', () => {
                toggleTheme('light');
            });
            
            document.getElementById('darkMode').addEventListener('click', () => {
                toggleTheme('dark');
            });
            
            // Inicializar tema al cargar
            initTheme();

                // Sesi√≥n: bloquear y oscurecer tras 10 minutos con bot√≥n para refrescar
                function setupSessionTimeout() {
                    const overlay = document.getElementById('session-overlay');
                    const btn = document.getElementById('session-refresh-btn');
                    if (!overlay || !btn) return;
                    const showOverlay = () => {
                        overlay.style.display = 'flex';
                        overlay.setAttribute('aria-hidden', 'false');
                        document.body.style.overflow = 'hidden';
                    };
                    btn.addEventListener('click', () => {
                        window.location.reload();
                    });
                    // 10 minutos = 600000 ms
                    setTimeout(showOverlay, 10 * 60 * 1000);
                }
                setupSessionTimeout();

                // Asegurar formateador AM/PM en √°mbito global para usarlo en el modal
                if (typeof window.formatTimeAMPM !== 'function') {
                    window.formatTimeAMPM = function(time24) {
                        if (!time24 || typeof time24 !== 'string') return time24;
                        const match = time24.match(/^(\d{1,2}):(\d{2})/);
                        if (!match) return time24;
                        const hour = parseInt(match[1], 10);
                        const minutes = match[2];
                        const ampm = hour >= 12 ? 'PM' : 'AM';
                        const hour12 = hour % 12 || 12;
                        return `${hour12}:${minutes} ${ampm}`;
                    };
                }

                // Delegaci√≥n de eventos para Detalle de vuelo
                document.addEventListener('click', function(e) {
                    const btn = e.target.closest('.btn-flight-detail');
                    if (!btn) return;
                    const raw = btn.getAttribute('data-offer');
                    if (!raw) return;
                    let payload;
                    try { payload = JSON.parse(raw.replace(/&apos;/g, "'")); } catch { payload = null; }
                    if (!payload) return;

                    const contentEl = document.getElementById('flight-detail-content');
                    if (!contentEl) return;

                    // Construir detalle de segmentos
                    // Utilidades para banderas y logos (se reutilizan globales airportToCountry / countryFlagUrl)
                    const airlineLogoUrl = (carrier) => {
                        const map = { CM: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/11/Copa_Airlines_logo.svg/128px-Copa_Airlines_logo.svg.png' };
                        return map[carrier] || null;
                    };

                    const buildSegHtml = (seg, opts = {}) => {
                        const { isFirst = false, isLast = false } = opts;
                        const depDate = seg.departure?.date || seg.date || seg.departureDate || 'N/A';
                        const depTime = seg.departure?.time || seg.departure || seg.departureTime || 'N/A';
                        const arrDate = seg.arrival?.date || seg.date || seg.arrivalDate || 'N/A';
                        const arrTime = seg.arrival?.time || seg.arrival || seg.arrivalTime || 'N/A';
                        const from = seg.origin?.code || seg.from || seg.departure?.airportCode || 'N/A';
                        const to = seg.destination?.code || seg.to || seg.arrival?.airportCode || 'N/A';
                        const fromDisplay = (typeof getAirportDisplayName === 'function') ? getAirportDisplayName(from) : `${from} (${from})`;
                        const toDisplay = (typeof getAirportDisplayName === 'function') ? getAirportDisplayName(to) : `${to} (${to})`;
                        const duration = seg.duration || seg.journeyTime || seg.elapsedTime || '‚Äî';
                        const flightNo = seg.flightNumber || seg.marketingCarrier?.flightNumber || (seg.carrierCode ? `${seg.carrierCode}${seg.flightNumber || ''}` : '');
                        const aircraft = seg.aircraft || seg.aircraftName || '';
                        const operatedBy = seg.operatedBy || seg.operatingCarrier || 'Copa Airlines';
                        const fareClass = seg.class || seg.fareFamily || '';
                        const depFlag = countryFlagUrl(airportToCountry(from));
                        const arrFlag = countryFlagUrl(airportToCountry(to));
                        const carrierCode = (seg.marketingCarrier?.code || seg.carrierCode || 'CM');
                        const logo = airlineLogoUrl(carrierCode);
                        const depTimeDisp = typeof formatTimeAMPM === 'function' ? formatTimeAMPM(depTime) : depTime;
                        const arrTimeDisp = typeof formatTimeAMPM === 'function' ? formatTimeAMPM(arrTime) : arrTime;
                        let badgeLabel = null;
                        if (isFirst && !isLast) {
                            badgeLabel = 'Vuelo Inicial';
                        } else if (isLast) {
                            // Cuando es el √∫ltimo (incluye el caso de √∫nico tramo: isFirst && isLast)
                            badgeLabel = 'Vuelo Final';
                        }
                        const badgeHtml = badgeLabel ? `<span class="badge ${badgeLabel === 'Vuelo Final' ? 'bg-success' : 'bg-primary'} ms-2">${badgeLabel}</span>` : '';
                        return `
                            <div class="fd-seg">
                                <div class="fd-row-journey">
                                    <div class="fd-side">
                                        <div class="fd-time">${depTimeDisp}</div>
                                        <div class="fd-city">${depFlag ? `<img class=\"flag-icon\" src=\"${depFlag}\" alt=\"\">` : ''}${fromDisplay}</div>
                                        <div class="fd-date">${depDate}</div>
                                    </div>
                                    <div class="fd-mid"></div>
                                    <div class="fd-side" style="text-align:right;">
                                        <div class="fd-time">${arrTimeDisp}</div>
                                        <div class="fd-city">${toDisplay}${arrFlag ? ` <img class=\"flag-icon\" src=\"${arrFlag}\" alt=\"\">` : ''}</div>
                                        <div class="fd-date">${arrDate}</div>
                                    </div>
                                </div>
                                <div class="fd-details">
                                    <div>${logo ? `<img src=\"${logo}\" alt=\"\" style=\"height:16px; margin-right:6px;\">` : ''}${flightNo ? `Vuelo ${flightNo}` : ''}${flightNo && duration && duration !== '‚Äî' ? ' ¬∑ ' : ''}${duration && duration !== '‚Äî' ? `Duraci√≥n: ${duration}` : ''} ${badgeHtml}</div>
                                    <div>${[aircraft ? `Modelo: ${aircraft}` : '', operatedBy ? `Operado por ${operatedBy}` : '', fareClass ? `Clase: ${fareClass}` : ''].filter(Boolean).join(' ¬∑ ')}</div>
                                </div>
                            </div>`;
                    };

                    const toLocalDateTime = (dateStr, timeStr) => {
                        if (!dateStr || !timeStr) return null;
                        const [y, m, d] = dateStr.split('-').map(Number);
                        const [hh, mm] = timeStr.split(':').map(Number);
                        return new Date(y, m - 1, d, hh, mm, 0, 0);
                    };
                    const diffMinutes = (a,b) => (a && b) ? Math.round((b - a)/60000) : null;
                    const MAX_LAYOVER_MIN = 24 * 60; // no considerar "escalas" de m√°s de 24h
                    const fmtLay = (m) => m==null ? '' : (m<60 ? `${m}m` : `${Math.floor(m/60)}h ${m%60}m`);

                    let segHtml = '';
                    // 1) Segments ya listos
                    if (payload.segments && Array.isArray(payload.segments) && payload.segments.length) {
                        segHtml += '<h6 class="mb-2">Itinerario</h6>';
                        payload.segments.forEach((s, idx) => {
                            segHtml += buildSegHtml(s, { isFirst: idx === 0, isLast: idx === (payload.segments.length - 1) });
                            // Mostrar layover solo cuando es una conexi√≥n real (mismo aeropuerto) y duraci√≥n razonable
                            const next = payload.segments[idx+1];
                            if (next) {
                                const sTo = s.to || s.destination?.code || s.arrival?.airportCode;
                                const nFrom = next.from || next.origin?.code || next.departure?.airportCode;
                                if (sTo && nFrom && sTo === nFrom) {
                                    const arrDate = s.arrival?.date || s.date || s.arrivalDate;
                                    const arrTime = s.arrival?.time || s.arrival || s.arrivalTime;
                                    const depDate = next.departure?.date || next.date || next.departureDate;
                                    const depTime = next.departure?.time || next.departure || next.departureTime;
                                    const a = toLocalDateTime(arrDate, arrTime);
                                    const b = toLocalDateTime(depDate, depTime);
                                    const mins = diffMinutes(a,b);
                                    if (mins != null && mins > 0 && mins <= MAX_LAYOVER_MIN) {
                                        const hubCode = sTo;
                                        const hub = (typeof getAirportDisplayName === 'function') ? getAirportDisplayName(hubCode) : `${hubCode} (${hubCode})`;
                                        segHtml += `<div class=\"fd-layover\"><i>Escala en ${hub}</i> (${fmtLay(mins)})</div>`;
                                    }
                                }
                            }
                        });
                    }
                    // 2) originDestinations enriquecidos desde backend
                    if ((!segHtml || segHtml.trim()==='') && payload.originDestinations && Array.isArray(payload.originDestinations)) {
                        segHtml += '<h6 class="mb-2">Itinerario</h6>';
                        // Aplanar todos los tramos en un solo arreglo y ordenarlos globalmente
                        const flat = [];
                        payload.originDestinations.forEach((od, odIndex) => {
                            if (od.solutions && od.solutions.length && od.solutions[0].flights) {
                                od.solutions[0].flights.forEach((f) => {
                                    flat.push({
                                        from: f.departure?.airportCode,
                                        to: f.arrival?.airportCode,
                                        departure: f.departure?.flightTime,
                                        arrival: f.arrival?.flightTime,
                                        departureDate: f.departure?.flightDate,
                                        arrivalDate: f.arrival?.flightDate,
                                        flightNumber: f.marketingCarrier?.flightNumber,
                                        duration: f.journeyTime,
                                        carrierCode: f.marketingCarrier?.code,
                                        odIndex
                                    });
                                });
                            } else if (od.departure && od.arrival) {
                                flat.push({
                                    from: od.departure.airportCode,
                                    to: od.arrival.airportCode,
                                    departure: od.departure.time || '',
                                    arrival: od.arrival.time || '',
                                    departureDate: od.departure.date || '',
                                    arrivalDate: od.arrival.date || '',
                                    odIndex
                                });
                            }
                        });

                        // Ordenar por fecha/hora de salida ascendente para etiquetar correctamente inicial/final
                        flat.sort((a, b) => {
                            const da = toLocalDateTime(a.departureDate || a.date, a.departure);
                            const db = toLocalDateTime(b.departureDate || b.date, b.departure);
                            return (da?.getTime?.() || 0) - (db?.getTime?.() || 0);
                        });

                        flat.forEach((seg, idx) => {
                            segHtml += buildSegHtml(seg, { isFirst: idx === 0, isLast: idx === (flat.length - 1) });
                            // Escala solo si pertenece al mismo originDestination, mismo aeropuerto y duraci√≥n razonable
                            const next = flat[idx + 1];
                            if (next && seg.odIndex === next.odIndex && seg.to && next.from && seg.to === next.from) {
                                const a = toLocalDateTime(seg.arrivalDate || seg.departureDate, seg.arrival || seg.departure);
                                const b = toLocalDateTime(next.departureDate || next.date, next.departure);
                                const mins = diffMinutes(a, b);
                                if (mins != null && mins > 0 && mins <= MAX_LAYOVER_MIN) {
                                    const hubCode = seg.to;
                                    const hub = (typeof getAirportDisplayName === 'function') ? getAirportDisplayName(hubCode) : `${hubCode} (${hubCode})`;
                                    segHtml += `<div class=\"fd-layover\"><i>Escala en ${hub}</i> (${fmtLay(mins)})</div>`;
                                }
                            }
                        });
                    }

                    if (!segHtml) {
                        segHtml = '<div class="text-muted">No hay detalles de segmentos disponibles para esta oferta.</div>';
                    }

                    // Solo segmentos: remover cabecera y badges
                    contentEl.innerHTML = `${segHtml}`;

                    // Mostrar modal (Bootstrap 5)
                    let modalEl = document.getElementById('flightDetailModal');
                    if (modalEl) {
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                    }
                });
        });
    </script>

    <style>
        /* Estilos del modal Detalle de vuelo */
        .fd-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .fd-route { font-weight: 600; font-size: 1rem; }
        .fd-meta { color: #6c757d; font-size: .9rem; }
        .fd-badges { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0 15px; }
        .fd-badge { background: #eef5ff; color: #0d6efd; border: 1px solid #cfe2ff; border-radius: 999px; padding: 4px 10px; font-size: .8rem; }

        .fd-seg { border: 1px solid #e6e9ef; border-radius: 10px; padding: 12px; margin-bottom: 12px; background: #fff; }
        .fd-row { display: grid; grid-template-columns: 120px 1fr 180px; gap: 12px; align-items: center; }
        .fd-col-time { color: #0d6efd; font-weight: 600; }
        .fd-col-time small { display: block; color: #6c757d; font-weight: 400; }
        .fd-col-route { font-weight: 600; }
        .fd-col-extra { text-align: right; color: #6c757d; font-size: .85rem; }
        .fd-divider { border-top: 1px solid #eaedf3; margin: 8px 0 10px; }
        .fd-sub { color: #6c757d; font-size: .85rem; }

        .fd-layover { display: flex; align-items: center; gap: 8px; color: #0d6efd; background: #f1f8ff; border: 1px dashed #b6dcff; border-radius: 8px; padding: 6px 10px; margin: 8px 0; font-size: .9rem; }
        .fd-layover i { font-style: normal; }

            /* Nueva disposici√≥n de tramo: izquierda (origen) ‚Üí centro (l√≠nea/avi√≥n) ‚Üí derecha (llegada) */
            .fd-row-journey { display: grid; grid-template-columns: 1fr 120px 1fr; gap: 14px; align-items: center; }
            .fd-side .fd-time { color: #0d6efd; font-weight: 700; font-size: 1.05rem; line-height: 1; }
            .fd-side .fd-city { font-weight: 600; margin-top: 4px; }
            .fd-side .fd-date { color: #6c757d; font-size: .85rem; }
                .fd-mid { position: relative; height: 4px; background: #e9eef8; border-radius: 999px; }
                .fd-mid:before { content: ''; }
            .fd-details { display: flex; justify-content: space-between; gap: 8px; color: #6c757d; font-size: .85rem; margin-top: 10px; }
                .flag-icon { width: 20px; height: 15px; object-fit: cover; border-radius: 2px; box-shadow: 0 0 0 1px rgba(0,0,0,.05); vertical-align: -2px; margin-right: 6px; }

    /* Overlay de sesi√≥n expirada (10 min) */
    .session-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.65); display: none; align-items: center; justify-content: center; z-index: 5000; backdrop-filter: blur(1px); }
    .session-box { background: #ffffff; color: #212529; border-radius: 12px; padding: 22px 24px; width: min(92vw, 420px); box-shadow: 0 10px 30px rgba(0,0,0,.25); text-align: center; }
    .session-box h5 { margin-bottom: 8px; font-weight: 700; }
    .session-box p { margin: 0 0 14px; color: #6c757d; }
    [data-theme="dark"] .session-box { background: #23272f; color: #e9ecef; }
    [data-theme="dark"] .session-box p { color: #adb5bd; }

        @media (max-width: 576px) {
            .fd-row { grid-template-columns: 1fr; text-align: left; }
            .fd-col-extra { text-align: left; margin-top: 6px; }
                .fd-row-journey { grid-template-columns: 1fr; gap: 8px; }
                .fd-mid { height: 2px; }
                .fd-details { flex-direction: column; align-items: flex-start; }
        }
    </style>

    <!-- Modal Detalle de Vuelo -->
    <!-- Overlay de sesi√≥n expirada -->
    <div id="session-overlay" class="session-overlay" aria-hidden="true">
        <div class="session-box">
            <h5>Tu sesi√≥n necesita actualizarse.</h5>
            <p>Vuelve a cargar la p√°gina para obtener las ofertas m√°s recientes.</p>
            <button id="session-refresh-btn" class="btn btn-primary">Actualizar</button>
        </div>
    </div>

    <div class="modal fade" id="flightDetailModal" tabindex="-1" aria-labelledby="flightDetailLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="flightDetailLabel">Detalle de vuelo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div id="flight-detail-content">
                        <!-- contenido din√°mico -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
        </div>

    </body>
    </html>