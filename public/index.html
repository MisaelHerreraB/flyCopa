<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMM - Congreso Centroamericano 2026 - Comparador de Ofertas de Vuelos - Copa Airlines</title>
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header-title {
            color: #0056b3;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 30px;
            padding: 0 15px;
        }
        .btn-primary {
            background-color: #0056b3;
            border-color: #0056b3;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 12px 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #007bff;
            border-color: #007bff;
            transform: translateY(-2px);
        }
        .btn-primary:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }
        .loading-progress {
            display: none;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
        }
        .progress {
            height: 1.5rem;
            background-color: #e9ecef;
            border-radius: 0.375rem;
        }
        .progress-bar {
            background-color: #0056b3 !important;
            transition: width 0.6s ease;
        }
        .error-alert {
            display: none;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
        }
        .cheapest-card {
            background-color: #d4edda !important;
            border-left: 5px solid #28a745 !important;
            margin: 15px auto;
            max-width: 700px;
        }
        .global-cheapest-card {
            background-color: #ffe5b4 !important;
            border-left: 5px solid #ffca2c !important;
            margin: 20px auto;
            max-width: 800px;
            font-size: 1.1em;
            font-weight: bold;
        }
        .offer-image {
            max-width: 100%;
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .right-offer-column {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: flex-start;
            min-width: 500px;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 20px 20px 20px 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        .right-offer-column .price {
            font-size: 2.5rem;
            color: #0056b3;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .right-offer-column .class {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 12px;
        }
        .right-offer-column .select-btn {
            width: 100%;
            margin-bottom: 8px;
        }
        .right-offer-column .details-link {
            color: #1976d2;
            font-size: 1rem;
            text-decoration: underline;
            cursor: pointer;
            margin-bottom: 4px;
        }
        @media (max-width: 900px) {
            .right-offer-column {
                min-width: 180px;
                max-width: 100%;
                width: 100%;
                padding: 10px 5px;
            }
            .right-offer-column .price {
                font-size: 1.5rem;
            }
        }
        .pre-formatted {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.4;
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .btn-primary {
                font-size: 1rem;
                padding: 10px 15px;
            }
            .cheapest-card, .global-cheapest-card {
                font-size: 0.9em;
                margin: 15px 10px;
            }
            .offer-image {
                max-width: 100%;
            }
            .header-title {
                font-size: 1.5rem;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast de confirmaci√≥n de copiado -->
    <div id="copy-toast" style="display:none;position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#ffc107;color:#333;padding:12px 32px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15);z-index:9999;font-weight:bold;">
        Mensaje copiado al portapapeles
    </div>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-12 text-center">
                <h1 class="header-title">
                    <i class="bi bi-airplane-engines"></i> MMM - Congreso Centroamericano 2026 - Comparador de Ofertas de Vuelos - Copa Airlines
                </h1>
            </div>
        </div>
            <div class="row justify-content-center">
                <div class="col-12 col-md-8 col-lg-6">
                    <button class="btn btn-primary btn-lg w-100" id="fetch-button" style="display:none">
                        <i class="bi bi-airplane-fill"></i> ¬°Buscar Ofertas de Vuelos Ahora!
                    </button>
                    <button class="btn btn-warning btn-lg w-100 mt-2" id="retry-button" style="display:none">
                        <i class="bi bi-arrow-clockwise"></i> Reintentar B√∫squeda en Ciudades Pendientes
                    </button>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="loading-progress" id="loading">
                <div class="progress" role="progressbar" aria-label="Progreso de b√∫squeda" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-primary" style="width: 0%;" id="progress-bar"></div>
                </div>
                <p class="mt-2 text-center" id="progress-text">Buscando las mejores ofertas para Medell√≠n, Quito, Cali, Bogot√°, Cartagena (stopover de ida y regreso en Panam√°)... Progreso: 0%</p>
            </div>
            <!-- Error Alert -->
            <div class="alert alert-danger error-alert" role="alert" id="error">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span id="error-message"></span>
            </div>
            <!-- Global Cheapest Offer -->
            <div class="row justify-content-center" id="global-cheapest-section">
                <div class="col-12">
                    <div class="card global-cheapest-card" id="global-cheapest-info" style="display: none;">
                        <div class="card-body">
                            <div class="pre-formatted" id="cheapest-message">
                                üåç‚úàÔ∏è ¬°Atenci√≥n pastores y hermanos!
                                üî• Aprovechen esta s√∫per oferta üî•
                                üëâ Pasajes stopover:
                                [ITINERARIO]
                                [STOPOVER_TYPE]
                                üíµ Todo a [PRECIO] USD üíµ
                                ‚ú® ¬°No dejen pasar esta oportunidad! ‚ú®
                            </div>
                            <button class="btn btn-warning mt-2" onclick="copyCheapestMessage()">
                                <i class="bi bi-clipboard"></i> Copiar mensaje
                            </button>
                        </div>
                    </div>
                    <!-- Contenedor para la imagen generada -->
                    <div class="text-center" id="offer-image-container" style="display: none;">
                        <div class="right-offer-column">
                            <img src="" alt="Oferta Visual" class="offer-image" id="offer-image">
                        </div>
                    </div>
                </div>
            </div>
            <!-- Individual Cheapest Offers -->
            <div class="row justify-content-center" id="individual-offers-section">
                <div class="col-12">
                    <!-- Itinerario 1: Medell√≠n (stopover de ida) -->
                    <div class="card cheapest-card" id="cheapest-info1" style="display: none;"></div>
                    <!-- Itinerario 2: Quito (stopover de ida) -->
                    <div class="card cheapest-card" id="cheapest-info2" style="display: none;"></div>
                    <!-- Itinerario 3: Cali (stopover de ida) -->
                    <div class="card cheapest-card" id="cheapest-info3" style="display: none;"></div>
                    <!-- Itinerario 4: Bogot√° (stopover de ida) -->
                    <div class="card cheapest-card" id="cheapest-info4" style="display: none;"></div>
                    <!-- Itinerario 5: Cartagena (stopover de ida) -->
                    <div class="card cheapest-card" id="cheapest-info5" style="display: none;"></div>
                    <!-- Itinerario 6: Medell√≠n (stopover de regreso) -->
                    <div class="card cheapest-card" id="cheapest-info6" style="display: none;"></div>
                    <!-- Itinerario 7: Quito (stopover de regreso) -->
                    <div class="card cheapest-card" id="cheapest-info7" style="display: none;"></div>
                    <!-- Itinerario 8: Cali (stopover de regreso) -->
                    <div class="card cheapest-card" id="cheapest-info8" style="display: none;"></div>
                    <!-- Itinerario 9: Bogot√° (stopover de regreso) -->
                    <div class="card cheapest-card" id="cheapest-info9" style="display: none;"></div>
                    <!-- Itinerario 10: Cartagena (stopover de regreso) -->
                    <div class="card cheapest-card" id="cheapest-info10" style="display: none;"></div>
                </div>
            </div>
        </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        function copyCheapestMessage() {
            const msg = document.getElementById('cheapest-message');
            if (msg) {
                // Eliminar espacios extra y copiar solo el texto visible
                const text = msg.innerText.replace(/\n\s+/g, '\n').trim();
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showCopyToast();
                    })
                    .catch(() => {
                        showCopyToast('No se pudo copiar el mensaje', true);
                    });
            }
        }

        function showCopyToast(msg = 'Mensaje copiado al portapapeles', error = false) {
            const toast = document.getElementById('copy-toast');
            toast.textContent = msg;
            toast.style.background = error ? '#dc3545' : '#ffc107';
            toast.style.color = error ? '#fff' : '#333';
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 1800);
        }

        function showErrorToast(failedCities) {
            if (failedCities.length === 0) return;
            
            const toast = document.getElementById('copy-toast');
            toast.textContent = `B√∫squeda fall√≥ en: ${failedCities.join(', ')}`;
            toast.style.background = '#dc3545';
            toast.style.color = '#fff';
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar si hay ciudades pendientes al cargar
            const failedApis = localStorage.getItem('failedApis');
            if (failedApis) {
                const retryButton = document.getElementById('retry-button');
                retryButton.style.display = 'block';
                retryButton.addEventListener('click', () => {
                    localStorage.removeItem('failedApis'); // Limpiar para forzar nueva b√∫squeda
                    fetchOffers();
                });
            }
            fetchOffers();
        });
        async function fetchOffers() {
            const fetchButton = document.getElementById('fetch-button');
            const loading = document.getElementById('loading');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const errorDiv = document.getElementById('error');
            const globalCheapestInfo = document.getElementById('global-cheapest-info');
            const offerImageContainer = document.getElementById('offer-image-container');
            const offerImage = document.getElementById('offer-image');
            const cheapestInfo1 = document.getElementById('cheapest-info1');
            const cheapestInfo2 = document.getElementById('cheapest-info2');
            const cheapestInfo3 = document.getElementById('cheapest-info3');
            const cheapestInfo4 = document.getElementById('cheapest-info4');
            const cheapestInfo5 = document.getElementById('cheapest-info5');
            const cheapestInfo6 = document.getElementById('cheapest-info6');
            const cheapestInfo7 = document.getElementById('cheapest-info7');
            const cheapestInfo8 = document.getElementById('cheapest-info8');
            const cheapestInfo9 = document.getElementById('cheapest-info9');
            const cheapestInfo10 = document.getElementById('cheapest-info10');

            // Deshabilitar bot√≥n y cambiar texto solo si existe
            if (fetchButton) {
                fetchButton.disabled = true;
                fetchButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Buscando...';
            }

            // Mostrar barra de progreso
            loading.style.display = 'block';
            progressBar.style.width = '10%';
            progressText.textContent = 'Iniciando b√∫squeda de ofertas... Progreso: 10%';
            errorDiv.style.display = 'none';
            globalCheapestInfo.style.display = 'none';
            offerImageContainer.style.display = 'none';
            cheapestInfo1.style.display = 'none';
            cheapestInfo2.style.display = 'none';
            cheapestInfo3.style.display = 'none';
            cheapestInfo4.style.display = 'none';
            cheapestInfo5.style.display = 'none';
            cheapestInfo6.style.display = 'none';
            cheapestInfo7.style.display = 'none';
            cheapestInfo8.style.display = 'none';
            cheapestInfo9.style.display = 'none';
            cheapestInfo10.style.display = 'none';

            try {
                // Iniciar progreso en 10% (inicio de b√∫squeda)
                let progress = 10;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `Buscando ofertas en todas las ciudades... Progreso: ${progress}%`;
                
                const updateProgress = (newProgress) => {
                    progress = newProgress;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `Buscando ofertas en todas las ciudades... Progreso: ${Math.round(progress)}%`;
                };

                // Verificar si hay APIs fallidas previas para reintentar
                let apiUrl = '/api/offers';
                const failedApis = localStorage.getItem('failedApis');
                if (failedApis) {
                    const parsedFailed = JSON.parse(failedApis);
                    if (parsedFailed.length > 0) {
                        apiUrl += `?retry=${parsedFailed.join(',')}`;
                        console.log(`Reintentando b√∫squeda en ciudades: ${parsedFailed.join(', ')}`);
                        progressText.textContent = `Reintentando b√∫squeda en ciudades pendientes... Progreso: ${progress}%`;
                    }
                }
                
                const response = await fetch(apiUrl);
                updateProgress(50); // 50% al recibir respuesta
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                const data = await response.json();
                updateProgress(90); // 90% al procesar respuesta

                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Gestionar ciudades con b√∫squeda fallida
                if (data.failedApis && data.failedApis.length > 0) {
                    localStorage.setItem('failedApis', JSON.stringify(data.failedApis));
                    console.log(`Ciudades con b√∫squeda fallida: ${data.failedApis.join(', ')}`);
                    
                    // Mostrar error espec√≠fico cuando fallen algunas ciudades
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Fall√≥ la b√∫squeda con algunas ciudades`;
                    errorDiv.style.display = 'block';
                } else {
                    // Limpiar ciudades fallidas si todo est√° bien
                    localStorage.removeItem('failedApis');
                }

                // Progreso completado (100%)
                progress = 100;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `¬°B√∫squeda completada! Progreso: ${progress}%`;

                // Mostrar oferta m√°s barata global
                if (data.globalCheapest) {
                    // Construir segmentos de vuelo para la imagen
                    const segments = [];
                    if (data.globalCheapest.segments && Array.isArray(data.globalCheapest.segments)) {
                        data.globalCheapest.segments.forEach(seg => {
                            segments.push({
                                date: seg.date,
                                from: seg.from,
                                departure: seg.departure,
                                to: seg.to,
                                arrival: seg.arrival,
                                class: seg.class,
                                direct: seg.direct,
                                stops: seg.stops || '',
                                stopover: seg.stopover || ''
                            });
                        });
                    }

                    globalCheapestInfo.innerHTML = `
                        <div class="pre-formatted" id="cheapest-message">
üåç‚úàÔ∏è ¬°Atenci√≥n pastores y hermanos!
üî• Aprovechen esta s√∫per oferta üî•

üëâ Pasajes stopover:
‚úÖ Ida ‚úàÔ∏è ${data.globalCheapest.ida }
‚úÖ Vuelta ‚úàÔ∏è ${data.globalCheapest.vuelta }
${data.globalCheapest.stopoverType ? data.globalCheapest.stopoverType : ''}
üíµ Todo a ${data.globalCheapest.price} USD üíµ

‚ú® ¬°No dejen pasar esta oportunidad! ‚ú®
                        </div>
                        <button class="btn btn-warning mt-2" onclick="copyCheapestMessage()">
                            <i class="bi bi-clipboard"></i> Copiar mensaje
                        </button>
                    `;
                    globalCheapestInfo.style.display = 'block';
        function copyCheapestMessage() {
            const msg = document.getElementById('cheapest-message');
            if (msg) {
                // Convertir el HTML a texto plano respetando saltos y l√≠neas vac√≠as
                let html = msg.innerHTML;
                // Reemplazar <br> y etiquetas de bloque por saltos de l√≠nea
                html = html.replace(/<br\s*\/?>/gi, '\n');
                html = html.replace(/<div[^>]*>/gi, '\n').replace(/<\/div>/gi, '');
                html = html.replace(/<p[^>]*>/gi, '\n').replace(/<\/p>/gi, '');
                // Eliminar cualquier otra etiqueta HTML
                let text = html.replace(/<[^>]+>/g, '').trim();
                // Reemplazar m√∫ltiples saltos por doble salto para l√≠neas vac√≠as
                text = text.replace(/\n{2,}/g, '\n\n');
                navigator.clipboard.writeText(text)
                    .then(() => {
                        alert('Mensaje copiado al portapapeles');
                    })
                    .catch(() => {
                        alert('No se pudo copiar el mensaje');
                    });
            }
        }

                    // Generar imagen con segmentos
                    const imageData = {
                        price: data.globalCheapest.price,
                        segments: segments
                    };
                    const generatedImage = await generateOfferImage(imageData);
                    if (generatedImage) {
                        offerImage.src = generatedImage;
                        offerImageContainer.style.display = 'block';
                    }
                }

                // Recopilar ciudades con errores para mostrar en toast
                const failedCities = [];
                
                // Funci√≥n para agregar ciudad fallida a la lista
                const addFailedCity = (itinerary, cityName, stopoverType) => {
                    if (itinerary.error) {
                        failedCities.push(`${cityName}, stopover de ${stopoverType}`);
                    }
                };
                
                // Verificar errores en todos los itinerarios
                addFailedCity(data.itinerary1, 'Medell√≠n', 'ida');
                addFailedCity(data.itinerary2, 'Quito', 'ida');
                addFailedCity(data.itinerary3, 'Cali', 'ida');
                addFailedCity(data.itinerary4, 'Bogot√°', 'ida');
                addFailedCity(data.itinerary5, 'Cartagena', 'ida');
                addFailedCity(data.itinerary6, 'Medell√≠n', 'regreso');
                addFailedCity(data.itinerary7, 'Quito', 'regreso');
                addFailedCity(data.itinerary8, 'Cali', 'regreso');
                addFailedCity(data.itinerary9, 'Bogot√°', 'regreso');
                addFailedCity(data.itinerary10, 'Cartagena', 'regreso');
                
                // Mostrar toast con ciudades fallidas si las hay
                if (failedCities.length > 0) {
                    showErrorToast(failedCities);
                }

                // Mostrar ofertas m√°s baratas individuales (solo las exitosas)
                // Itinerario 1 (MDE, stopover de ida)
                if (data.itinerary1.cheapest) {
                    cheapestInfo1.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de ida (Medell√≠n):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Medell√≠n - Panam√° - Lima 
üíµ Todo a ${data.itinerary1.cheapest.price} USD üíµ
                    </div>`;
                    cheapestInfo1.style.display = 'block';
                }

                // Itinerario 2 (UIO, stopover de ida)
                if (data.itinerary2.cheapest) {
                    cheapestInfo2.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de ida (Quito):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Quito - Panam√° - Lima 
üíµ Todo a ${data.itinerary2.cheapest.price} USD üíµ
                    </div>`;
                    cheapestInfo2.style.display = 'block';
                }

                // Itinerario 3 (CLO, stopover de ida)
                if (data.itinerary3.cheapest) {
                    cheapestInfo3.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de ida (Cali):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Cali - Panam√° - Lima 
üíµ Todo a ${data.itinerary3.cheapest.price} USD üíµ
                    </div>`;
                    cheapestInfo3.style.display = 'block';
                }

                // Itinerario 4 (BOG, stopover de ida)
                if (data.itinerary4.cheapest) {
                    cheapestInfo4.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de ida (Bogot√°):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Bogot√° - Panam√° - Lima 
üíµ Todo a ${data.itinerary4.cheapest.price} USD üíµ
                    </div>`;
                    cheapestInfo4.style.display = 'block';
                }

                // Itinerario 5 (CTG, stopover de ida)
                if (data.itinerary5.cheapest) {
                    cheapestInfo5.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de ida (Cartagena):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Cartagena - Panam√° - Lima 
üíµ Todo a ${data.itinerary5.cheapest.price} USD üíµ
                    </div>`;
                    cheapestInfo5.style.display = 'block';
                }

                // Itinerario 6 (MDE, stopover de regreso)
                if (data.itinerary6.cheapest) {
                    cheapestInfo6.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de regreso (Medell√≠n):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√° - Medell√≠n - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Lima 
üíµ Todo a ${data.itinerary6.cheapest.price} USD
                    </div>`;
                    cheapestInfo6.style.display = 'block';
                }

                // Itinerario 7 (UIO, stopover de regreso)
                if (data.itinerary7.cheapest) {
                    cheapestInfo7.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de regreso (Quito):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√° - Quito - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Lima 
üíµ Todo a ${data.itinerary7.cheapest.price} USD
                    </div>`;
                    cheapestInfo7.style.display = 'block';
                }

                // Itinerario 8 (CLO, stopover de regreso)
                if (data.itinerary8.cheapest) {
                    cheapestInfo8.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de regreso (Cali):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√° - Cali - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Lima 
üíµ Todo a ${data.itinerary8.cheapest.price} USD
                    </div>`;
                    cheapestInfo8.style.display = 'block';
                }

                // Itinerario 9 (BOG, stopover de regreso)
                if (data.itinerary9.cheapest) {
                    cheapestInfo9.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de regreso (Bogot√°):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√° - Bogot√° - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Lima 
üíµ Todo a ${data.itinerary9.cheapest.price} USD
                    </div>`;
                    cheapestInfo9.style.display = 'block';
                }

                // Itinerario 10 (CTG, stopover de regreso)
                if (data.itinerary10.cheapest) {
                    cheapestInfo10.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de regreso (Cartagena):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√° - Cartagena - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Lima 
üíµ Todo a ${data.itinerary10.cheapest.price} USD
                    </div>`;
                    cheapestInfo10.style.display = 'block';
                }
            } catch (error) {
                errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${error.message}`;
                errorDiv.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                fetchButton.disabled = false;
                fetchButton.innerHTML = '<i class="bi bi-search"></i> Actualizar B√∫squeda';
                
                // Mostrar/ocultar bot√≥n de reintento seg√∫n si hay ciudades pendientes
                const retryButton = document.getElementById('retry-button');
                const failedApis = localStorage.getItem('failedApis');
                if (failedApis && JSON.parse(failedApis).length > 0) {
                    retryButton.style.display = 'block';
                    if (!retryButton.hasAttribute('data-listener')) {
                        retryButton.setAttribute('data-listener', 'true');
                        retryButton.addEventListener('click', () => {
                            localStorage.removeItem('failedApis');
                            fetchOffers();
                        });
                    }
                } else {
                    retryButton.style.display = 'none';
                }
            }
        }

        // Funci√≥n para generar la imagen basada en el dise√±o proporcionado
        async function generateOfferImage(data) {
            // Funci√≥n para parsear fecha localmente (evita desfase por zona horaria)
            function parseLocalDate(dateStr) {
                const [year, month, day] = dateStr.split('-').map(Number);
                return new Date(year, month - 1, day);
            }
            // Canvas m√°s grande para m√°s detalles visuales
            const canvas = document.createElement('canvas');
            canvas.width = 900;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');

            // Fondo y borde
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);

            // Tarifa restrictiva
            ctx.save();
            ctx.shadowColor = '#a85c1c';
            ctx.shadowBlur = 8;
            ctx.fillStyle = '#a85c1c';
            ctx.font = 'bold 16px Arial';
            ctx.beginPath();
            ctx.roundRect(650, 18, 180, 32, 12);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.restore();
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 15px Arial';
            ctx.fillText('Tarifa restrictiva', 670, 40);
            ctx.fillStyle = '#a85c1c';
            ctx.font = 'bold 22px Arial';
            ctx.fillText('üîí', 800, 40);

            // Agrupar segmentos con escala en PTY
            // Agrupar solo los tramos de regreso si el segundo tramo tiene escala en PTY
            let groupedSegments = [];
            if (data.segments && Array.isArray(data.segments)) {
                let i = 0;
                while (i < data.segments.length) {
                    const seg = data.segments[i];
                    // Si el campo stops contiene "1 escala" y el siguiente segmento existe y es la continuaci√≥n
                    if (
                        seg.stops && seg.stops.toLowerCase().includes('1 escala') &&
                        i < data.segments.length - 1 &&
                        seg.to === 'PTY' && data.segments[i + 1].from === 'PTY'
                    ) {
                        // Agrupar ambos como un solo vuelo, eliminando PTY como origen y destino
                        const nextSeg = data.segments[i + 1];
                        // Fusionar CLO - PTY y PTY - LIM como CLO - LIM
                        let fromCity = seg.from;
                        let toCity = nextSeg.to;
                        // Si el primer segmento termina en PTY y el segundo empieza en PTY, fusionar origen y destino reales
                        if (seg.to === 'PTY' && nextSeg.from === 'PTY') {
                            fromCity = seg.from;
                            toCity = nextSeg.to;
                        }
                        groupedSegments.push({
                            date: nextSeg.date,
                            from: fromCity,
                            departure: seg.departure,
                            to: toCity,
                            arrival: nextSeg.arrival,
                            class: nextSeg.class,
                            direct: false,
                            stops: seg.stops,
                            flightNumber: seg.flightNumber + ' / ' + nextSeg.flightNumber,
                            aircraft: seg.aircraft + ' / ' + nextSeg.aircraft
                        });
                        i += 2;
                    } else {
                        // Mostrar segmento individual
                        groupedSegments.push(seg);
                        i++;
                    }
                }
            }

            // Segmentos de vuelo visuales
            let y = 70;
            if (groupedSegments.length > 0) {
                groupedSegments.forEach((seg, idx) => {
                    // Formatear fecha en formato largo (local)
                    let fecha = parseLocalDate(seg.date);
                    let fechaStr = fecha.toLocaleDateString('es-ES', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                    if (!seg.direct && seg.stops && seg.stops.toLowerCase().includes('1 escala')) {
                        // VUELO AGRUPADO VISUAL ESPECIAL
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 15px Arial';
                        ctx.fillText(fechaStr, 40, y);
                        // Icono avi√≥n y texto escala
                        ctx.font = '16px Arial';
                        ctx.fillStyle = '#888';
                        ctx.fillText('‚úà Escala en PTY', 180, y);
                        ctx.font = 'italic 14px Arial';
                        ctx.fillStyle = '#888';
                        // Duraci√≥n escala si est√° disponible
                        let escalaDur = '';
                        let match = seg.stops.match(/\(([^)]+)\)/);
                        if (match) escalaDur = match[1];
                        if (escalaDur) ctx.fillText(`(${escalaDur})`, 320, y);
                        y += 28;
                        // Ruta y horas
                        ctx.font = 'bold 22px Arial';
                        ctx.fillStyle = '#222';
                        ctx.fillText(seg.from, 40, y);
                        ctx.font = 'bold 20px Arial';
                        ctx.fillText(seg.departure, 120, y);
                        ctx.font = 'bold 28px Arial';
                        ctx.fillStyle = '#bbb';
                        ctx.fillText('‚Üí', 200, y);
                        ctx.font = 'bold 22px Arial';
                        ctx.fillStyle = '#222';
                        ctx.fillText(seg.to, 240, y);
                        ctx.font = 'bold 20px Arial';
                        ctx.fillText(seg.arrival, 320, y);
                        // Clase en azul
                        ctx.font = '15px Arial';
                        ctx.fillStyle = '#1976d2';
                        ctx.fillText(seg.class || 'Econ√≥mica Basic', 40, y + 22);
                        y += 48;
                        // Separador visual
                        ctx.strokeStyle = '#e0e0e0';
                        ctx.beginPath();
                        ctx.moveTo(40, y - 10);
                        ctx.lineTo(500, y - 10);
                        ctx.stroke();
                    } else {
                        // VUELO NORMAL
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 16px Arial';
                        ctx.fillText(fechaStr, 40, y);
                        ctx.font = 'italic 14px Arial';
                        ctx.fillStyle = seg.direct ? '#28a745' : '#ff9800';
                        ctx.fillText(seg.direct ? 'Sin escalas' : seg.stops, 320, y);
                        y += 26;
                        // Ruta y horas
                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = '#222';
                        ctx.fillText(seg.from, 40, y);
                        ctx.font = 'bold 18px Arial';
                        ctx.fillText(seg.departure, 110, y);
                        ctx.font = 'bold 24px Arial';
                        ctx.fillStyle = '#0056b3';
                        ctx.fillText('‚Üí', 180, y);
                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = '#222';
                        ctx.fillText(seg.to, 240, y);
                        ctx.font = 'bold 18px Arial';
                        ctx.fillText(seg.arrival, 310, y);
                        // Clase y n√∫mero de vuelo
                        ctx.font = '14px Arial';
                        ctx.fillStyle = '#0056b3';
                        ctx.fillText(seg.class || 'Econ√≥mica Basic', 40, y + 20);
                        ctx.fillStyle = '#666';
                        if (seg.flightNumber && seg.flightNumber !== 'undefined') {
                            ctx.fillText(`Vuelo: ${seg.flightNumber}`, 240, y + 20);
                        }
                        ctx.font = '13px Arial';
                        ctx.fillStyle = '#888';
                        if (seg.aircraft && seg.aircraft !== 'undefined') {
                            ctx.fillText(seg.aircraft, 420, y + 20);
                        }
                        y += 42;
                        // Separador visual
                        ctx.strokeStyle = '#e0e0e0';
                        ctx.beginPath();
                        ctx.moveTo(40, y - 10);
                        ctx.lineTo(500, y - 10);
                        ctx.stroke();
                    }
                });
            }

            // Precio destacado y bot√≥n estilo Google Flights
            ctx.textAlign = 'left';
            ctx.fillStyle = '#333';
            ctx.font = 'bold 20px Arial';
            ctx.fillText('Precio por adulto', 600, 120);
            ctx.font = 'bold 40px Arial';
            ctx.fillStyle = '#1976d2';
            ctx.fillText(`${data.price} USD`, 600, 170);
            ctx.font = '20px Arial';
            ctx.fillStyle = '#666';
            ctx.fillText('Clase Econ√≥mica', 600, 200);

            // Ver detalles (en azul, subrayado)
            ctx.font = '18px Arial';
            ctx.fillStyle = '#1976d2';
            ctx.fillText('Ver detalles', 600, 235);

            // ...eliminado bot√≥n seleccionar y figura esquina inferior derecha...

            // Convertir a imagen
            return canvas.toDataURL('image/png');
        }
    </script>
</body>
</html>