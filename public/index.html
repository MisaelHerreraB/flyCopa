<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMM - Congreso Centroamericano 2026 - Comparador de Ofertas de Vuelos - Copa Airlines</title>
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            color: #333;
        }
        .header-title {
            color: #0056b3;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background-color: #0056b3;
            border-color: #0056b3;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 12px 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #007bff;
            border-color: #007bff;
            transform: translateY(-2px);
        }
        .btn-primary:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }
        .loading-progress {
            display: none;
            margin: 20px 0;
        }
        .error-alert {
            display: none;
            margin: 20px 0;
        }
        .cheapest-card {
            background-color: #d4edda !important;
            border-left: 5px solid #28a745 !important;
            margin: 15px 0;
        }
        .global-cheapest-card {
            background-color: #ffe5b4 !important;
            border-left: 5px solid #ffca2c !important;
            margin: 20px 0;
            font-size: 1.1em;
            font-weight: bold;
        }
        .offer-image {
            max-width: 100%;
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .right-offer-column {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: flex-start;
            min-width: 500px;
            max-width: 1200px;
            width: 100%;
            padding: 20px 20px 20px 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        .right-offer-column .price {
            font-size: 2.5rem;
            color: #0056b3;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .right-offer-column .class {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 12px;
        }
        .right-offer-column .select-btn {
            width: 100%;
            margin-bottom: 8px;
        }
        .right-offer-column .details-link {
            color: #1976d2;
            font-size: 1rem;
            text-decoration: underline;
            cursor: pointer;
            margin-bottom: 4px;
        }
        @media (max-width: 900px) {
            .right-offer-column {
                min-width: 180px;
                max-width: 100%;
                width: 100%;
                padding: 10px 5px;
            }
            .right-offer-column .price {
                font-size: 1.5rem;
            }
        }
        .pre-formatted {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.4;
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .btn-primary {
                font-size: 1rem;
                padding: 10px 15px;
            }
            .cheapest-card, .global-cheapest-card {
                font-size: 0.9em;
            }
            .offer-image {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-12 text-center">
                    <h1 class="header-title">
                        <i class="bi bi-airplane-engines"></i> MMM - Congreso Centroamericano 2026 - Comparador de Ofertas de Vuelos - Copa Airlines
                    </h1>
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col-12 col-md-6">
                    <button class="btn btn-primary btn-lg w-100" id="fetch-button" style="display:none">
                        <i class="bi bi-airplane-fill"></i> ¬°Buscar Ofertas de Vuelos Ahora!
                    </button>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="loading-progress" id="loading">
                <div class="progress" role="progressbar" aria-label="Progreso de b√∫squeda" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-primary" style="width: 0%;" id="progress-bar"></div>
                </div>
                <p class="mt-2 text-center" id="progress-text">Buscando las mejores ofertas para Medell√≠n, Quito, Cali, Bogot√°, Cartagena (stopover de ida y regreso en Panam√°)... Progreso: 0%</p>
            </div>
            <!-- Error Alert -->
            <div class="alert alert-danger error-alert" role="alert" id="error">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span id="error-message"></span>
            </div>
            <!-- Global Cheapest Offer -->
            <div class="row" id="global-cheapest-section">
                <div class="col-12">
                    <div class="card global-cheapest-card" id="global-cheapest-info" style="display: none;">
                        <div class="card-body">
                            <div class="pre-formatted" id="cheapest-message">
                                üåç‚úàÔ∏è ¬°Atenci√≥n pastores y hermanos!
                                üî• Aprovechen esta s√∫per oferta üî•
                                üëâ Pasajes stopover:
                                [ITINERARIO]
                                [STOPOVER_TYPE]
                                üíµ Todo a [PRECIO] USD üíµ
                                ‚ú® ¬°No dejen pasar esta oportunidad! ‚ú®
                            </div>
                            <button class="btn btn-warning mt-2" onclick="copyCheapestMessage()">
                                <i class="bi bi-clipboard"></i> Copiar mensaje
                            </button>
                        </div>
                    </div>
                    <!-- Contenedor para la imagen generada -->
                    <div class="text-center" id="offer-image-container" style="display: none;">
                        <div class="right-offer-column">
                            <img src="" alt="Oferta Visual" class="offer-image" id="offer-image">
                        </div>
                    </div>
                </div>
            </div>
            <!-- Individual Cheapest Offers -->
            <div class="row" id="individual-offers-section">
                <div class="col-12">
                    <!-- Itinerario 1: Medell√≠n (stopover de ida) -->
                    <div class="card cheapest-card" id="cheapest-info1" style="display: none;"></div>
                    <!-- Itinerario 2: Quito (stopover de ida) -->
                    <div class="card cheapest-card" id="cheapest-info2" style="display: none;"></div>
                    <!-- Itinerario 3: Cali (stopover de ida) -->
                    <div class="card cheapest-card" id="cheapest-info3" style="display: none;"></div>
                    <!-- Itinerario 4: Bogot√° (stopover de ida) -->
                    <div class="card cheapest-card" id="cheapest-info4" style="display: none;"></div>
                    <!-- Itinerario 5: Cartagena (stopover de ida) -->
                    <div class="card cheapest-card" id="cheapest-info5" style="display: none;"></div>
                    <!-- Itinerario 6: Medell√≠n (stopover de regreso) -->
                    <div class="card cheapest-card" id="cheapest-info6" style="display: none;"></div>
                    <!-- Itinerario 7: Quito (stopover de regreso) -->
                    <div class="card cheapest-card" id="cheapest-info7" style="display: none;"></div>
                    <!-- Itinerario 8: Cali (stopover de regreso) -->
                    <div class="card cheapest-card" id="cheapest-info8" style="display: none;"></div>
                    <!-- Itinerario 9: Bogot√° (stopover de regreso) -->
                    <div class="card cheapest-card" id="cheapest-info9" style="display: none;"></div>
                    <!-- Itinerario 10: Cartagena (stopover de regreso) -->
                    <div class="card cheapest-card" id="cheapest-info10" style="display: none;"></div>
                </div>
            </div>
        </div>

    <!-- Bootstrap 5 JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        function copyCheapestMessage() {
            const msg = document.getElementById('cheapest-message');
            if (msg) {
                // Eliminar espacios extra y copiar solo el texto visible
                const text = msg.innerText.replace(/\n\s+/g, '\n').trim();
                navigator.clipboard.writeText(text)
                    .then(() => {
                        alert('Mensaje copiado al portapapeles');
                    })
                    .catch(() => {
                        alert('No se pudo copiar el mensaje');
                    });
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            fetchOffers();
        });
        async function fetchOffers() {
            const fetchButton = document.getElementById('fetch-button');
            const loading = document.getElementById('loading');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const errorDiv = document.getElementById('error');
            const globalCheapestInfo = document.getElementById('global-cheapest-info');
            const offerImageContainer = document.getElementById('offer-image-container');
            const offerImage = document.getElementById('offer-image');
            const cheapestInfo1 = document.getElementById('cheapest-info1');
            const cheapestInfo2 = document.getElementById('cheapest-info2');
            const cheapestInfo3 = document.getElementById('cheapest-info3');
            const cheapestInfo4 = document.getElementById('cheapest-info4');
            const cheapestInfo5 = document.getElementById('cheapest-info5');
            const cheapestInfo6 = document.getElementById('cheapest-info6');
            const cheapestInfo7 = document.getElementById('cheapest-info7');
            const cheapestInfo8 = document.getElementById('cheapest-info8');
            const cheapestInfo9 = document.getElementById('cheapest-info9');
            const cheapestInfo10 = document.getElementById('cheapest-info10');

            // Deshabilitar bot√≥n y cambiar texto solo si existe
            if (fetchButton) {
                fetchButton.disabled = true;
                fetchButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Buscando...';
            }

            // Mostrar barra de progreso
            loading.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = 'Buscando las mejores ofertas para Medell√≠n, Quito, Cali, Bogot√°, Cartagena (stopover de ida y regreso en Panam√°)... Progreso: 0%';
            errorDiv.style.display = 'none';
            globalCheapestInfo.style.display = 'none';
            offerImageContainer.style.display = 'none';
            cheapestInfo1.style.display = 'none';
            cheapestInfo2.style.display = 'none';
            cheapestInfo3.style.display = 'none';
            cheapestInfo4.style.display = 'none';
            cheapestInfo5.style.display = 'none';
            cheapestInfo6.style.display = 'none';
            cheapestInfo7.style.display = 'none';
            cheapestInfo8.style.display = 'none';
            cheapestInfo9.style.display = 'none';
            cheapestInfo10.style.display = 'none';

            try {
                // Simular progreso (10% por cada una de las 10 llamadas)
                let progress = 0;
                const updateProgress = () => {
                    progress += 10;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `Buscando las mejores ofertas para Medell√≠n, Quito, Cali, Bogot√°, Cartagena (stopover de ida y regreso en Panam√°)... Progreso: ${progress}%`;
                };

                const response = await fetch('/api/offers');
                updateProgress(); // 10%
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                const data = await response.json();
                updateProgress(); // 20% (simulando el procesamiento de la respuesta)

                if (data.error) {
                    throw new Error(data.error);
                }

                // Simular progreso para las 8 llamadas restantes
                for (let i = 0; i < 8; i++) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    updateProgress(); // 30% a 100%
                }

                // Mostrar oferta m√°s barata global
                if (data.globalCheapest) {
                    // Construir segmentos de vuelo para la imagen
                    const segments = [];
                    if (data.globalCheapest.segments && Array.isArray(data.globalCheapest.segments)) {
                        data.globalCheapest.segments.forEach(seg => {
                            segments.push({
                                date: seg.date,
                                from: seg.from,
                                departure: seg.departure,
                                to: seg.to,
                                arrival: seg.arrival,
                                class: seg.class,
                                direct: seg.direct,
                                stops: seg.stops || '',
                                stopover: seg.stopover || ''
                            });
                        });
                    }

                    globalCheapestInfo.innerHTML = `
                        <div class="pre-formatted" id="cheapest-message">
üåç‚úàÔ∏è ¬°Atenci√≥n pastores y hermanos!
üî• Aprovechen esta s√∫per oferta üî•

üëâ Pasajes stopover:
‚úÖ Ida ‚úàÔ∏è ${data.globalCheapest.ida }
‚úÖ Vuelta ‚úàÔ∏è ${data.globalCheapest.vuelta }
${data.globalCheapest.stopoverType ? data.globalCheapest.stopoverType : ''}
üíµ Todo a ${data.globalCheapest.price} USD üíµ

‚ú® ¬°No dejen pasar esta oportunidad! ‚ú®
                        </div>
                        <button class="btn btn-warning mt-2" onclick="copyCheapestMessage()">
                            <i class="bi bi-clipboard"></i> Copiar mensaje
                        </button>
                    `;
                    globalCheapestInfo.style.display = 'block';
        function copyCheapestMessage() {
            const msg = document.getElementById('cheapest-message');
            if (msg) {
                // Respetar los saltos de l√≠nea
                let text = msg.innerText;
                // Si el navegador no respeta los saltos, forzar reemplazo de <br> y doble espacio por salto de l√≠nea
                text = text.replace(/\r?\n/g, '\n');
                navigator.clipboard.writeText(text)
                    .then(() => {
                        alert('Mensaje copiado al portapapeles');
                    })
                    .catch(() => {
                        alert('No se pudo copiar el mensaje');
                    });
            }
        }

                    // Generar imagen con segmentos
                    const imageData = {
                        price: data.globalCheapest.price,
                        segments: segments
                    };
                    const generatedImage = await generateOfferImage(imageData);
                    if (generatedImage) {
                        offerImage.src = generatedImage;
                        offerImageContainer.style.display = 'block';
                    }
                }

                // Mostrar ofertas m√°s baratas individuales
                // Itinerario 1 (MDE, stopover de ida)
                if (data.itinerary1.cheapest) {
                    cheapestInfo1.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de ida (Medell√≠n):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Medell√≠n - Panam√° - Lima 
üíµ Todo a ${data.itinerary1.cheapest.price} USD üíµ
                    </div>`;
                    cheapestInfo1.style.display = 'block';
                } else if (data.itinerary1.error) {
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error en itinerario 1 (Medell√≠n, stopover de ida): ${data.itinerary1.error}`;
                    errorDiv.style.display = 'block';
                }

                // Itinerario 2 (UIO, stopover de ida)
                if (data.itinerary2.cheapest) {
                    cheapestInfo2.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de ida (Quito):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Quito - Panam√° - Lima 
üíµ Todo a ${data.itinerary2.cheapest.price} USD üíµ
                    </div>`;
                    cheapestInfo2.style.display = 'block';
                } else if (data.itinerary2.error) {
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error en itinerario 2 (Quito, stopover de ida): ${data.itinerary2.error}`;
                    errorDiv.style.display = 'block';
                }

                // Itinerario 3 (CLO, stopover de ida)
                if (data.itinerary3.cheapest) {
                    cheapestInfo3.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de ida (Cali):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Cali - Panam√° - Lima 
üíµ Todo a ${data.itinerary3.cheapest.price} USD üíµ
                    </div>`;
                    cheapestInfo3.style.display = 'block';
                } else if (data.itinerary3.error) {
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error en itinerario 3 (Cali, stopover de ida): ${data.itinerary3.error}`;
                    errorDiv.style.display = 'block';
                }

                // Itinerario 4 (BOG, stopover de ida)
                if (data.itinerary4.cheapest) {
                    cheapestInfo4.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de ida (Bogot√°):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Bogot√° - Panam√° - Lima 
üíµ Todo a ${data.itinerary4.cheapest.price} USD ÔøΩ5
                    </div>`;
                    cheapestInfo4.style.display = 'block';
                } else if (data.itinerary4.error) {
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error en itinerario 4 (Bogot√°, stopover de ida): ${data.itinerary4.error}`;
                    errorDiv.style.display = 'block';
                }

                // Itinerario 5 (CTG, stopover de ida)
                if (data.itinerary5.cheapest) {
                    cheapestInfo5.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de ida (Cartagena):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Cartagena - Panam√° - Lima 
üíµ Todo a ${data.itinerary5.cheapest.price} USD ÔøΩ5
                    </div>`;
                    cheapestInfo5.style.display = 'block';
                } else if (data.itinerary5.error) {
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error en itinerario 5 (Cartagena, stopover de ida): ${data.itinerary5.error}`;
                    errorDiv.style.display = 'block';
                }

                // Itinerario 6 (MDE, stopover de regreso)
                if (data.itinerary6.cheapest) {
                    cheapestInfo6.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de regreso (Medell√≠n):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√° - Medell√≠n - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Lima 
ÔøΩ5 Todo a ${data.itinerary6.cheapest.price} USD
                    </div>`;
                    cheapestInfo6.style.display = 'block';
                } else if (data.itinerary6.error) {
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error en itinerario 6 (Medell√≠n, stopover de regreso): ${data.itinerary6.error}`;
                    errorDiv.style.display = 'block';
                }

                // Itinerario 7 (UIO, stopover de regreso)
                if (data.itinerary7.cheapest) {
                    cheapestInfo7.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de regreso (Quito):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√° - Quito - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Lima 
ÔøΩ5 Todo a ${data.itinerary7.cheapest.price} USD
                    </div>`;
                    cheapestInfo7.style.display = 'block';
                } else if (data.itinerary7.error) {
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error en itinerario 7 (Quito, stopover de regreso): ${data.itinerary7.error}`;
                    errorDiv.style.display = 'block';
                }

                // Itinerario 8 (CLO, stopover de regreso)
                if (data.itinerary8.cheapest) {
                    cheapestInfo8.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de regreso (Cali):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√° - Cali - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Lima 
ÔøΩ5 Todo a ${data.itinerary8.cheapest.price} USD
                    </div>`;
                    cheapestInfo8.style.display = 'block';
                } else if (data.itinerary8.error) {
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error en itinerario 8 (Cali, stopover de regreso): ${data.itinerary8.error}`;
                    errorDiv.style.display = 'block';
                }

                // Itinerario 9 (BOG, stopover de regreso)
                if (data.itinerary9.cheapest) {
                    cheapestInfo9.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de regreso (Bogot√°):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√° - Bogot√° - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Lima 
ÔøΩ5 Todo a ${data.itinerary9.cheapest.price} USD
                    </div>`;
                    cheapestInfo9.style.display = 'block';
                } else if (data.itinerary9.error) {
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error en itinerario 9 (Bogot√°, stopover de regreso): ${data.itinerary9.error}`;
                    errorDiv.style.display = 'block';
                }

                // Itinerario 10 (CTG, stopover de regreso)
                if (data.itinerary10.cheapest) {
                    cheapestInfo10.innerHTML = `<div class="pre-formatted">
üëâ Pasajes stopover de regreso (Cartagena):
‚úÖ Ida ‚úàÔ∏è Lima - Panam√° - Cartagena - Panam√°
‚úÖ Vuelta ‚úàÔ∏è Panam√° - Lima 
ÔøΩ5 Todo a ${data.itinerary10.cheapest.price} USD
                    </div>`;
                    cheapestInfo10.style.display = 'block';
                } else if (data.itinerary10.error) {
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error en itinerario 10 (Cartagena, stopover de regreso): ${data.itinerary10.error}`;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${error.message}`;
                errorDiv.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                fetchButton.disabled = false;
                fetchButton.innerHTML = '<i class="bi bi-search"></i> Actualizar B√∫squeda';
            }
        }

        // Funci√≥n para generar la imagen basada en el dise√±o proporcionado
        async function generateOfferImage(data) {
            // Canvas m√°s grande para m√°s detalles visuales
            const canvas = document.createElement('canvas');
            canvas.width = 900;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');

            // Fondo y borde
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);

            // Tarifa restrictiva
            ctx.save();
            ctx.shadowColor = '#a85c1c';
            ctx.shadowBlur = 8;
            ctx.fillStyle = '#a85c1c';
            ctx.font = 'bold 16px Arial';
            ctx.beginPath();
            ctx.roundRect(650, 18, 180, 32, 12);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.restore();
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 15px Arial';
            ctx.fillText('Tarifa restrictiva', 670, 40);
            ctx.fillStyle = '#a85c1c';
            ctx.font = 'bold 22px Arial';
            ctx.fillText('üîí', 800, 40);

            // Agrupar segmentos con escala en PTY
            // Agrupar solo los tramos de regreso si el segundo tramo tiene escala en PTY
            let groupedSegments = [];
            if (data.segments && Array.isArray(data.segments)) {
                let i = 0;
                while (i < data.segments.length) {
                    const seg = data.segments[i];
                    // Si el campo stops contiene "Escala en PTY" y el siguiente segmento existe y es la continuaci√≥n
                    if (
                        seg.stops && seg.stops.toLowerCase().includes('escala en pty') &&
                        i < data.segments.length - 1 &&
                        seg.to === 'PTY' && data.segments[i + 1].from === 'PTY'
                    ) {
                        // Agrupar ambos como un solo vuelo
                        const nextSeg = data.segments[i + 1];
                        groupedSegments.push({
                            date: nextSeg.date,
                            from: seg.from,
                            departure: seg.departure,
                            to: nextSeg.to,
                            arrival: nextSeg.arrival,
                            class: nextSeg.class,
                            direct: false,
                            stops: seg.stops,
                            flightNumber: seg.flightNumber + ' / ' + nextSeg.flightNumber,
                            aircraft: seg.aircraft + ' / ' + nextSeg.aircraft
                        });
                        i += 2;
                    } else {
                        // Mostrar segmento individual
                        groupedSegments.push(seg);
                        i++;
                    }
                }
            }

            // Segmentos de vuelo visuales
            let y = 70;
            if (groupedSegments.length > 0) {
                groupedSegments.forEach((seg, idx) => {
                    if (!seg.direct && seg.stops && seg.stops.toLowerCase().includes('1 escala')) {
                        // VUELO AGRUPADO VISUAL ESPECIAL
                        // Fecha en formato largo
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 15px Arial';
                        let fecha = new Date(seg.date);
                        let fechaStr = fecha.toLocaleDateString('es-ES', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                        ctx.fillText(fechaStr, 40, y);
                        // Icono avi√≥n y texto escala
                        ctx.font = '16px Arial';
                        ctx.fillStyle = '#888';
                        ctx.fillText('‚úà Escala en PTY', 180, y);
                        ctx.font = 'italic 14px Arial';
                        ctx.fillStyle = '#888';
                        // Duraci√≥n escala si est√° disponible
                        let escalaDur = '';
                        let match = seg.stops.match(/\(([^)]+)\)/);
                        if (match) escalaDur = match[1];
                        if (escalaDur) ctx.fillText(`(${escalaDur})`, 320, y);
                        y += 28;
                        // Ruta y horas
                        ctx.font = 'bold 22px Arial';
                        ctx.fillStyle = '#222';
                        ctx.fillText(seg.from, 40, y);
                        ctx.font = 'bold 20px Arial';
                        ctx.fillText(seg.departure, 120, y);
                        ctx.font = 'bold 28px Arial';
                        ctx.fillStyle = '#bbb';
                        ctx.fillText('‚Üí', 200, y);
                        ctx.font = 'bold 22px Arial';
                        ctx.fillStyle = '#222';
                        ctx.fillText(seg.to, 240, y);
                        ctx.font = 'bold 20px Arial';
                        ctx.fillText(seg.arrival, 320, y);
                        // Clase en azul
                        ctx.font = '15px Arial';
                        ctx.fillStyle = '#1976d2';
                        ctx.fillText(seg.class || 'Econ√≥mica Basic', 40, y + 22);
                        y += 48;
                        // Separador visual
                        ctx.strokeStyle = '#e0e0e0';
                        ctx.beginPath();
                        ctx.moveTo(40, y - 10);
                        ctx.lineTo(500, y - 10);
                        ctx.stroke();
                    } else {
                        // VUELO NORMAL
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 16px Arial';
                        ctx.fillText(seg.date, 40, y);
                        ctx.font = 'italic 14px Arial';
                        ctx.fillStyle = seg.direct ? '#28a745' : '#ff9800';
                        ctx.fillText(seg.direct ? 'Sin escalas' : seg.stops, 320, y);
                        y += 26;
                        // Ruta y horas
                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = '#222';
                        ctx.fillText(seg.from, 40, y);
                        ctx.font = 'bold 18px Arial';
                        ctx.fillText(seg.departure, 110, y);
                        ctx.font = 'bold 24px Arial';
                        ctx.fillStyle = '#0056b3';
                        ctx.fillText('‚Üí', 180, y);
                        ctx.font = 'bold 20px Arial';
                        ctx.fillStyle = '#222';
                        ctx.fillText(seg.to, 240, y);
                        ctx.font = 'bold 18px Arial';
                        ctx.fillText(seg.arrival, 310, y);
                        // Clase y n√∫mero de vuelo
                        ctx.font = '14px Arial';
                        ctx.fillStyle = '#0056b3';
                        ctx.fillText(seg.class || 'Econ√≥mica Basic', 40, y + 20);
                        ctx.fillStyle = '#666';
                        if (seg.flightNumber && seg.flightNumber !== 'undefined') {
                            ctx.fillText(`Vuelo: ${seg.flightNumber}`, 240, y + 20);
                        }
                        ctx.font = '13px Arial';
                        ctx.fillStyle = '#888';
                        if (seg.aircraft && seg.aircraft !== 'undefined') {
                            ctx.fillText(seg.aircraft, 420, y + 20);
                        }
                        y += 42;
                        // Separador visual
                        ctx.strokeStyle = '#e0e0e0';
                        ctx.beginPath();
                        ctx.moveTo(40, y - 10);
                        ctx.lineTo(500, y - 10);
                        ctx.stroke();
                    }
                });
            }

            // Precio destacado y bot√≥n estilo Google Flights
            ctx.textAlign = 'left';
            ctx.fillStyle = '#333';
            ctx.font = 'bold 20px Arial';
            ctx.fillText('Precio por adulto', 600, 120);
            ctx.font = 'bold 40px Arial';
            ctx.fillStyle = '#1976d2';
            ctx.fillText(`${data.price} USD`, 600, 170);
            ctx.font = '20px Arial';
            ctx.fillStyle = '#666';
            ctx.fillText('Clase Econ√≥mica', 600, 200);

            // Ver detalles (en azul, subrayado)
            ctx.font = '18px Arial';
            ctx.fillStyle = '#1976d2';
            ctx.fillText('Ver detalles', 600, 235);

            // Bot√≥n seleccionar estilo Google Flights
            ctx.save();
            ctx.shadowColor = '#1976d2';
            ctx.shadowBlur = 8;
            ctx.fillStyle = '#1976d2';
            ctx.beginPath();
            ctx.roundRect(600, 260, 160, 48, 8);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.restore();
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = '#fff';
            ctx.textAlign = 'center';
            ctx.fillText('Seleccionar', 600 + 80, 260 + 32);
            ctx.textAlign = 'left';

            // Icono avi√≥n
            ctx.save();
            ctx.translate(870, 440);
            ctx.rotate(-0.2);
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(40, 20);
            ctx.lineTo(0, 40);
            ctx.closePath();
            ctx.fillStyle = '#0056b3';
            ctx.fill();
            ctx.restore();

            // Convertir a imagen
            return canvas.toDataURL('image/png');
        }
    </script>
</body>
</html>